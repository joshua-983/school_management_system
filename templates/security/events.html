{% extends "security/base.html" %}
{% load static %}

{% block title %}Security Events - Security Management{% endblock %}

{% block page_title %}Security Events Monitor{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Security Events</li>
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <button class="btn btn-outline-success" onclick="exportEvents()">
        <i class="fas fa-download me-2"></i>Export
    </button>
    <button class="btn btn-outline-danger" onclick="clearResolvedEvents()">
        <i class="fas fa-trash me-2"></i>Clear Resolved
    </button>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card security-table">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Security Events
                </h5>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-control" id="eventTypeFilter">
                            <option value="">All Event Types</option>
                            <option value="LOGIN_ATTEMPT">Login Attempts</option>
                            <option value="SECURITY_ALERT">Security Alerts</option>
                            <option value="DATA_ACCESS">Data Access</option>
                            <option value="SYSTEM_EVENT">System Events</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="severityFilter">
                            <option value="">All Severities</option>
                            <option value="LOW">Low</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="HIGH">High</option>
                            <option value="CRITICAL">Critical</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="unresolved">Unresolved</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="btn-group w-100">
                            <button class="btn btn-outline-secondary" onclick="refreshEvents()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh
                            </button>
                            <button class="btn btn-outline-primary" onclick="applyFilters()">
                                <i class="fas fa-filter me-2"></i>Filter
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Events Summary -->
                <div class="row mb-3">
                    <div class="col-md-2">
                        <div class="card bg-light">
                            <div class="card-body text-center p-2">
                                <h6 class="mb-0" id="totalEvents">{{ security_events|length }}</h6>
                                <small class="text-muted">Total</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center p-2">
                                <h6 class="mb-0" id="unresolvedEvents">{{ unresolved_count }}</h6>
                                <small>Unresolved</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center p-2">
                                <h6 class="mb-0" id="criticalEvents">{{ critical_count }}</h6>
                                <small>Critical</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center p-2">
                                <h6 class="mb-0" id="todayEvents">{{ today_count }}</h6>
                                <small>Today</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-dark text-white">
                            <div class="card-body text-center p-2">
                                <h6 class="mb-0" id="lastUpdated">Just now</h6>
                                <small>Last Updated</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Events Table -->
                <div class="table-responsive">
                    <table class="table table-striped security-datatable">
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>Type</th>
                                <th>Severity</th>
                                <th>User</th>
                                <th>IP Address</th>
                                <th>Timestamp</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in security_events %}
                            <tr class="{% if not event.is_resolved %}table-warning{% endif %}">
                                <td>
                                    <strong>{{ event.title }}</strong>
                                    {% if event.description %}
                                    <br><small class="text-muted">{{ event.description|truncatewords:10 }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ event.get_event_type_display }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-{% if event.severity == 'CRITICAL' %}danger{% elif event.severity == 'HIGH' %}warning{% elif event.severity == 'MEDIUM' %}info{% else %}secondary{% endif %}">
                                        {{ event.get_severity_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if event.user %}
                                    {{ event.user.username }}
                                    {% else %}
                                    <em>System</em>
                                    {% endif %}
                                </td>
                                <td>{{ event.ip_address|default:"N/A" }}</td>
                                <td>{{ event.created_at|date:"M d, Y H:i" }}</td>
                                <td>
                                    {% if event.is_resolved %}
                                    <span class="badge bg-success">Resolved</span>
                                    {% else %}
                                    <span class="badge bg-warning">Unresolved</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" 
                                                onclick="viewEventDetails({{ event.id }})"
                                                title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if not event.is_resolved %}
                                        <button class="btn btn-outline-success" 
                                                onclick="resolveEvent({{ event.id }})"
                                                title="Mark Resolved">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-outline-info" 
                                                onclick="investigateEvent({{ event.id }})"
                                                title="Investigate">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-check-circle fa-2x mb-2"></i><br>
                                    No security events found.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Security Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventDetailsContent">
                <!-- Content loaded via JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let eventsTable;

    function viewEventDetails(eventId) {
        const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
        const content = document.getElementById('eventDetailsContent');
        
        content.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;

        fetch(`/security/events/${eventId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Event not found');
                }
                return response.json();
            })
            .then(data => {
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Information</h6>
                            <p><strong>Title:</strong> ${data.title}</p>
                            <p><strong>Type:</strong> <span class="badge bg-secondary">${data.event_type}</span></p>
                            <p><strong>Severity:</strong> <span class="badge bg-${getSeverityColor(data.severity)}">${data.severity}</span></p>
                            <p><strong>User:</strong> ${data.user || 'System'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Technical Details</h6>
                            <p><strong>IP Address:</strong> <code>${data.ip_address || 'N/A'}</code></p>
                            <p><strong>Timestamp:</strong> ${data.timestamp}</p>
                            <p><strong>Status:</strong> <span class="badge ${data.is_resolved ? 'bg-success' : 'bg-warning'}">${data.is_resolved ? 'Resolved' : 'Unresolved'}</span></p>
                            ${data.resolved_by ? `<p><strong>Resolved By:</strong> ${data.resolved_by}</p>` : ''}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Description</h6>
                            <div class="alert alert-light">
                                ${data.description || 'No description provided.'}
                            </div>
                        </div>
                    </div>
                    ${data.details ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Additional Details</h6>
                            <pre class="bg-light p-3 rounded"><code>${JSON.stringify(data.details, null, 2)}</code></pre>
                        </div>
                    </div>
                    ` : ''}
                `;
            })
            .catch(error => {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading event details: ${error.message}
                    </div>
                `;
            });

        modal.show();
    }

    function resolveEvent(eventId) {
        if (confirm('Are you sure you want to mark this event as resolved?')) {
            fetch(`/audit/security-events/${eventId}/resolve/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    showToast('Event marked as resolved successfully', 'success');
                    refreshEvents();
                } else {
                    throw new Error('Failed to resolve event');
                }
            })
            .catch(error => {
                showToast('Error resolving event: ' + error.message, 'danger');
            });
        }
    }

    function investigateEvent(eventId) {
        // Open investigation tools or logs
        window.open(`/audit/logs/?event_id=${eventId}`, '_blank');
    }

    function refreshEvents() {
        showToast('Refreshing events...', 'info');
        location.reload();
    }

    function applyFilters() {
        const eventType = document.getElementById('eventTypeFilter').value;
        const severity = document.getElementById('severityFilter').value;
        const status = document.getElementById('statusFilter').value;

        // This would typically make an API call with filters
        showToast('Applying filters...', 'info');
        
        // Reload page with filter parameters
        const params = new URLSearchParams();
        if (eventType) params.append('event_type', eventType);
        if (severity) params.append('severity', severity);
        if (status) params.append('status', status);
        
        window.location.href = '?' + params.toString();
    }

    function exportEvents() {
        showToast('Preparing export...', 'info');
        // This would typically generate and download a CSV/PDF
        setTimeout(() => {
            showToast('Export ready for download', 'success');
        }, 2000);
    }

    function clearResolvedEvents() {
        if (confirm('Are you sure you want to clear all resolved events? This action cannot be undone.')) {
            showToast('Clearing resolved events...', 'warning');
            // This would typically call an API endpoint
            setTimeout(() => {
                showToast('Resolved events cleared successfully', 'success');
                refreshEvents();
            }, 1500);
        }
    }

    function getSeverityColor(severity) {
        const colors = {
            'CRITICAL': 'danger',
            'HIGH': 'warning',
            'MEDIUM': 'info',
            'LOW': 'secondary'
        };
        return colors[severity] || 'secondary';
    }

    function showToast(message, type = 'info') {
        // Use the SecuritySystem utility if available, otherwise fallback
        if (window.SecuritySystem && window.SecuritySystem.showToast) {
            window.SecuritySystem.showToast(message, type);
        } else {
            // Fallback toast implementation
            toastr[type](message);
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        eventsTable = $('.security-datatable').DataTable({
            pageLength: 25,
            order: [[5, 'desc']],
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search events...",
                lengthMenu: "_MENU_ records per page"
            }
        });

        // Add filter functionality to DataTables
        $('#eventTypeFilter, #severityFilter, #statusFilter').on('change', function() {
            eventsTable.draw();
        });

        // Real-time updates
        setInterval(() => {
            fetch('{% url "security_events_api" %}')
                .then(response => response.json())
                .then(data => {
                    if (data.events && data.events.length !== {{ security_events|length }}) {
                        showToast('New security events detected', 'warning');
                        // In a real app, you'd update the table dynamically
                    }
                })
                .catch(error => console.error('Error checking for new events:', error));
        }, 30000);
    });

    // Custom filtering for DataTables
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            const eventType = $('#eventTypeFilter').val();
            const severity = $('#severityFilter').val();
            const status = $('#statusFilter').val();

            const rowEventType = data[1].toLowerCase();
            const rowSeverity = data[2].toLowerCase();
            const rowStatus = data[6].toLowerCase();

            if (eventType && !rowEventType.includes(eventType.toLowerCase())) return false;
            if (severity && !rowSeverity.includes(severity.toLowerCase())) return false;
            if (status === 'unresolved' && !rowStatus.includes('unresolved')) return false;
            if (status === 'resolved' && !rowStatus.includes('resolved')) return false;

            return true;
        }
    );
</script>
{% endblock %}