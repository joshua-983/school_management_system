{% extends "base.html" %}
{% load static %}

{% block title %}Security Dashboard - Audit System{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mt-4"><i class="fas fa-shield-alt me-2"></i>Security Dashboard</h1>
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
            <button class="btn btn-outline-warning" onclick="runSecurityScan()">
                <i class="fas fa-radar-dish me-1"></i>Security Scan
            </button>
            <button class="btn btn-outline-success" onclick="generateSecurityReport()">
                <i class="fas fa-file-pdf me-1"></i>Generate Report
            </button>
            <button class="btn btn-outline-info" onclick="exportDashboardData()">
                <i class="fas fa-download me-1"></i>Export Data
            </button>
        </div>
    </div>

    <!-- Security Overview Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="fs-4 fw-bold" id="totalEvents">{{ total_events }}</div>
                            <div>Total Security Events</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" href="{% url 'security_events' %}">View Details</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-danger text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="fs-4 fw-bold" id="criticalEvents">{{ critical_events }}</div>
                            <div>Critical Events</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-skull-crossbones fa-2x"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" href="{% url 'security_events' %}?severity=CRITICAL">View Details</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="fs-4 fw-bold" id="activeRules">{{ active_rules }}</div>
                            <div>Active Alert Rules</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-list-check fa-2x"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" href="{% url 'alert_rule_list' %}">Manage Rules</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-warning text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="fs-4 fw-bold" id="threatLevel">Medium</div>
                            <div>Current Threat Level</div>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-shield-virus fa-2x"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <span class="small text-white">Last updated: <span id="lastUpdate">Just now</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Security Stats -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="security-quick-stats">
                <div class="security-stat-card critical">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Failed Logins</h6>
                            <h3 class="mb-0" id="failedLoginsCount">0</h3>
                        </div>
                        <i class="fas fa-user-lock fa-2x text-danger"></i>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-danger" id="failedLoginsProgress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="security-stat-card high">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Suspicious IPs</h6>
                            <h3 class="mb-0" id="suspiciousIPsCount">0</h3>
                        </div>
                        <i class="fas fa-network-wired fa-2x text-warning"></i>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-warning" id="suspiciousIPsProgress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="security-stat-card medium">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Data Exports</h6>
                            <h3 class="mb-0" id="dataExportsCount">0</h3>
                        </div>
                        <i class="fas fa-database fa-2x text-info"></i>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-info" id="dataExportsProgress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="security-stat-card low">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">System Health</h6>
                            <h3 class="mb-0" id="systemHealthScore">95%</h3>
                        </div>
                        <i class="fas fa-heartbeat fa-2x text-success"></i>
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-success" id="systemHealthProgress" style="width: 95%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Analytics Row -->
    <div class="row mb-4">
        <!-- Severity Distribution Chart -->
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Security Events by Severity</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active" data-period="24h">24H</button>
                        <button class="btn btn-outline-secondary" data-period="7d">7D</button>
                        <button class="btn btn-outline-secondary" data-period="30d">30D</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="severityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Activity Monitor -->
        <div class="col-xl-6">
            <div class="card border-info h-100">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-broadcast-tower me-2"></i>Real-time Activity Monitor</h5>
                    <span class="badge bg-light text-dark" id="activityCount">0 events</span>
                </div>
                <div class="card-body p-0">
                    <div class="real-time-monitor">
                        <div class="activity-list" id="activityList" style="max-height: 300px; overflow-y: auto;">
                            <!-- Activities will be populated by JavaScript -->
                            <div class="text-center py-4">
                                <div class="spinner-border text-info" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Monitoring system activity...</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Auto-refresh every 30 seconds</small>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                <label class="form-check-label" for="autoRefresh">Live Monitoring</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Security Events & Threat Indicators -->
    <div class="row mb-4">
        <!-- Recent Security Events -->
        <div class="col-xl-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list-ol me-2"></i>Recent Security Events</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary active" onclick="filterEvents('all')">All</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="filterEvents('CRITICAL')">Critical</button>
                        <button class="btn btn-sm btn-outline-warning" onclick="filterEvents('HIGH')">High</button>
                        <button class="btn btn-sm btn-outline-info" onclick="filterEvents('MEDIUM')">Medium</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0" id="eventsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Time</th>
                                    <th>Severity</th>
                                    <th>Rule</th>
                                    <th>User</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in recent_events %}
                                <tr class="event-row" data-severity="{{ event.severity }}">
                                    <td>
                                        <small class="text-muted" title="{{ event.created_at }}">
                                            {{ event.created_at|timesince }} ago
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge severity-badge severity-{{ event.severity|lower }}">
                                            {{ event.severity }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong>{{ event.rule.name }}</strong>
                                    </td>
                                    <td>
                                        {% if event.user %}
                                        <span class="badge bg-dark">{{ event.user.username }}</span>
                                        {% else %}
                                        <span class="text-muted">System</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ event.description|truncatewords:8 }}</small>
                                    </td>
                                    <td>
                                        {% if event.is_resolved %}
                                        <span class="badge bg-success">Resolved</span>
                                        {% else %}
                                        <span class="badge bg-warning">Active</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-info btn-sm" 
                                                    onclick="viewEventDetails({{ event.id }})"
                                                    title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if not event.is_resolved %}
                                            <button class="btn btn-outline-success btn-sm" 
                                                    onclick="resolveEvent({{ event.id }})"
                                                    title="Mark as Resolved">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-outline-secondary btn-sm" 
                                                    onclick="investigateEvent({{ event.id }})"
                                                    title="Investigate">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                                        <p class="text-muted">No security events detected</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Showing {{ recent_events|length }} events</small>
                        <a href="{% url 'security_events' %}" class="btn btn-sm btn-outline-primary">View All Events</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Threat Indicators & System Status -->
        <div class="col-xl-4">
            <div class="card border-warning h-100">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-radar-dish me-2"></i>Threat Intelligence</h5>
                    <span class="badge bg-dark" id="threatScore">Score: 65</span>
                </div>
                <div class="card-body">
                    <!-- Threat Indicators -->
                    <div class="threat-indicators mb-4">
                        <h6 class="mb-3">Threat Indicators</h6>
                        
                        <div class="indicator-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Failed Login Attempts</span>
                                <span class="badge bg-danger" id="failedLogins">0</span>
                            </div>
                            <div class="progress mb-3" style="height: 6px;">
                                <div class="progress-bar bg-danger" id="failedLoginsBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="indicator-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Suspicious IP Activity</span>
                                <span class="badge bg-warning" id="suspiciousIPs">0</span>
                            </div>
                            <div class="progress mb-3" style="height: 6px;">
                                <div class="progress-bar bg-warning" id="suspiciousIPsBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="indicator-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Data Export Activity</span>
                                <span class="badge bg-info" id="dataExports">0</span>
                            </div>
                            <div class="progress mb-3" style="height: 6px;">
                                <div class="progress-bar bg-info" id="dataExportsBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="indicator-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Privilege Changes</span>
                                <span class="badge bg-purple" id="privilegeChanges">0</span>
                            </div>
                            <div class="progress mb-3" style="height: 6px;">
                                <div class="progress-bar bg-purple" id="privilegeChangesBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- System Health -->
                    <div class="system-health">
                        <h6 class="mb-3">System Health</h6>
                        <div class="health-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Audit Log Integrity</span>
                                <span class="badge bg-success">95%</span>
                            </div>
                            <div class="progress mb-3" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 95%"></div>
                            </div>
                        </div>
                        <div class="health-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Backup Status</span>
                                <span class="badge bg-warning">78%</span>
                            </div>
                            <div class="progress mb-3" style="height: 6px;">
                                <div class="progress-bar bg-warning" style="width: 78%"></div>
                            </div>
                        </div>
                        <div class="health-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Encryption Status</span>
                                <span class="badge bg-success">100%</span>
                            </div>
                            <div class="progress mb-3" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="health-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Firewall Status</span>
                                <span class="badge bg-success">Active</span>
                            </div>
                            <div class="progress mb-3" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Analytics & Compliance -->
    <div class="row mb-4">
        <!-- Compliance Status -->
        <div class="col-lg-6">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Compliance Status</h5>
                </div>
                <div class="card-body">
                    <div class="compliance-status">
                        <div class="compliance-item d-flex justify-content-between align-items-center py-2 border-bottom">
                            <span>Data Protection</span>
                            <span class="badge bg-success">Compliant</span>
                        </div>
                        <div class="compliance-item d-flex justify-content-between align-items-center py-2 border-bottom">
                            <span>Access Control</span>
                            <span class="badge bg-warning">Needs Review</span>
                        </div>
                        <div class="compliance-item d-flex justify-content-between align-items-center py-2 border-bottom">
                            <span>Audit Trail</span>
                            <span class="badge bg-success">Compliant</span>
                        </div>
                        <div class="compliance-item d-flex justify-content-between align-items-center py-2 border-bottom">
                            <span>Incident Response</span>
                            <span class="badge bg-danger">Non-Compliant</span>
                        </div>
                        <div class="compliance-item d-flex justify-content-between align-items-center py-2">
                            <span>Backup & Recovery</span>
                            <span class="badge bg-success">Compliant</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-outline-success btn-sm" onclick="runComplianceCheck()">
                            <i class="fas fa-sync-alt me-1"></i>Run Compliance Check
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Recommendations -->
        <div class="col-lg-6">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Security Recommendations</h5>
                </div>
                <div class="card-body">
                    <div class="recommendations-list">
                        <div class="recommendation-item d-flex align-items-start mb-3">
                            <i class="fas fa-exclamation-triangle text-warning mt-1 me-2"></i>
                            <div>
                                <strong>Review critical security events</strong>
                                <p class="mb-0 text-muted small">3 critical events require immediate attention</p>
                            </div>
                        </div>
                        <div class="recommendation-item d-flex align-items-start mb-3">
                            <i class="fas fa-shield-alt text-primary mt-1 me-2"></i>
                            <div>
                                <strong>Update alert rules</strong>
                                <p class="mb-0 text-muted small">New threat patterns detected in system logs</p>
                            </div>
                        </div>
                        <div class="recommendation-item d-flex align-items-start mb-3">
                            <i class="fas fa-backup text-warning mt-1 me-2"></i>
                            <div>
                                <strong>Schedule backup maintenance</strong>
                                <p class="mb-0 text-muted small">Backup system showing 78% completion rate</p>
                            </div>
                        </div>
                        <div class="recommendation-item d-flex align-items-start">
                            <i class="fas fa-user-shield text-success mt-1 me-2"></i>
                            <div>
                                <strong>Run security audit</strong>
                                <p class="mb-0 text-muted small">Last comprehensive audit was 30 days ago</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-outline-info btn-sm" onclick="viewAllRecommendations()">
                            <i class="fas fa-list me-1"></i>View All Recommendations
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions & System Status -->
    <div class="row">
        <!-- Quick Actions -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <button class="btn btn-outline-primary w-100 h-100 py-3 quick-action-btn" onclick="runComplianceCheck()">
                                <i class="fas fa-clipboard-check fa-2x mb-2"></i><br>
                                Compliance Check
                            </button>
                        </div>
                        <div class="col-sm-6">
                            <button class="btn btn-outline-warning w-100 h-100 py-3 quick-action-btn" onclick="runVulnerabilityScan()">
                                <i class="fas fa-bug fa-2x mb-2"></i><br>
                                Vulnerability Scan
                            </button>
                        </div>
                        <div class="col-sm-6">
                            <button class="btn btn-outline-info w-100 h-100 py-3 quick-action-btn" onclick="viewAnalytics()">
                                <i class="fas fa-chart-line fa-2x mb-2"></i><br>
                                View Analytics
                            </button>
                        </div>
                        <div class="col-sm-6">
                            <button class="btn btn-outline-success w-100 h-100 py-3 quick-action-btn" onclick="manageAlertRules()">
                                <i class="fas fa-cogs fa-2x mb-2"></i><br>
                                Manage Rules
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="col-md-6">
            <div class="card border-dark h-100">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-server me-2"></i>System Status</h5>
                    <span class="badge bg-success">All Systems Operational</span>
                </div>
                <div class="card-body">
                    <div class="system-status">
                        <div class="status-item d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-database text-success me-2"></i>
                                <span>Audit Database</span>
                            </div>
                            <span class="badge bg-success">Online</span>
                        </div>
                        <div class="status-item d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-shield-alt text-success me-2"></i>
                                <span>Security Monitor</span>
                            </div>
                            <span class="badge bg-success">Active</span>
                        </div>
                        <div class="status-item d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-bell text-warning me-2"></i>
                                <span>Alert System</span>
                            </div>
                            <span class="badge bg-warning">Partial</span>
                        </div>
                        <div class="status-item d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-backup text-danger me-2"></i>
                                <span>Backup Service</span>
                            </div>
                            <span class="badge bg-danger">Offline</span>
                        </div>
                        <div class="status-item d-flex justify-content-between align-items-center py-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-network-wired text-success me-2"></i>
                                <span>Network Security</span>
                            </div>
                            <span class="badge bg-success">Secure</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6><i class="fas fa-clock me-2"></i>Last System Check</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small text-muted">Performed 5 minutes ago</span>
                            <button class="btn btn-sm btn-outline-dark" onclick="runSystemCheck()">
                                <i class="fas fa-sync-alt me-1"></i>Check Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Security Scan Modal -->
<div class="modal fade" id="securityScanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-radar-dish me-2"></i>Security Scan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="scanProgress" style="width: 0%"></div>
                </div>
                <div id="scanStatus" class="text-center">
                    <p class="mb-2">Initializing security scan...</p>
                    <small class="text-muted" id="scanDetails">Preparing system for comprehensive security analysis</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.security-quick-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.security-stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border-left: 4px solid;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.security-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.15);
}

.security-stat-card.critical {
    border-left-color: #dc3545;
    background: linear-gradient(135deg, #fff, #f8d7da);
}

.security-stat-card.high {
    border-left-color: #fd7e14;
    background: linear-gradient(135deg, #fff, #fff3cd);
}

.security-stat-card.medium {
    border-left-color: #ffc107;
    background: linear-gradient(135deg, #fff, #fff3cd);
}

.security-stat-card.low {
    border-left-color: #20c997;
    background: linear-gradient(135deg, #fff, #d1ecf1);
}

.real-time-monitor {
    max-height: 400px;
    overflow-y: auto;
    background: #f8f9fa;
}

.activity-item {
    padding: 0.75rem;
    border-left: 4px solid #007bff;
    margin-bottom: 0.5rem;
    background: white;
    border-radius: 0 8px 8px 0;
    transition: all 0.2s ease;
}

.activity-item:hover {
    background: #f8f9fa;
    transform: translateX(2px);
}

.activity-item.critical { 
    border-left-color: #dc3545; 
    background: linear-gradient(135deg, #fff, #f8d7da);
}
.activity-item.high { 
    border-left-color: #fd7e14; 
    background: linear-gradient(135deg, #fff, #fff3cd);
}
.activity-item.medium { 
    border-left-color: #ffc107; 
    background: linear-gradient(135deg, #fff, #fff3cd);
}
.activity-item.low { 
    border-left-color: #20c997; 
    background: linear-gradient(135deg, #fff, #d1ecf1);
}

.quick-action-btn {
    transition: all 0.3s ease;
    border: 2px solid;
    font-weight: 500;
}

.quick-action-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.compliance-status .compliance-item,
.system-status .status-item {
    transition: background-color 0.2s ease;
}

.compliance-status .compliance-item:hover,
.system-status .status-item:hover {
    background-color: #f8f9fa;
}

/* Custom scrollbar for activity monitor */
.real-time-monitor::-webkit-scrollbar {
    width: 8px;
}

.real-time-monitor::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.real-time-monitor::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.real-time-monitor::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Threat score animation */
@keyframes pulseScore {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.threat-score-update {
    animation: pulseScore 0.5s ease;
}

/* Loading animations */
.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position: 1rem 0; }
    100% { background-position: 0 0; }
}

/* Card hover effects */
.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .security-quick-stats {
        grid-template-columns: 1fr;
    }
    
    .btn-group .btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Security Dashboard Manager
class SecurityDashboardManager {
    constructor() {
        this.isSecurityPage = true;
        this.activityCount = 0;
        this.threatScore = 65;
        this.init();
    }

    init() {
        this.initializeSecurityDashboard();
        this.startSecurityMonitoring();
        this.setupEventListeners();
    }

    initializeSecurityDashboard() {
        console.log('Initializing Enhanced Security Dashboard...');
        
        // Load initial data
        this.loadSecurityStats();
        this.loadThreatIndicators();
        this.initializeCharts();
        
        // Start real-time updates
        this.startRealTimeUpdates();
        
        // Update timestamps
        this.updateLastUpdateTime();
    }

    async loadSecurityStats() {
        try {
            // Simulate API call - replace with actual endpoint
            const stats = {
                total_events: {{ total_events }},
                critical_events: {{ critical_events }},
                active_rules: {{ active_rules }},
                threat_level: 'MEDIUM'
            };
            
            this.updateSecurityStats(stats);
        } catch (error) {
            console.error('Error loading security stats:', error);
        }
    }

    updateSecurityStats(stats) {
        // Update main cards
        document.getElementById('totalEvents').textContent = stats.total_events;
        document.getElementById('criticalEvents').textContent = stats.critical_events;
        document.getElementById('activeRules').textContent = stats.active_rules;
        document.getElementById('threatLevel').textContent = stats.threat_level;
        
        // Update threat level badge
        const threatLevelElement = document.getElementById('threatLevel');
        threatLevelElement.className = `badge threat-level-${stats.threat_level.toLowerCase()}`;
    }

    loadThreatIndicators() {
        // Simulate threat indicator data
        const indicators = {
            failed_logins: 12,
            suspicious_ips: 3,
            data_exports: 8,
            privilege_changes: 2,
            system_health: 95
        };

        // Update quick stats
        document.getElementById('failedLoginsCount').textContent = indicators.failed_logins;
        document.getElementById('suspiciousIPsCount').textContent = indicators.suspicious_ips;
        document.getElementById('dataExportsCount').textContent = indicators.data_exports;
        document.getElementById('systemHealthScore').textContent = indicators.system_health + '%';

        // Update progress bars
        document.getElementById('failedLoginsProgress').style.width = '60%';
        document.getElementById('suspiciousIPsProgress').style.width = '30%';
        document.getElementById('dataExportsProgress').style.width = '40%';
        document.getElementById('systemHealthProgress').style.width = indicators.system_health + '%';

        // Update detailed indicators
        document.getElementById('failedLogins').textContent = indicators.failed_logins;
        document.getElementById('suspiciousIPs').textContent = indicators.suspicious_ips;
        document.getElementById('dataExports').textContent = indicators.data_exports;
        document.getElementById('privilegeChanges').textContent = indicators.privilege_changes;

        document.getElementById('failedLoginsBar').style.width = '60%';
        document.getElementById('suspiciousIPsBar').style.width = '30%';
        document.getElementById('dataExportsBar').style.width = '40%';
        document.getElementById('privilegeChangesBar').style.width = '20%';
    }

    initializeCharts() {
        this.initializeSeverityChart();
        this.initializeThreatChart();
    }

    initializeSeverityChart() {
        const ctx = document.getElementById('severityChart').getContext('2d');
        const severityData = {{ severity_distribution|safe }};
        
        // Process severity data for chart
        const labels = [];
        const data = [];
        const backgroundColors = [
            '#20c997', // Low - green
            '#ffc107', // Medium - yellow
            '#fd7e14', // High - orange
            '#dc3545'  // Critical - red
        ];
        
        // Create a map of severity counts
        const severityMap = {};
        severityData.forEach(item => {
            severityMap[item.severity] = item.count;
        });
        
        // Ensure all severities are represented
        const allSeverities = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
        allSeverities.forEach(severity => {
            labels.push(severity);
            data.push(severityMap[severity] || 0);
        });
        
        this.severityChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderWidth: 2,
                    borderColor: '#fff',
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '60%',
                animation: {
                    animateScale: true,
                    animateRotate: true
                }
            }
        });
    }

    initializeThreatChart() {
        // Initialize additional charts if needed
    }

    startRealTimeUpdates() {
        // Simulate real-time activity updates
        this.updateActivityMonitor();
        
        // Update activity monitor every 30 seconds
        setInterval(() => {
            if (document.getElementById('autoRefresh').checked) {
                this.updateActivityMonitor();
            }
        }, 30000);

        // Update threat score periodically
        setInterval(() => {
            this.updateThreatScore();
        }, 45000);
    }

    updateActivityMonitor() {
        const activityList = document.getElementById('activityList');
        if (!activityList) return;
        
        // Clear loading state
        if (activityList.querySelector('.spinner-border')) {
            activityList.innerHTML = '';
        }
        
        // Simulate new activities
        const activities = [
            { type: 'login', user: 'admin', severity: 'low', message: 'Successful login from trusted IP' },
            { type: 'alert', user: 'system', severity: 'high', message: 'Multiple failed login attempts detected' },
            { type: 'export', user: 'user123', severity: 'medium', message: 'Large data export initiated' },
            { type: 'config', user: 'admin', severity: 'low', message: 'Security settings updated' },
            { type: 'alert', user: 'system', severity: 'critical', message: 'Suspicious database query detected' }
        ];
        
        const randomActivity = activities[Math.floor(Math.random() * activities.length)];
        
        const activityItem = document.createElement('div');
        activityItem.className = `activity-item ${randomActivity.severity}`;
        activityItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${randomActivity.user}</strong>
                    <small class="d-block text-muted">${randomActivity.message}</small>
                </div>
                <small class="text-muted">${new Date().toLocaleTimeString()}</small>
            </div>
        `;
        
        // Add new activity at the top
        activityList.insertBefore(activityItem, activityList.firstChild);
        
        // Update activity count
        this.activityCount++;
        document.getElementById('activityCount').textContent = `${this.activityCount} events`;
        
        // Limit to 10 activities
        if (activityList.children.length > 10) {
            activityList.removeChild(activityList.lastChild);
        }
    }

    updateThreatScore() {
        // Simulate threat score fluctuation
        const change = Math.floor(Math.random() * 10) - 5; // -5 to +5
        this.threatScore = Math.max(0, Math.min(100, this.threatScore + change));
        
        const threatScoreElement = document.getElementById('threatScore');
        threatScoreElement.textContent = `Score: ${this.threatScore}`;
        threatScoreElement.classList.add('threat-score-update');
        
        setTimeout(() => {
            threatScoreElement.classList.remove('threat-score-update');
        }, 500);
    }

    startSecurityMonitoring() {
        console.log('Starting enhanced security monitoring...');
        this.monitorUserActivity();
        this.monitorNetworkRequests();
    }

    monitorUserActivity() {
        // Enhanced user activity monitoring
        let lastActivity = Date.now();
        
        const activityEvents = ['click', 'keypress', 'mousemove', 'scroll'];
        activityEvents.forEach(event => {
            document.addEventListener(event, () => {
                lastActivity = Date.now();
            });
        });
    }

    monitorNetworkRequests() {
        // Enhanced network monitoring
        const originalFetch = window.fetch;
        
        window.fetch = function(...args) {
            const startTime = Date.now();
            const url = args[0];
            
            return originalFetch.apply(this, args).then(response => {
                const duration = Date.now() - startTime;
                
                // Log suspicious requests
                if (duration > 10000) {
                    console.warn(`Long network request to ${url}: ${duration}ms`);
                }
                
                return response;
            }).catch(error => {
                console.error(`Network request failed to ${url}:`, error);
                throw error;
            });
        };
    }

    setupEventListeners() {
        // Period filter buttons
        document.querySelectorAll('[data-period]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.loadChartData(e.target.dataset.period);
            });
        });

        // Auto-refresh toggle
        document.getElementById('autoRefresh').addEventListener('change', (e) => {
            if (e.target.checked) {
                this.showAlert('Live monitoring enabled', 'success');
            } else {
                this.showAlert('Live monitoring disabled', 'warning');
            }
        });
    }

    loadChartData(period) {
        // Simulate loading different time period data
        console.log(`Loading chart data for period: ${period}`);
        // In production, this would fetch new data from the server
    }

    updateLastUpdateTime() {
        const now = new Date();
        document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        
        // Update every minute
        setInterval(() => {
            const currentTime = new Date();
            document.getElementById('lastUpdate').textContent = currentTime.toLocaleTimeString();
        }, 60000);
    }

    showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to page
        document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
}

// Global functions for button actions
function refreshDashboard() {
    window.securityDashboard.showAlert('Refreshing dashboard data...', 'info');
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function runSecurityScan() {
    const modal = new bootstrap.Modal(document.getElementById('securityScanModal'));
    modal.show();
    
    let progress = 0;
    const scanInterval = setInterval(() => {
        progress += 5;
        document.getElementById('scanProgress').style.width = `${progress}%`;
        
        const statusMessages = [
            'Scanning user accounts...',
            'Checking system logs...',
            'Analyzing network traffic...',
            'Reviewing access controls...',
            'Verifying encryption status...',
            'Finalizing security assessment...'
        ];
        
        const currentStep = Math.floor(progress / 20);
        if (currentStep < statusMessages.length) {
            document.getElementById('scanDetails').textContent = statusMessages[currentStep];
        }
        
        if (progress >= 100) {
            clearInterval(scanInterval);
            document.getElementById('scanStatus').innerHTML = `
                <div class="text-success">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <p class="mb-2 fw-bold">Security Scan Complete</p>
                    <small class="text-muted">No critical threats detected</small>
                </div>
            `;
            setTimeout(() => {
                modal.hide();
                window.securityDashboard.showAlert('Security scan completed successfully', 'success');
            }, 2000);
        }
    }, 500);
}

function generateSecurityReport() {
    window.securityDashboard.showAlert('Generating security report...', 'info');
    
    setTimeout(() => {
        // Simulate report download
        const link = document.createElement('a');
        link.href = '#';
        link.download = `security_report_${new Date().toISOString().split('T')[0]}.pdf`;
        link.click();
        
        window.securityDashboard.showAlert('Security report generated successfully!', 'success');
    }, 2000);
}

function exportDashboardData() {
    const data = {
        timestamp: new Date().toISOString(),
        total_events: document.getElementById('totalEvents').textContent,
        critical_events: document.getElementById('criticalEvents').textContent,
        active_rules: document.getElementById('activeRules').textContent,
        threat_level: document.getElementById('threatLevel').textContent,
        threat_score: window.securityDashboard.threatScore
    };
    
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
    const downloadAnchor = document.createElement('a');
    downloadAnchor.setAttribute("href", dataStr);
    downloadAnchor.setAttribute("download", "security_dashboard_export.json");
    document.body.appendChild(downloadAnchor);
    downloadAnchor.click();
    downloadAnchor.remove();
    
    window.securityDashboard.showAlert('Dashboard data exported successfully!', 'success');
}

function filterEvents(severity) {
    const rows = document.querySelectorAll('.event-row');
    const buttons = document.querySelectorAll('.btn-group .btn');
    
    // Update button states
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    rows.forEach(row => {
        if (severity === 'all' || row.getAttribute('data-severity') === severity) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    window.securityDashboard.showAlert(`Filtered events by severity: ${severity}`, 'info');
}

function viewEventDetails(eventId) {
    window.location.href = `/audit/security-events/${eventId}/`;
}

function resolveEvent(eventId) {
    if (confirm('Are you sure you want to mark this event as resolved?')) {
        // Simulate API call
        setTimeout(() => {
            window.securityDashboard.showAlert('Event marked as resolved successfully!', 'success');
            // In production, this would update the UI without reload
            setTimeout(() => window.location.reload(), 1000);
        }, 500);
    }
}

function investigateEvent(eventId) {
    window.securityDashboard.showAlert(`Starting investigation for event ${eventId}...`, 'info');
    // Implementation for investigation workflow
}

function runComplianceCheck() {
    window.securityDashboard.showAlert('Running compliance check...', 'info');
    setTimeout(() => {
        window.securityDashboard.showAlert('Compliance check completed', 'success');
    }, 3000);
}

function runVulnerabilityScan() {
    window.securityDashboard.showAlert('Starting vulnerability assessment...', 'warning');
    // Implementation for vulnerability scanning
}

function viewAnalytics() {
    window.location.href = "{% url 'advanced_analytics' %}";
}

function manageAlertRules() {
    window.location.href = "{% url 'alert_rule_list' %}";
}

function viewAllRecommendations() {
    window.securityDashboard.showAlert('Opening recommendations panel...', 'info');
    // Implementation for recommendations view
}

function runSystemCheck() {
    window.securityDashboard.showAlert('Running system health check...', 'info');
    setTimeout(() => {
        window.securityDashboard.showAlert('System check completed successfully', 'success');
    }, 2000);
}

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    window.securityDashboard = new SecurityDashboardManager();
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.ctrlKey || event.metaKey) {
            switch(event.key) {
                case 'r':
                    event.preventDefault();
                    refreshDashboard();
                    break;
                case 's':
                    event.preventDefault();
                    runSecurityScan();
                    break;
                case 'e':
                    event.preventDefault();
                    exportDashboardData();
                    break;
                case 'f':
                    event.preventDefault();
                    document.querySelector('#eventsTable_filter input')?.focus();
                    break;
            }
        }
    });
});

// Export functions for global access
window.refreshDashboard = refreshDashboard;
window.runSecurityScan = runSecurityScan;
window.generateSecurityReport = generateSecurityReport;
window.exportDashboardData = exportDashboardData;
window.filterEvents = filterEvents;
window.viewEventDetails = viewEventDetails;
window.resolveEvent = resolveEvent;
window.investigateEvent = investigateEvent;
window.runComplianceCheck = runComplianceCheck;
window.runVulnerabilityScan = runVulnerabilityScan;
window.viewAnalytics = viewAnalytics;
window.manageAlertRules = manageAlertRules;
window.viewAllRecommendations = viewAllRecommendations;
window.runSystemCheck = runSystemCheck;
</script>
{% endblock %}