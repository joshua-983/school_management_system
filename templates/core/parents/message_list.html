{% extends 'base.html' %}
{% load static %}

{% block title %}Messages - Parent Portal{% endblock %}

{% block extra_css %}
<style>
.messages-inbox {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
}

.inbox-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.inbox-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px 15px 0 0 !important;
    color: white;
}

.message-item {
    border: none;
    border-bottom: 1px solid #e9ecef;
    border-radius: 0;
    transition: all 0.3s ease;
    padding: 1.25rem;
}

.message-item:last-child {
    border-bottom: none;
}

.message-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.message-item.unread {
    background-color: #e7f1ff;
    border-left: 4px solid #667eea;
}

.message-preview {
    color: #6c757d;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.message-meta {
    font-size: 0.875rem;
}

.avatar-sm {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
}

.badge-priority {
    font-size: 0.7rem;
    padding: 3px 6px;
}

.filter-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
}

.empty-state {
    padding: 3rem 1rem;
    text-align: center;
}

.empty-state-icon {
    font-size: 4rem;
    color: #6c757d;
    margin-bottom: 1rem;
}

.pagination .page-link {
    border-radius: 8px;
    margin: 0 2px;
    border: none;
    color: #667eea;
}

.pagination .page-item.active .page-link {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.btn-refresh {
    border-radius: 10px;
    transition: all 0.3s ease;
}

.btn-refresh:hover {
    transform: rotate(180deg);
}
</style>
{% endblock %}

{% block content %}
<div class="messages-inbox py-4">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card inbox-card">
                    <div class="card-header inbox-header py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">
                                    <i class="bi bi-inbox me-2"></i>Message Inbox
                                    {% if unread_count > 0 %}
                                    <span class="badge bg-warning ms-2">{{ unread_count }} unread</span>
                                    {% endif %}
                                </h5>
                                <small class="opacity-75">Manage your communications with teachers</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-light btn-refresh" id="refreshBtn" title="Refresh">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <a href="{% url 'parent_message_create' %}" class="btn btn-primary">
                                    <i class="bi bi-plus-circle me-2"></i>New Message
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card-body border-bottom">
                        <div class="filter-section">
                            <div class="row g-3 align-items-center">
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">Filter by Status</label>
                                    <select class="form-select" id="statusFilter">
                                        <option value="all">All Messages</option>
                                        <option value="unread">Unread Only</option>
                                        <option value="read">Read Only</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-semibold">Sort by</label>
                                    <select class="form-select" id="sortFilter">
                                        <option value="newest">Newest First</option>
                                        <option value="oldest">Oldest First</option>
                                        <option value="sender">Sender A-Z</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Search</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="searchFilter" placeholder="Search messages...">
                                        <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">&nbsp;</label>
                                    <button class="btn btn-outline-secondary w-100" id="applyFilters">
                                        <i class="bi bi-funnel me-1"></i>Apply
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body p-0">
                        {% if messages %}
                        <div class="list-group list-group-flush" id="messagesList">
                            {% for message in messages %}
                            <a href="{% url 'parent_message_detail' message.pk %}" 
                               class="list-group-item message-item {% if not message.is_read %}unread{% endif %}"
                               data-sender="{{ message.sender.get_full_name|lower }}"
                               data-subject="{{ message.subject|lower }}"
                               data-content="{{ message.message|lower }}"
                               data-read="{{ message.is_read|yesno:'true,false' }}"
                               data-date="{{ message.timestamp|date:'U' }}">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <div class="avatar-sm">
                                            {{ message.sender.get_full_name|first|upper }}
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                            <h6 class="mb-0">
                                                {% if not message.is_read %}
                                                <i class="bi bi-envelope-fill text-primary me-2"></i>
                                                {% else %}
                                                <i class="bi bi-envelope-open text-muted me-2"></i>
                                                {% endif %}
                                                {{ message.sender.get_full_name }}
                                            </h6>
                                            <div class="text-end">
                                                <small class="text-muted">{{ message.timestamp|timesince }} ago</small>
                                                {% if message.priority and message.priority != 'normal' %}
                                                <span class="badge-priority badge bg-{% if message.priority == 'high' %}warning{% elif message.priority == 'urgent' %}danger{% else %}info{% endif %} ms-1">
                                                    {{ message.priority|first|upper }}
                                                </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <h6 class="mb-1 text-dark">{{ message.subject }}</h6>
                                        <p class="message-preview mb-0 text-muted">
                                            {{ message.message|truncatewords:25 }}
                                        </p>
                                    </div>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="bi bi-envelope-open"></i>
                            </div>
                            <h4 class="text-muted">No messages found</h4>
                            <p class="text-muted mb-4">You don't have any messages in your inbox yet.</p>
                            <a href="{% url 'parent_message_create' %}" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-2"></i>Send your first message
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Pagination -->
                    {% if is_paginated %}
                    <div class="card-footer bg-white">
                        <nav aria-label="Message pagination">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted">
                                        Showing page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                    </small>
                                </div>
                                <ul class="pagination mb-0">
                                    {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                    {% endif %}
                                    
                                    {% for num in page_obj.paginator.page_range %}
                                        {% if page_obj.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                        </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Select action to perform on selected messages:</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" id="markReadBulk">
                        <i class="bi bi-envelope-open me-2"></i>Mark as Read
                    </button>
                    <button class="btn btn-outline-warning" id="markUnreadBulk">
                        <i class="bi bi-envelope me-2"></i>Mark as Unread
                    </button>
                    <button class="btn btn-outline-danger" id="deleteBulk">
                        <i class="bi bi-trash me-2"></i>Delete Messages
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refreshBtn');
    const statusFilter = document.getElementById('statusFilter');
    const sortFilter = document.getElementById('sortFilter');
    const searchFilter = document.getElementById('searchFilter');
    const clearSearch = document.getElementById('clearSearch');
    const applyFilters = document.getElementById('applyFilters');
    const messagesList = document.getElementById('messagesList');

    // Refresh functionality
    refreshBtn.addEventListener('click', function() {
        this.classList.add('spinning');
        setTimeout(() => {
            window.location.reload();
        }, 500);
    });

    // Clear search
    clearSearch.addEventListener('click', function() {
        searchFilter.value = '';
        filterMessages();
    });

    // Apply filters
    applyFilters.addEventListener('click', filterMessages);

    // Real-time search
    searchFilter.addEventListener('input', debounce(filterMessages, 300));

    // Filter and sort messages
    function filterMessages() {
        const status = statusFilter.value;
        const sort = sortFilter.value;
        const search = searchFilter.value.toLowerCase();
        
        const messageItems = messagesList.querySelectorAll('.message-item');
        
        messageItems.forEach(item => {
            const sender = item.getAttribute('data-sender');
            const subject = item.getAttribute('data-subject');
            const content = item.getAttribute('data-content');
            const isRead = item.getAttribute('data-read') === 'true';
            const matchesSearch = !search || 
                sender.includes(search) || 
                subject.includes(search) || 
                content.includes(search);
            
            const matchesStatus = status === 'all' ||
                (status === 'unread' && !isRead) ||
                (status === 'read' && isRead);
            
            if (matchesSearch && matchesStatus) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });

        // Sort messages
        sortMessages(sort);
    }

    // Sort messages
    function sortMessages(sortBy) {
        const container = messagesList;
        const items = Array.from(container.querySelectorAll('.message-item:not([style*="display: none"])'));
        
        items.sort((a, b) => {
            switch(sortBy) {
                case 'oldest':
                    return parseInt(a.getAttribute('data-date')) - parseInt(b.getAttribute('data-date'));
                case 'sender':
                    return a.getAttribute('data-sender').localeCompare(b.getAttribute('data-sender'));
                case 'newest':
                default:
                    return parseInt(b.getAttribute('data-date')) - parseInt(a.getAttribute('data-date'));
            }
        });
        
        // Reappend sorted items
        items.forEach(item => container.appendChild(item));
    }

    // Debounce function for search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Auto-refresh every 2 minutes
    setInterval(() => {
        refreshBtn.click();
    }, 120000);

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl + F for search
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            searchFilter.focus();
        }
        // F5 for refresh
        if (e.key === 'F5') {
            e.preventDefault();
            refreshBtn.click();
        }
    });

    // Initialize filters from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const statusParam = urlParams.get('status');
    const sortParam = urlParams.get('sort');
    const searchParam = urlParams.get('search');
    
    if (statusParam) statusFilter.value = statusParam;
    if (sortParam) sortFilter.value = sortParam;
    if (searchParam) searchFilter.value = searchParam;
    
    // Apply initial filters
    setTimeout(filterMessages, 100);
});

// Add CSS for spinning animation
const style = document.createElement('style');
style.textContent = `
    .spinning {
        animation: spin 0.5s linear;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}