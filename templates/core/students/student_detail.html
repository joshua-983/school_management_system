{% extends 'base.html' %}
{% load humanize %}
{% load attendance_filters %}

{% block title %}{{ student.get_full_name }} - Student Profile{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        --warning-gradient: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        --danger-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .student-profile-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .profile-card {
        border: none;
        border-radius: 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
        background: white;
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .profile-card:hover {
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
    }

    .profile-header {
        background: var(--primary-gradient);
        color: white;
        padding: 2rem;
        text-align: center;
        position: relative;
    }

    .profile-avatar {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 5px solid white;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        margin: 0 auto 1rem;
        transition: all 0.3s ease;
    }

    .profile-avatar:hover {
        transform: scale(1.05);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.3);
    }

    .avatar-placeholder {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 4rem;
        border: 5px solid white;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        margin: 0 auto 1rem;
    }

    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        height: 100%;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stats-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .stats-label {
        font-size: 0.9rem;
        color: #718096;
        font-weight: 600;
    }

    .badge-custom {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .btn-action {
        border-radius: 12px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .table-responsive {
        border-radius: 15px;
        overflow: hidden;
    }

    .table th {
        background: var(--primary-gradient);
        color: white;
        font-weight: 600;
        border: none;
        padding: 1rem;
    }

    .table td {
        padding: 1rem;
        vertical-align: middle;
        border-color: #e9ecef;
    }

    .table tr {
        transition: all 0.3s ease;
    }

    .table tr:hover {
        background-color: #f8f9fa;
        transform: translateX(4px);
    }

    .nav-tabs .nav-link {
        border: none;
        border-radius: 10px;
        padding: 1rem 1.5rem;
        font-weight: 600;
        color: #718096;
        transition: all 0.3s ease;
    }

    .nav-tabs .nav-link.active {
        background: var(--primary-gradient);
        color: white;
        border: none;
    }

    .nav-tabs .nav-link:hover {
        color: #667eea;
        transform: translateY(-2px);
    }

    .tab-content {
        padding: 2rem;
        background: white;
        border-radius: 0 0 20px 20px;
    }

    .info-item {
        padding: 1rem;
        border-radius: 10px;
        background: #f8f9fa;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .info-item:hover {
        background: #e9ecef;
        transform: translateX(4px);
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin: 2rem 0;
    }

    /* Animation classes */
    .fade-in {
        animation: fadeIn 0.6s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
        animation: slideIn 0.8s ease-out;
    }

    @keyframes slideIn {
        from { transform: translateX(-100px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .student-profile-container {
            padding: 1rem;
        }
        
        .profile-card {
            border-radius: 15px;
        }
        
        .profile-header {
            padding: 1.5rem;
        }
        
        .profile-avatar, .avatar-placeholder {
            width: 120px;
            height: 120px;
        }
        
        .stats-number {
            font-size: 2rem;
        }
        
        .nav-tabs .nav-link {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }
    }

    /* Custom scrollbar */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: var(--primary-gradient);
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="student-profile-container">
    <div class="container">
        <!-- Profile Header -->
        <div class="card profile-card slide-in">
            <div class="profile-header">
                <div class="row align-items-center">
                    <div class="col-md-8 text-md-start text-center">
                        <h1 class="h2 mb-2 fw-bold">{{ student.get_full_name }}</h1>
                        <p class="mb-1 opacity-85">{{ student.student_id }}</p>
                        <p class="mb-0">
                            <span class="badge badge-custom bg-light text-dark">
                                {{ student.get_class_level_display }}
                            </span>
                            <span class="badge badge-custom bg-light text-dark ms-2">
                                {{ student.get_gender_display }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-4 text-center">
                        {% if student.profile_picture %}
                            <img src="{{ student.profile_picture.url }}" alt="{{ student.get_full_name }}" 
                                 class="profile-avatar">
                        {% else %}
                            <div class="avatar-placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs nav-justified mt-4 px-3" id="studentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                        <i class="fas fa-user-circle me-2"></i>Overview
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="academics-tab" data-bs-toggle="tab" data-bs-target="#academics" type="button" role="tab">
                        <i class="fas fa-graduation-cap me-2"></i>Academics
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
                        <i class="fas fa-calendar-check me-2"></i>Attendance
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial" type="button" role="tab">
                        <i class="fas fa-money-bill-wave me-2"></i>Financial
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="studentTabsContent">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="mb-4"><i class="fas fa-info-circle me-2 text-primary"></i>Personal Information</h4>
                            <div class="info-item">
                                <strong><i class="fas fa-birthday-cake me-2"></i>Date of Birth:</strong>
                                {{ student.date_of_birth|date:"M d, Y" }} ({{ student.get_age }} years old)
                            </div>
                            <div class="info-item">
                                <strong><i class="fas fa-globe me-2"></i>Nationality:</strong>
                                {{ student.nationality|default:"Not specified" }}
                            </div>
                            <div class="info-item">
                                <strong><i class="fas fa-map-marker-alt me-2"></i>Place of Birth:</strong>
                                {{ student.place_of_birth|default:"Not specified" }}
                            </div>
                            <div class="info-item">
                                <strong><i class="fas fa-home me-2"></i>Address:</strong>
                                {{ student.residential_address|default:"Not specified" }}
                            </div>
                            {% if student.ethnicity %}
                            <div class="info-item">
                                <strong><i class="fas fa-users me-2"></i>Ethnicity:</strong>
                                {{ student.ethnicity }}
                            </div>
                            {% endif %}
                            {% if student.religion %}
                            <div class="info-item">
                                <strong><i class="fas fa-pray me-2"></i>Religion:</strong>
                                {{ student.religion }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h4 class="mb-4"><i class="fas fa-users me-2 text-primary"></i>Parents/Guardians</h4>
                            {% if student.parents.all %}
                                {% for parent in student.parents.all %}
                                <div class="info-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>{{ parent.full_name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ parent.get_relationship_display }}</small>
                                            <br>
                                            <small>{{ parent.phone_number }}</small>
                                            {% if parent.email %}
                                            <br>
                                            <small>{{ parent.email }}</small>
                                            {% endif %}
                                            {% if parent.is_emergency_contact %}
                                            <br>
                                            <span class="badge bg-danger mt-1">Emergency Contact</span>
                                            {% endif %}
                                        </div>
                                        <div class="btn-group">
                                            <a href="{% url 'parent_update' parent.pk %}" class="btn btn-warning btn-sm">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'parent_delete' parent.pk %}" class="btn btn-danger btn-sm">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i> No parents/guardians found
                                </div>
                            {% endif %}
                            <a href="{% url 'parent_create' student_id=student.pk %}" class="btn btn-primary mt-3">
                                <i class="fas fa-plus me-2"></i> Add Parent/Guardian
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Academics Tab -->
                <div class="tab-pane fade" id="academics" role="tabpanel">
                    <h4 class="mb-4"><i class="fas fa-graduation-cap me-2 text-primary"></i>Academic Performance</h4>
                    {% if grades %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Homework (20%)</th>
                                    <th>Classwork (30%)</th>
                                    <th>Test (10%)</th>
                                    <th>Exam (40%)</th>
                                    <th>Total</th>
                                    <th>Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for grade in grades %}
                                <tr class="fade-in">
                                    <td><strong>{{ grade.subject.name }}</strong></td>
                                    <td>{{ grade.homework_score }}</td>
                                    <td>{{ grade.classwork_score }}</td>
                                    <td>{{ grade.test_score }}</td>
                                    <td>{{ grade.exam_score }}</td>
                                    <td><strong>{{ grade.total_score }}</strong></td>
                                    <td>
                                        <span class="badge badge-custom bg-{% if grade.grade == 'A+' or grade.grade == 'A' %}success{% elif grade.grade == 'B+' or grade.grade == 'B' %}info{% elif grade.grade == 'C+' or grade.grade == 'C' %}warning{% else %}danger{% endif %}">
                                            {{ grade.grade }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                    
                    <div class="text-center mt-4">
                        <a href="{% url 'report_card_pdf' student.pk %}" class="btn btn-primary btn-action">
                            <i class="fas fa-download me-2"></i> Download Report Card (PDF)
                        </a>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center py-5">
                        <i class="fas fa-book-open display-4 d-block mb-3 text-muted"></i>
                        <h5>No academic records available</h5>
                        <p class="text-muted">Academic performance data will appear here once available</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Attendance Tab -->
                <div class="tab-pane fade" id="attendance" role="tabpanel">
                    <h4 class="mb-4"><i class="fas fa-calendar-check me-2 text-primary"></i>Attendance Summary</h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="stats-card bg-success text-white">
                                <div class="stats-number">{{ student.attendances|attendance_count:'present'|default:0 }}</div>
                                <div class="stats-label">Days Present</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="stats-card bg-danger text-white">
                                <div class="stats-number">{{ student.attendances|attendance_count:'absent'|default:0 }}</div>
                                <div class="stats-label">Days Absent</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="stats-card bg-info text-white">
                                <div class="stats-number">
                                    {% with present=student.attendances|attendance_count:'present' total=student.attendances.count %}
                                        {% if total > 0 %}
                                            {{ present|divide:total|multiply:100|floatformat:0 }}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="stats-label">Attendance Rate</div>
                            </div>
                        </div>
                    </div>

                    <h5 class="mb-3">Recent Attendance Records</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Term</th>
                                    <th>Recorded By</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attendance in student.attendances.all|dictsortreversed:"date"|slice:":10" %}
                                <tr class="fade-in">
                                    <td>{{ attendance.date|date:"M d, Y" }}</td>
                                    <td>
                                        <span class="badge badge-custom bg-{% if attendance.status == 'present' %}success{% elif attendance.status == 'absent' %}danger{% elif attendance.status == 'late' %}warning{% else %}info{% endif %}">
                                            {{ attendance.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ attendance.get_term_display }}</td>
                                    <td>{{ attendance.recorded_by.get_full_name|default:"System" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center py-4">
                                        <i class="fas fa-calendar-times text-muted display-4 d-block mb-2"></i>
                                        <p class="text-muted">No attendance records found</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Financial Tab -->
                <div class="tab-pane fade" id="financial" role="tabpanel">
                    <h4 class="mb-4"><i class="fas fa-money-bill-wave me-2 text-primary"></i>Fee Payments</h4>
                    
                    {% if student.fees.all %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Academic Year</th>
                                    <th>Term</th>
                                    <th>Amount Payable</th>
                                    <th>Amount Paid</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for fee in student.fees.all %}
                                <tr class="fade-in">
                                    <td>{{ fee.academic_year }}</td>
                                    <td>{{ fee.get_term_display }}</td>
                                    <td>${{ fee.amount_payable|intcomma }}</td>
                                    <td>${{ fee.amount_paid|intcomma }}</td>
                                    <td><strong>${{ fee.balance|intcomma }}</strong></td>
                                    <td>
                                        <span class="badge badge-custom bg-{% if fee.payment_status == 'PAID' %}success{% elif fee.payment_status == 'PARTIAL' %}warning{% else %}danger{% endif %}">
                                            {{ fee.get_payment_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ fee.due_date|date:"M d, Y" }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'fee_update' fee.pk %}" class="btn btn-warning">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'fee_delete' fee.pk %}" class="btn btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center py-5">
                        <i class="fas fa-receipt display-4 d-block mb-3 text-muted"></i>
                        <h5>No fee records found</h5>
                        <p class="text-muted">Fee payment records will appear here once available</p>
                    </div>
                    {% endif %}
                    
                    <a href="{% url 'fee_create' student_id=student.pk %}" class="btn btn-primary btn-action">
                        <i class="fas fa-plus me-2"></i> Add Fee Payment
                    </a>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mt-4 fade-in">
            <div class="btn-group">
                <a href="{% url 'student_update' student.pk %}" class="btn btn-warning btn-action">
                    <i class="fas fa-edit me-2"></i> Edit Profile
                </a>
                <a href="{% url 'student_list' %}" class="btn btn-secondary btn-action">
                    <i class="fas fa-arrow-left me-2"></i> Back to List
                </a>
                <a href="{% url 'student_delete' student.pk %}" class="btn btn-danger btn-action">
                    <i class="fas fa-trash me-2"></i> Delete
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if grades %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize performance chart
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [{% for grade in grades %}'{{ grade.subject.name }}',{% endfor %}],
            datasets: [{
                label: 'Total Score (%)',
                data: [{% for grade in grades %}{{ grade.total_score }},{% endfor %}],
                backgroundColor: 'rgba(102, 126, 234, 0.7)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 2,
                borderRadius: 8,
                hoverBackgroundColor: 'rgba(102, 126, 234, 0.9)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Score (%)',
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Subjects',
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 12,
                    cornerRadius: 8
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            }
        }
    });

    // Add animation to table rows
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach((row, index) => {
        row.style.animationDelay = `${index * 0.1}s`;
    });

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Tab change animation
    const tabPanes = document.querySelectorAll('.tab-pane');
    tabPanes.forEach(pane => {
        pane.addEventListener('show.bs.tab', function () {
            this.classList.add('fade-in');
        });
    });

    // Print functionality
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            window.print();
        }
    });
});

// Function to export data (placeholder)
function exportData(format) {
    console.log(`Exporting data in ${format} format`);
    // Implementation would go here
}
</script>
{% endif %}
{% endblock %}