{% extends 'base.html' %}
{% load static %}

{% block title %}{% if object %}Edit{% else %}Register{% endif %} Student - School Management System{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .student-form-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .form-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        background: white;
        overflow: hidden;
    }

    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem 2rem;
        border: none;
    }

    .form-label {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .form-label.required::after {
        content: " *";
        color: #dc3545;
    }

    .form-control, .form-select {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        font-size: 0.95rem;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .form-control.is-invalid {
        border-color: #dc3545;
    }

    .invalid-feedback {
        display: block;
        font-size: 0.875rem;
        color: #dc3545;
    }

    .btn-primary {
        background: #667eea;
        border: none;
        border-radius: 8px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
    }

    .avatar-upload {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .avatar-upload:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .avatar-preview {
        width: 150px;
        height: 150px;
        border-radius: 10px;
        object-fit: cover;
        border: 3px solid white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .avatar-placeholder {
        width: 150px;
        height: 150px;
        border-radius: 10px;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 2rem;
    }

    .section-header {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 1rem 1.5rem;
        margin: 1.5rem 0 1rem;
        border-radius: 0 8px 8px 0;
    }

    .field-group {
        margin-bottom: 1.5rem;
    }

    .help-text {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .progress-container {
        margin-bottom: 2rem;
    }

    .step-indicator {
        display: flex;
        justify-content: space-between;
        position: relative;
        margin-bottom: 2rem;
    }

    .step-indicator::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #e9ecef;
        z-index: 1;
    }

    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 2px solid #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #6c757d;
        position: relative;
        z-index: 2;
        transition: all 0.3s ease;
    }

    .step.active {
        background: #667eea;
        border-color: #667eea;
        color: white;
        transform: scale(1.1);
    }

    .step.completed {
        background: #28a745;
        border-color: #28a745;
        color: white;
    }

    .step-label {
        position: absolute;
        top: 45px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 0.8rem;
        color: #6c757d;
    }

    .form-step {
        display: none;
        animation: fadeIn 0.3s ease-in;
    }

    .form-step.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
        .student-form-container {
            padding: 1rem;
        }
        
        .card-header {
            padding: 1rem;
        }
        
        .step-label {
            font-size: 0.7rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="student-form-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Display Messages -->
                {% if messages %}
                <div class="messages-container mb-4">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">Step <span id="current-step">1</span> of <span id="total-steps">
                            {% if not object %}4{% else %}3{% endif %}
                        </span></small>
                        <small class="text-muted" id="step-title">Personal Information</small>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="form-progress" style="width: 25%"></div>
                    </div>
                </div>

                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step-group text-center">
                        <div class="step active" data-step="1">1</div>
                        <div class="step-label">Personal Info</div>
                    </div>
                    <div class="step-group text-center">
                        <div class="step" data-step="2">2</div>
                        <div class="step-label">Academic Info</div>
                    </div>
                    <div class="step-group text-center">
                        <div class="step" data-step="3">3</div>
                        <div class="step-label">Additional Info</div>
                    </div>
                    {% if not object %}
                    <div class="step-group text-center">
                        <div class="step" data-step="4">4</div>
                        <div class="step-label">Account Setup</div>
                    </div>
                    {% endif %}
                </div>

                <!-- Form Card -->
                <div class="card form-card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-user-graduate me-2"></i>
                            {% if object %}Edit{% else %}Register{% endif %} Student
                        </h4>
                    </div>
                    <div class="card-body p-4">
                        <form method="post" enctype="multipart/form-data" id="studentForm" novalidate>
                            {% csrf_token %}
                            
                            {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Step 1: Personal Information -->
                            <div class="form-step active" id="step1">
                                <h5 class="section-header">
                                    <i class="fas fa-user me-2"></i>Personal Information
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-4">
                                        <div class="avatar-upload" id="avatarUploadArea">
                                            {% if object and object.profile_picture %}
                                                <img src="{{ object.profile_picture.url }}" class="avatar-preview mb-3" id="avatarPreview">
                                            {% else %}
                                                <div class="avatar-placeholder mb-3 mx-auto">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                            {% endif %}
                                            {{ form.profile_picture }}
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('id_profile_picture').click()">
                                                <i class="fas fa-upload me-1"></i>Upload Photo
                                            </button>
                                            <div class="help-text">JPG, PNG, Max 5MB</div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="field-group">
                                                    <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                                        First Name
                                                    </label>
                                                    {{ form.first_name }}
                                                    {% if form.first_name.errors %}
                                                        <div class="invalid-feedback">
                                                            {{ form.first_name.errors.0 }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="field-group">
                                                    <label for="{{ form.middle_name.id_for_label }}" class="form-label">
                                                        Middle Name
                                                    </label>
                                                    {{ form.middle_name }}
                                                    {% if form.middle_name.errors %}
                                                        <div class="invalid-feedback">
                                                            {{ form.middle_name.errors.0 }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="field-group">
                                                    <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                                        Last Name
                                                    </label>
                                                    {{ form.last_name }}
                                                    {% if form.last_name.errors %}
                                                        <div class="invalid-feedback">
                                                            {{ form.last_name.errors.0 }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="field-group">
                                                    <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">
                                                        Date of Birth
                                                    </label>
                                                    {{ form.date_of_birth }}
                                                    {% if form.date_of_birth.errors %}
                                                        <div class="invalid-feedback">
                                                            {{ form.date_of_birth.errors.0 }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="field-group">
                                                    <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                                                        Phone Number
                                                    </label>
                                                    {{ form.phone_number }}
                                                    {% if form.phone_number.errors %}
                                                        <div class="invalid-feedback">
                                                            {{ form.phone_number.errors.0 }}
                                                        </div>
                                                    {% endif %}
                                                    <div class="help-text">10 digits starting with 0</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <div></div>
                                    <button type="button" class="btn btn-primary next-step" data-next="2">
                                        Continue <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 2: Academic Information -->
                            <div class="form-step" id="step2">
                                <h5 class="section-header">
                                    <i class="fas fa-graduation-cap me-2"></i>Academic Information
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="field-group">
                                            <label for="{{ form.gender.id_for_label }}" class="form-label required">
                                                Gender
                                            </label>
                                            {{ form.gender }}
                                            {% if form.gender.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.gender.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="field-group">
                                            <label for="{{ form.class_level.id_for_label }}" class="form-label required">
                                                Class Level
                                            </label>
                                            {{ form.class_level }}
                                            {% if form.class_level.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.class_level.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-outline-secondary prev-step" data-prev="1">
                                        <i class="fas fa-arrow-left me-2"></i> Back
                                    </button>
                                    <button type="button" class="btn btn-primary next-step" data-next="3">
                                        Continue <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 3: Additional Information -->
                            <div class="form-step" id="step3">
                                <h5 class="section-header">
                                    <i class="fas fa-info-circle me-2"></i>Additional Information
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="field-group">
                                            <label for="{{ form.nationality.id_for_label }}" class="form-label">
                                                Nationality
                                            </label>
                                            {{ form.nationality }}
                                            {% if form.nationality.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.nationality.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="field-group">
                                            <label for="{{ form.ethnicity.id_for_label }}" class="form-label">
                                                Ethnicity
                                            </label>
                                            {{ form.ethnicity }}
                                            {% if form.ethnicity.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.ethnicity.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="field-group">
                                            <label for="{{ form.religion.id_for_label }}" class="form-label">
                                                Religion
                                            </label>
                                            {{ form.religion }}
                                            {% if form.religion.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.religion.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="field-group">
                                            <label for="{{ form.place_of_birth.id_for_label }}" class="form-label">
                                                Place of Birth
                                            </label>
                                            {{ form.place_of_birth }}
                                            {% if form.place_of_birth.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.place_of_birth.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="field-group">
                                    <label for="{{ form.residential_address.id_for_label }}" class="form-label">
                                        Residential Address
                                    </label>
                                    {{ form.residential_address }}
                                    {% if form.residential_address.errors %}
                                        <div class="invalid-feedback">
                                            {{ form.residential_address.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-outline-secondary prev-step" data-prev="2">
                                        <i class="fas fa-arrow-left me-2"></i> Back
                                    </button>
                                    {% if not object %}
                                    <button type="button" class="btn btn-primary next-step" data-next="4">
                                        Continue <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                    {% else %}
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-2"></i> Update Student
                                    </button>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Step 4: Account Setup -->
                            {% if not object %}
                            <div class="form-step" id="step4">
                                <h5 class="section-header">
                                    <i class="fas fa-lock me-2"></i>Account Setup
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="field-group">
                                            <label for="id_username" class="form-label required">
                                                Username
                                            </label>
                                            <input type="text" name="username" class="form-control" id="id_username" 
                                                   value="{{ form.username.value|default:'' }}"
                                                   placeholder="Choose a username">
                                            {% if form.username.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.username.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <div class="help-text">Letters, numbers, and @/./+/-/_ only</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="field-group">
                                            <label for="id_email" class="form-label required">
                                                Email Address
                                            </label>
                                            <input type="email" name="email" class="form-control" id="id_email" 
                                                   value="{{ form.email.value|default:'' }}"
                                                   placeholder="student@example.com">
                                            {% if form.email.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.email.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="field-group">
                                            <label for="id_password1" class="form-label required">
                                                Password
                                            </label>
                                            <input type="password" name="password1" class="form-control" id="id_password1" 
                                                   placeholder="Enter password">
                                            {% if form.password1.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.password1.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <div class="help-text">Minimum 8 characters</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="field-group">
                                            <label for="id_password2" class="form-label required">
                                                Confirm Password
                                            </label>
                                            <input type="password" name="password2" class="form-control" id="id_password2" 
                                                   placeholder="Confirm password">
                                            {% if form.password2.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.password2.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-outline-secondary prev-step" data-prev="3">
                                        <i class="fas fa-arrow-left me-2"></i> Back
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-user-plus me-2"></i> Create Student Account
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize date picker
    const dobField = document.getElementById('id_date_of_birth');
    if (dobField) {
        flatpickr(dobField, {
            dateFormat: "Y-m-d",
            maxDate: "today",
        });
    }

    // Step management
    const totalSteps = {% if not object %}4{% else %}3{% endif %};
    let currentStep = 1;
    
    function updateProgress() {
        const progress = (currentStep / totalSteps) * 100;
        document.getElementById('form-progress').style.width = `${progress}%`;
        document.getElementById('current-step').textContent = currentStep;
        
        const stepTitles = ['Personal Information', 'Academic Information', 'Additional Information', 'Account Setup'];
        document.getElementById('step-title').textContent = stepTitles[currentStep - 1];
    }
    
    function showStep(stepNumber) {
        // Hide all steps
        document.querySelectorAll('.form-step').forEach(step => {
            step.classList.remove('active');
        });
        
        // Show current step
        const currentStepElement = document.getElementById(`step${stepNumber}`);
        if (currentStepElement) {
            currentStepElement.classList.add('active');
        }
        
        // Update step indicators
        document.querySelectorAll('.step').forEach(stepEl => {
            const stepNum = parseInt(stepEl.dataset.step);
            stepEl.classList.remove('active', 'completed');
            
            if (stepNum < stepNumber) {
                stepEl.classList.add('completed');
            } else if (stepNum === stepNumber) {
                stepEl.classList.add('active');
            }
        });
        
        currentStep = stepNumber;
        updateProgress();
    }

    // Step navigation - NO VALIDATION FOR PERSONAL INFORMATION FIELDS
    document.querySelectorAll('.next-step').forEach(button => {
        button.addEventListener('click', function() {
            const nextStep = parseInt(this.dataset.next);
            const currentStepElement = document.getElementById(`step${currentStep}`);
            
            // Only validate required fields (those with .required class)
            const requiredFields = currentStepElement.querySelectorAll('.required');
            let isValid = true;
            
            requiredFields.forEach(label => {
                const field = label.closest('.field-group').querySelector('input, select, textarea');
                if (field && !field.value.trim()) {
                    isValid = false;
                    field.classList.add('is-invalid');
                    if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('invalid-feedback')) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = 'This field is required';
                        field.parentNode.appendChild(errorDiv);
                    }
                } else if (field) {
                    field.classList.remove('is-invalid');
                    const errorDiv = field.parentNode.querySelector('.invalid-feedback');
                    if (errorDiv && errorDiv.textContent === 'This field is required') {
                        errorDiv.remove();
                    }
                    
                    // Additional validation for specific fields
                    if (field.name === 'phone_number' || field.id === 'id_phone_number') {
                        const phoneValue = field.value.trim();
                        if (phoneValue && !isValidPhoneNumber(phoneValue)) {
                            isValid = false;
                            field.classList.add('is-invalid');
                            if (!field.parentNode.querySelector('.invalid-feedback')) {
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'invalid-feedback';
                                errorDiv.textContent = 'Phone number must be 10 digits starting with 0';
                                field.parentNode.appendChild(errorDiv);
                            }
                        }
                    }
                }
            });
            
            if (isValid) {
                showStep(nextStep);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                // Scroll to first error
                const firstError = currentStepElement.querySelector('.is-invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    });

    // Previous step
    document.querySelectorAll('.prev-step').forEach(button => {
        button.addEventListener('click', function() {
            const prevStep = parseInt(this.dataset.prev);
            showStep(prevStep);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    });

    // Avatar upload preview
    const avatarInput = document.getElementById('id_profile_picture');
    const avatarPreview = document.getElementById('avatarPreview');
    const avatarPlaceholder = document.querySelector('.avatar-placeholder');
    
    if (avatarInput) {
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (avatarPreview) {
                        avatarPreview.src = e.target.result;
                    } else if (avatarPlaceholder) {
                        avatarPlaceholder.innerHTML = `<img src="${e.target.result}" class="avatar-preview">`;
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Phone number formatting
    const phoneInput = document.getElementById('id_phone_number');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0 && !value.startsWith('0')) {
                value = '0' + value;
            }
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            e.target.value = value;
        });
    }

    // Form submission
    const form = document.getElementById('studentForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = `
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    {% if object %}Updating...{% else %}Creating...{% endif %}
                `;
            }
        });
    }

    // Validation helper functions
    function isValidPhoneNumber(phone) {
        const cleanedPhone = phone.replace(/[\s-]/g, '');
        const phoneRegex = /^0\d{9}$/;
        return phoneRegex.test(cleanedPhone);
    }

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // Initialize
    updateProgress();
});
</script>
{% endblock %}