{% extends 'base.html' %}
{% load static %}

{% block title %}{{ timetable.get_class_level_display }} - {{ timetable.get_day_of_week_display }} - Teacher View{% endblock %}

{% block extra_css %}
<style>
.teacher-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px 15px 0 0;
}
.class-info-card {
    border: none;
    border-radius: 10px;
    background: #f8f9fa;
}
.class-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: bold;
}
.period-timeline {
    position: relative;
    padding-left: 40px;
}
.period-timeline::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}
.timeline-marker {
    position: absolute;
    left: 12px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 3px solid white;
    z-index: 1;
}
.timeline-marker.current {
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(25, 135, 84, 0); }
    100% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0); }
}
.period-card-teacher {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
    position: relative;
}
.period-card-teacher:hover {
    transform: translateX(5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.period-card-teacher.current {
    border-color: #198754;
    background: rgba(25, 135, 84, 0.05);
}
.period-time-badge {
    position: absolute;
    top: -10px;
    right: 15px;
    background: white;
    border: 2px solid #0d6efd;
    border-radius: 15px;
    padding: 2px 12px;
    font-size: 0.85rem;
    font-weight: 600;
}
.break-card {
    background: #f8f9fa;
    border: 2px dashed #6c757d;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    margin-bottom: 15px;
}
.class-stats {
    display: flex;
    justify-content: space-around;
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    margin-bottom: 20px;
}
.stat-item {
    flex: 1;
}
.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #0d6efd;
}
.stat-label {
    font-size: 0.85rem;
    color: #6c757d;
}
.attendance-indicator {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: #e9ecef;
    overflow: hidden;
}
.attendance-fill {
    height: 100%;
    border-radius: 4px;
}
.student-list {
    max-height: 300px;
    overflow-y: auto;
}
.student-item {
    padding: 10px;
    border-bottom: 1px solid #f1f3f4;
    transition: background 0.2s ease;
}
.student-item:hover {
    background: #f8f9fa;
}
.student-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
}
.resource-card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
}
.resource-card:hover {
    border-color: #0d6efd;
    background: #f8f9fa;
}
.action-menu {
    position: sticky;
    top: 20px;
    z-index: 100;
}
.empty-period {
    padding: 30px;
    text-align: center;
    color: #6c757d;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    margin: 10px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card teacher-header">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="class-icon bg-white text-primary me-4">
                                    {{ timetable.get_class_level_display|slice:":3" }}
                                </div>
                                <div>
                                    <h1 class="h2 mb-1">{{ timetable.get_class_level_display }}</h1>
                                    <div class="d-flex align-items-center flex-wrap gap-2 mt-2">
                                        <span class="badge bg-light text-dark">
                                            <i class="fas fa-calendar-day me-1"></i>{{ timetable.get_day_of_week_display }}
                                        </span>
                                        <span class="badge bg-light text-dark">
                                            <i class="fas fa-calendar-alt me-1"></i>{{ timetable.academic_year }}
                                        </span>
                                        <span class="badge bg-light text-dark">
                                            <i class="fas fa-layer-group me-1"></i>Term {{ timetable.term }}
                                        </span>
                                        {% if timetable.is_active %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Active
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-times-circle me-1"></i>Inactive
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="btn-group mt-3 mt-md-0">
                                <a href="{% url 'teacher_timetable_list' %}" class="btn btn-light">
                                    <i class="fas fa-arrow-left me-2"></i>Back
                                </a>
                                <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#printModal">
                                            <i class="fas fa-print me-2"></i>Print
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'print_timetable' timetable.pk %}" target="_blank">
                                            <i class="fas fa-file-pdf me-2"></i>Export PDF
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" id="shareTimetableBtn">
                                            <i class="fas fa-share-alt me-2"></i>Share with Students
                                        </a>
                                    </li>
                                    {% if is_admin or timetable.can_edit %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'timetable_manage' timetable.pk %}">
                                            <i class="fas fa-edit me-2"></i>Edit Schedule
                                        </a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Class Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="class-stats">
                <div class="stat-item">
                    <div class="stat-value">{{ total_periods }}</div>
                    <div class="stat-label">Total Periods</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ teaching_periods }}</div>
                    <div class="stat-label">Teaching Periods</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ break_periods }}</div>
                    <div class="stat-label">Break Periods</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ total_hours }}h</div>
                    <div class="stat-label">Total Duration</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column - Schedule -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Daily Schedule</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="toggleBreaks">
                            <i class="fas fa-eye-slash me-1"></i>Hide Breaks
                        </button>
                        <button class="btn btn-sm btn-outline-success ms-2" id="takeAttendance">
                            <i class="fas fa-clipboard-check me-1"></i>Take Attendance
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="period-timeline">
                        {% for timeslot in timeslots %}
                            {% with entry=entries|dict_key:timeslot.id %}
                            <div class="mb-4">
                                <!-- Time Marker -->
                                <div class="timeline-marker bg-{% if entry.is_break %}secondary{% else %}primary{% endif %} 
                                             {% if entry.is_current %}current{% endif %}"
                                     data-period="{{ timeslot.period_number }}"></div>
                                
                                <!-- Period Card -->
                                <div class="period-card-teacher {% if entry.is_current %}current{% endif %} 
                                            {% if entry.is_break %}break-period{% endif %}"
                                     data-period-id="{{ timeslot.id }}">
                                    
                                    <div class="period-time-badge">
                                        {{ timeslot.start_time|time:"g:i" }} - {{ timeslot.end_time|time:"g:i" }}
                                    </div>
                                    
                                    <div class="row align-items-center">
                                        <div class="col-md-1 text-center">
                                            <span class="badge bg-secondary rounded-pill">#{{ timeslot.period_number }}</span>
                                        </div>
                                        
                                        <div class="col-md-8">
                                            {% if entry.is_break %}
                                                <div class="text-center py-3">
                                                    <i class="fas fa-coffee fa-2x text-muted mb-3"></i>
                                                    <h5 class="mb-1">{{ entry.break_name|default:"Break" }}</h5>
                                                    <p class="text-muted mb-0">Break Time</p>
                                                </div>
                                            {% elif entry %}
                                                <h5 class="mb-2">
                                                    <i class="fas fa-book me-2 text-primary"></i>{{ entry.subject.name }}
                                                </h5>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-2">
                                                            <strong><i class="fas fa-user-tie me-2"></i>Teacher:</strong>
                                                            <span class="ms-2">{{ entry.teacher.get_full_name }}</span>
                                                        </div>
                                                        {% if entry.classroom %}
                                                        <div class="mb-2">
                                                            <strong><i class="fas fa-door-open me-2"></i>Classroom:</strong>
                                                            <span class="ms-2">{{ entry.classroom }}</span>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-2">
                                                            <strong><i class="fas fa-clock me-2"></i>Duration:</strong>
                                                            <span class="ms-2">{{ timeslot.duration }} minutes</span>
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong><i class="fas fa-users me-2"></i>Students:</strong>
                                                            <span class="ms-2">{{ student_count }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="empty-period">
                                                    <i class="fas fa-clock fa-2x mb-3"></i>
                                                    <h5>No Class Scheduled</h5>
                                                    <p class="text-muted">This time slot is currently empty</p>
                                                    {% if is_admin or timetable.can_edit %}
                                                    <a href="{% url 'timetable_manage' timetable.pk %}" class="btn btn-sm btn-primary mt-2">
                                                        <i class="fas fa-plus me-2"></i>Add Class
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="col-md-3 text-end">
                                            {% if entry and not entry.is_break %}
                                            <div class="btn-group-vertical">
                                                <button class="btn btn-sm btn-outline-info mb-2" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#periodDetailsModal"
                                                        data-period="{{ timeslot.period_number }}"
                                                        data-subject="{{ entry.subject.name }}"
                                                        data-teacher="{{ entry.teacher.get_full_name }}"
                                                        data-classroom="{{ entry.classroom|default:'Not specified' }}"
                                                        data-time="{{ timeslot.start_time|time:'g:i A' }} - {{ timeslot.end_time|time:'g:i A' }}">
                                                    <i class="fas fa-info-circle me-1"></i>Details
                                                </button>
                                                <button class="btn btn-sm btn-outline-success mb-2" 
                                                        onclick="takeAttendance('{{ timeslot.id }}')">
                                                    <i class="fas fa-clipboard-check me-1"></i>Attendance
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning"
                                                        onclick="addResource('{{ timeslot.id }}', '{{ entry.subject.name }}')">
                                                    <i class="fas fa-paperclip me-1"></i>Resources
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Attendance Progress -->
                                    {% if entry and not entry.is_break %}
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small>Attendance: {{ entry.attendance_present|default:0 }}/{{ student_count }} present</small>
                                            <small>{{ entry.attendance_percentage|default:0 }}%</small>
                                        </div>
                                        <div class="attendance-indicator">
                                            <div class="attendance-fill bg-{% if entry.attendance_percentage >= 90 %}success{% elif entry.attendance_percentage >= 75 %}warning{% else %}danger{% endif %}" 
                                                 style="width: {{ entry.attendance_percentage|default:0 }}%"></div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endwith %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Class Resources -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-paperclip me-2"></i>Class Resources</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="resourcesContainer">
                        <!-- Resources will be loaded dynamically -->
                        <div class="col-12 text-center py-4">
                            <i class="fas fa-folder-open fa-2x text-muted mb-3"></i>
                            <h6>No Resources Added</h6>
                            <p class="text-muted">Add teaching materials, notes, or assignments</p>
                            <button class="btn btn-primary" onclick="addResource(null, '{{ timetable.get_class_level_display }}')">
                                <i class="fas fa-plus me-2"></i>Add Resource
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Class Info & Actions -->
        <div class="col-lg-4">
            <!-- Class Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Class Information</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Class Teacher:</strong>
                        <p class="mb-1">{{ timetable.created_by.get_full_name }}</p>
                        <small class="text-muted">Created on {{ timetable.created_at|date:"d M Y" }}</small>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Class Level:</strong>
                        <p class="mb-0">{{ timetable.get_class_level_display }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Schedule Status:</strong>
                        <div class="d-flex align-items-center mt-1">
                            {% if timetable.is_active %}
                            <i class="fas fa-circle text-success me-2"></i>
                            <span>Active Schedule</span>
                            {% else %}
                            <i class="fas fa-circle text-secondary me-2"></i>
                            <span>Inactive Schedule</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Last Updated:</strong>
                        <p class="mb-0">{{ timetable.updated_at|date:"d M Y, g:i A" }}</p>
                    </div>
                </div>
            </div>

            <!-- Student List -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-users me-2"></i>Students ({{ student_count }})</h6>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#studentListModal">
                        View All
                    </button>
                </div>
                <div class="card-body">
                    <div class="student-list">
                        {% for student in students|slice:":5" %}
                        <div class="student-item">
                            <div class="d-flex align-items-center">
                                <div class="student-avatar me-3" 
                                     style="background-color: {{ student.color }}; color: white;">
                                    {{ student.initials }}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{{ student.name }}</h6>
                                    <small class="text-muted">{{ student.roll_number }}</small>
                                </div>
                                <span class="badge bg-{{ student.attendance_status }}">{{ student.attendance }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if students|length > 5 %}
                    <div class="text-center mt-3">
                        <a href="#" class="btn btn-sm btn-link" data-bs-toggle="modal" data-bs-target="#studentListModal">
                            View {{ students|length|add:"-5" }} more students
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-4 action-menu">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="takeDailyAttendance()">
                            <i class="fas fa-clipboard-list me-2"></i>Take Today's Attendance
                        </button>
                        <button class="btn btn-outline-success" onclick="addLessonPlan()">
                            <i class="fas fa-book-open me-2"></i>Add Lesson Plan
                        </button>
                        <button class="btn btn-outline-info" onclick="sendClassAnnouncement()">
                            <i class="fas fa-bullhorn me-2"></i>Send Announcement
                        </button>
                        <button class="btn btn-outline-warning" onclick="scheduleMakeupClass()">
                            <i class="fas fa-calendar-plus me-2"></i>Schedule Make-up
                        </button>
                        <a href="{% url 'teacher_timetable_view' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-calendar-alt me-2"></i>My Weekly Schedule
                        </a>
                    </div>
                </div>
            </div>

            <!-- Class Notes -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Class Notes</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="addNote()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="classNotes">
                        {% for note in class_notes %}
                        <div class="resource-card mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="mb-1">{{ note.title }}</h6>
                                <small class="text-muted">{{ note.date|date:"d M" }}</small>
                            </div>
                            <p class="mb-1 small">{{ note.content }}</p>
                            <small class="text-muted">By {{ note.author }}</small>
                        </div>
                        {% empty %}
                        <p class="text-muted text-center mb-0">No notes yet</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Period Details Modal -->
<div class="modal fade" id="periodDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Period Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Period:</strong>
                    <p id="detailPeriod" class="mb-2"></p>
                </div>
                <div class="mb-3">
                    <strong>Subject:</strong>
                    <p id="detailSubject" class="mb-2"></p>
                </div>
                <div class="mb-3">
                    <strong>Teacher:</strong>
                    <p id="detailTeacher" class="mb-2"></p>
                </div>
                <div class="mb-3">
                    <strong>Time:</strong>
                    <p id="detailTime" class="mb-2"></p>
                </div>
                <div class="mb-3">
                    <strong>Classroom:</strong>
                    <p id="detailClassroom" class="mb-2"></p>
                </div>
                <div class="mb-3">
                    <strong>Students:</strong>
                    <p class="mb-2">{{ student_count }} students</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="takeAttendanceFromModal()">Take Attendance</button>
            </div>
        </div>
    </div>
</div>

<!-- Student List Modal -->
<div class="modal fade" id="studentListModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Class Students</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Roll No.</th>
                                <th>Name</th>
                                <th>Attendance</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr>
                                <td>{{ student.roll_number }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="student-avatar me-2" 
                                             style="background-color: {{ student.color }}; color: white;">
                                            {{ student.initials }}
                                        </div>
                                        {{ student.name }}
                                    </div>
                                </td>
                                <td>{{ student.attendance_percentage }}%</td>
                                <td>
                                    <span class="badge bg-{{ student.status_color }}">
                                        {{ student.status }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" 
                                            onclick="viewStudentProfile('{{ student.id }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning"
                                            onclick="sendMessage('{{ student.id }}')">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportStudentList()">
                    <i class="fas fa-download me-2"></i>Export List
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Modal -->
<div class="modal fade" id="attendanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Take Attendance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="attendanceContent">
                    <!-- Attendance form will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAttendance">Save Attendance</button>
            </div>
        </div>
    </div>
</div>

<!-- Resource Modal -->
<div class="modal fade" id="resourceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="resourceForm">
                    <div class="mb-3">
                        <label class="form-label">Resource Type</label>
                        <select class="form-select" id="resourceType">
                            <option value="document">Document</option>
                            <option value="link">Link</option>
                            <option value="assignment">Assignment</option>
                            <option value="note">Note</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="resourceTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="resourceDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3" id="fileUploadSection">
                        <label class="form-label">File</label>
                        <input type="file" class="form-control" id="resourceFile">
                    </div>
                    <div class="mb-3" id="linkSection" style="display: none;">
                        <label class="form-label">URL</label>
                        <input type="url" class="form-control" id="resourceUrl">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Share with</label>
                        <select class="form-select" id="resourceShare">
                            <option value="class">Entire Class</option>
                            <option value="students">Students Only</option>
                            <option value="teachers">Teachers Only</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveResource">Add Resource</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentPeriodId = null;
    let currentResourceType = null;

    // Toggle breaks visibility
    let breaksVisible = true;
    $('#toggleBreaks').click(function() {
        breaksVisible = !breaksVisible;
        $('.break-period').toggle(breaksVisible);
        $(this).html(
            breaksVisible 
                ? '<i class="fas fa-eye-slash me-1"></i>Hide Breaks'
                : '<i class="fas fa-eye me-1"></i>Show Breaks'
        );
    });

    // Period details modal
    $('#periodDetailsModal').on('show.bs.modal', function(event) {
        const button = $(event.relatedTarget);
        const period = button.data('period');
        const subject = button.data('subject');
        const teacher = button.data('teacher');
        const classroom = button.data('classroom');
        const time = button.data('time');

        $('#detailPeriod').text(`Period ${period}`);
        $('#detailSubject').text(subject);
        $('#detailTeacher').text(teacher);
        $('#detailTime').text(time);
        $('#detailClassroom').text(classroom || 'Not specified');
    });

    // Resource type toggle
    $('#resourceType').change(function() {
        const type = $(this).val();
        if (type === 'link') {
            $('#fileUploadSection').hide();
            $('#linkSection').show();
        } else {
            $('#fileUploadSection').show();
            $('#linkSection').hide();
        }
    });

    // Save resource
    $('#saveResource').click(function() {
        const resourceData = {
            type: $('#resourceType').val(),
            title: $('#resourceTitle').val(),
            description: $('#resourceDescription').val(),
            share: $('#resourceShare').val(),
            periodId: currentPeriodId,
            classId: '{{ timetable.class_level }}'
        };

        if ($('#resourceType').val() === 'link') {
            resourceData.url = $('#resourceUrl').val();
        } else if ($('#resourceFile')[0].files[0]) {
            resourceData.file = $('#resourceFile')[0].files[0];
        }

        // Save resource via AJAX
        $.ajax({
            url: '{% url "add_class_resource" %}',
            type: 'POST',
            data: resourceData,
            processData: false,
            contentType: false,
            beforeSend: function(xhr) {
                xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
            },
            success: function(response) {
                showToast('Resource added successfully!', 'success');
                $('#resourceModal').modal('hide');
                loadResources();
            },
            error: function() {
                showToast('Error adding resource', 'error');
            }
        });
    });

    // Share timetable
    $('#shareTimetableBtn').click(function() {
        const shareUrl = `${window.location.origin}{% url 'teacher_timetable_detail' timetable.pk %}`;
        const shareText = `Check out our class timetable for {{ timetable.get_class_level_display }} - {{ timetable.get_day_of_week_display }}`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Class Timetable',
                text: shareText,
                url: shareUrl
            });
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(`${shareText}\n${shareUrl}`).then(() => {
                showToast('Timetable link copied to clipboard!', 'success');
            });
        }
    });

    // Initialize current period highlighting
    highlightCurrentPeriod();
    setInterval(highlightCurrentPeriod, 60000);

    // Load resources
    loadResources();
});

function highlightCurrentPeriod() {
    const now = new Date();
    const currentTime = now.getHours() * 60 + now.getMinutes();
    
    $('.period-card-teacher').each(function() {
        const timeText = $(this).find('.period-time-badge').text();
        const [startStr, endStr] = timeText.split(' - ');
        
        if (startStr && endStr) {
            const startTime = convertTimeToMinutes(startStr.trim());
            const endTime = convertTimeToMinutes(endStr.trim());
            
            $(this).removeClass('current');
            $(this).find('.timeline-marker').removeClass('current');
            
            if (currentTime >= startTime && currentTime <= endTime) {
                $(this).addClass('current');
                $(this).find('.timeline-marker').addClass('current');
            }
        }
    });
}

function convertTimeToMinutes(timeStr) {
    const [time, modifier] = timeStr.split(' ');
    let [hours, minutes] = time.split(':').map(Number);
    
    if (modifier === 'PM' && hours < 12) hours += 12;
    if (modifier === 'AM' && hours === 12) hours = 0;
    
    return hours * 60 + minutes;
}

function takeAttendance(periodId) {
    currentPeriodId = periodId;
    
    $.ajax({
        url: `{% url 'get_attendance_form' %}`,
        data: {
            period_id: periodId,
            class_level: '{{ timetable.class_level }}',
            date: new Date().toISOString().split('T')[0]
        },
        success: function(response) {
            $('#attendanceContent').html(response.form);
            $('#attendanceModal').modal('show');
        }
    });
}

function takeAttendanceFromModal() {
    $('#periodDetailsModal').modal('hide');
    const periodElement = $('.period-card-teacher.current');
    if (periodElement.length) {
        const periodId = periodElement.data('period-id');
        takeAttendance(periodId);
    }
}

function takeDailyAttendance() {
    // Take attendance for all periods today
    const periods = [];
    $('.period-card-teacher:not(.break-period)').each(function() {
        periods.push($(this).data('period-id'));
    });
    
    if (periods.length > 0) {
        showToast(`Taking attendance for ${periods.length} periods today`, 'info');
        // Implementation would involve a bulk attendance form
    } else {
        showToast('No classes scheduled today', 'warning');
    }
}

function addResource(periodId, subject) {
    currentPeriodId = periodId;
    currentResourceType = subject;
    
    if (periodId) {
        $('#resourceTitle').val(`Resources for ${subject} - Period ${periodId}`);
    } else {
        $('#resourceTitle').val(`Class Resources for ${subject}`);
    }
    
    $('#resourceModal').modal('show');
}

function addLessonPlan() {
    window.location.href = `{% url 'add_lesson_plan' timetable.pk %}`;
}

function sendClassAnnouncement() {
    const announcement = prompt('Enter announcement for the class:');
    if (announcement) {
        $.ajax({
            url: '{% url "send_class_announcement" %}',
            type: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                class_level: '{{ timetable.class_level }}',
                announcement: announcement
            },
            success: function() {
                showToast('Announcement sent successfully!', 'success');
            }
        });
    }
}

function scheduleMakeupClass() {
    // Implementation for scheduling makeup classes
    showToast('Make-up class scheduling feature coming soon!', 'info');
}

function addNote() {
    const note = prompt('Add a class note:');
    if (note) {
        $.ajax({
            url: '{% url "add_class_note" %}',
            type: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                timetable_id: {{ timetable.pk }},
                note: note
            },
            success: function(response) {
                $('#classNotes').prepend(`
                    <div class="resource-card mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-1">Note</h6>
                            <small class="text-muted">Just now</small>
                        </div>
                        <p class="mb-1 small">${note}</p>
                        <small class="text-muted">By You</small>
                    </div>
                `);
                showToast('Note added!', 'success');
            }
        });
    }
}

function loadResources() {
    $.ajax({
        url: '{% url "get_class_resources" timetable.pk %}',
        success: function(response) {
            if (response.resources.length > 0) {
                let html = '<div class="row">';
                response.resources.forEach(resource => {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="resource-card">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-${resource.icon} text-primary fa-lg me-3 mt-1"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">${resource.title}</h6>
                                        <p class="small text-muted mb-1">${resource.description}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">${resource.date}</small>
                                            <a href="${resource.url}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                $('#resourcesContainer').html(html);
            }
        }
    });
}

function viewStudentProfile(studentId) {
    window.open(`/students/profile/${studentId}/`, '_blank');
}

function sendMessage(studentId) {
    const message = prompt('Enter message for student:');
    if (message) {
        // Send message implementation
        showToast('Message sent!', 'success');
    }
}

function exportStudentList() {
    window.location.href = `{% url "export_student_list" timetable.pk %}`;
}

function showToast(message, type = 'info') {
    const toast = $(`
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `);
    
    $('#toastContainer').append(toast);
    const bsToast = new bootstrap.Toast(toast[0]);
    bsToast.show();
    
    toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
}
</script>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
{% endblock %}