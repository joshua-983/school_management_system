{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Schedule - {{ timetable.get_class_level_display }} - Teacher{% endblock %}

{% block extra_css %}
<style>
.teacher-manage-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.1);
    overflow: hidden;
}

.manage-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
}

.period-manage-card {
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.period-manage-card:hover {
    border-color: #0d6efd;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.period-manage-card.current {
    border-color: #198754;
    background: rgba(25, 135, 84, 0.02);
}

.time-slot-header {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid #0d6efd;
}

.period-details-form {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.form-section {
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e9ecef;
}

.form-section-title {
    font-weight: 600;
    color: #495057;
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.resource-list {
    max-height: 200px;
    overflow-y: auto;
}

.resource-item {
    padding: 10px;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    margin-bottom: 8px;
    background: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.resource-info {
    flex: 1;
}

.resource-actions {
    display: flex;
    gap: 8px;
}

.attendance-summary {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.attendance-stats {
    display: flex;
    justify-content: space-around;
    text-align: center;
    margin-top: 15px;
}

.stat-box {
    padding: 10px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
}

.stat-label {
    font-size: 0.85rem;
    color: #6c757d;
}

.notes-section {
    background: #fff9db;
    border: 1px solid #ffec99;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
}

.empty-period {
    padding: 40px;
    text-align: center;
    color: #6c757d;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    margin: 20px 0;
}

.break-period {
    background: #f8f9fa;
    border: 2px dashed #6c757d;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
}

.break-icon {
    font-size: 2rem;
    color: #6c757d;
    margin-bottom: 15px;
}

.action-buttons {
    position: sticky;
    bottom: 20px;
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
    margin-top: 20px;
    z-index: 100;
}

.quick-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

@media (max-width: 768px) {
    .period-manage-card {
        padding: 15px;
    }
    
    .time-slot-header {
        padding: 12px;
    }
    
    .attendance-stats {
        flex-direction: column;
        gap: 15px;
    }
    
    .action-buttons {
        position: static;
        margin-top: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="teacher-manage-container">
        <div class="manage-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">Manage Class Schedule</h1>
                    <p class="mb-0 opacity-75">
                        {{ timetable.get_class_level_display }} • {{ timetable.get_day_of_week_display }}
                    </p>
                </div>
                <div>
                    <a href="{% url 'teacher_timetable_detail' timetable.pk %}" class="btn btn-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to View
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="p-4">
            <!-- Class Information -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="mb-3">Class Information</h5>
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <strong>Class:</strong>
                                            <p class="mb-0">{{ timetable.get_class_level_display }}</p>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <strong>Day:</strong>
                                            <p class="mb-0">{{ timetable.get_day_of_week_display }}</p>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <strong>Academic Year:</strong>
                                            <p class="mb-0">{{ timetable.academic_year }}</p>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Term:</strong>
                                            <p class="mb-0">Term {{ timetable.term }}</p>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Students:</strong>
                                            <p class="mb-0">{{ student_count }} students</p>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Status:</strong>
                                            <p class="mb-0">
                                                {% if timetable.is_active %}
                                                <span class="badge bg-success">Active</span>
                                                {% else %}
                                                <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <div class="display-6 text-primary mb-2">{{ entries.count }}</div>
                                        <p class="text-muted mb-0">Scheduled Periods</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Management -->
            <div class="row">
                <div class="col-12">
                    <h4 class="mb-4">Daily Schedule Management</h4>
                    
                    {% if timeslots %}
                        {% for timeslot in timeslots %}
                        <div class="period-manage-card {% if entries|dict_key:timeslot.id.is_current %}current{% endif %}">
                            <!-- Time Slot Header -->
                            <div class="time-slot-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-0">Period {{ timeslot.period_number }}</h5>
                                        <p class="mb-0 text-muted">
                                            {{ timeslot.start_time|time:"g:i A" }} - {{ timeslot.end_time|time:"g:i A" }}
                                        </p>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary">{{ timeslot.duration }} minutes</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Period Content -->
                            {% with entry=entries|dict_key:timeslot.id %}
                            {% if entry %}
                                {% if entry.is_break %}
                                <!-- Break Period -->
                                <div class="break-period">
                                    <div class="break-icon">
                                        <i class="fas fa-coffee"></i>
                                    </div>
                                    <h4>{{ entry.break_name|default:"Break Time" }}</h4>
                                    <p class="text-muted">No teaching during this period</p>
                                </div>
                                {% else %}
                                <!-- Class Period -->
                                <div class="period-details-form">
                                    <!-- Subject & Teacher Info -->
                                    <div class="form-section">
                                        <div class="form-section-title">Class Details</div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Subject</label>
                                                <div class="form-control bg-light">
                                                    <strong>{{ entry.subject.name }}</strong>
                                                    <div class="small text-muted">{{ entry.subject.code }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Teacher</label>
                                                <div class="form-control bg-light">
                                                    <strong>{{ entry.teacher.get_full_name }}</strong>
                                                    <div class="small text-muted">{{ entry.teacher.department|default:"Teacher" }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Classroom</label>
                                                <div class="form-control bg-light">
                                                    {{ entry.classroom|default:"Not specified" }}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Duration</label>
                                                <div class="form-control bg-light">
                                                    {{ timeslot.duration }} minutes
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Attendance Summary -->
                                    <div class="form-section">
                                        <div class="form-section-title">Attendance</div>
                                        <div class="attendance-summary">
                                            <div class="attendance-stats">
                                                <div class="stat-box">
                                                    <div class="stat-value text-success">{{ entry.attendance_present|default:0 }}</div>
                                                    <div class="stat-label">Present</div>
                                                </div>
                                                <div class="stat-box">
                                                    <div class="stat-value text-danger">{{ entry.attendance_absent|default:0 }}</div>
                                                    <div class="stat-label">Absent</div>
                                                </div>
                                                <div class="stat-box">
                                                    <div class="stat-value text-warning">{{ entry.attendance_late|default:0 }}</div>
                                                    <div class="stat-label">Late</div>
                                                </div>
                                                <div class="stat-box">
                                                    <div class="stat-value text-primary">{{ entry.attendance_percentage|default:0 }}%</div>
                                                    <div class="stat-label">Attendance</div>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <a href="#" class="btn btn-sm btn-success" onclick="takeAttendance('{{ entry.id }}')">
                                                    <i class="fas fa-clipboard-check me-2"></i>Take Attendance
                                                </a>
                                                <a href="#" class="btn btn-sm btn-outline-info" onclick="viewAttendanceReport('{{ entry.id }}')">
                                                    <i class="fas fa-chart-bar me-2"></i>View Report
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Resources -->
                                    <div class="form-section">
                                        <div class="form-section-title">Teaching Resources</div>
                                        <div class="resource-list">
                                            {% if entry.resources %}
                                                {% for resource in entry.resources|slice:":3" %}
                                                <div class="resource-item">
                                                    <div class="resource-info">
                                                        <h6 class="mb-1">{{ resource.title }}</h6>
                                                        <small class="text-muted">{{ resource.type }} • {{ resource.date }}</small>
                                                    </div>
                                                    <div class="resource-actions">
                                                        <button class="btn btn-sm btn-outline-primary" 
                                                                onclick="viewResource('{{ resource.id }}')">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-success"
                                                                onclick="shareResource('{{ resource.id }}')">
                                                            <i class="fas fa-share"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <p class="text-muted text-center py-3">No resources added yet</p>
                                            {% endif %}
                                        </div>
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-primary" onclick="addResource('{{ entry.id }}')">
                                                <i class="fas fa-plus me-2"></i>Add Resource
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="viewAllResources('{{ entry.id }}')">
                                                View All Resources
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Notes -->
                                    <div class="notes-section">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">Teacher's Notes</h6>
                                            <button class="btn btn-sm btn-outline-warning" onclick="addNote('{{ entry.id }}')">
                                                <i class="fas fa-plus"></i> Add Note
                                            </button>
                                        </div>
                                        {% if entry.notes %}
                                            <p class="mb-0">{{ entry.notes|truncatechars:200 }}</p>
                                        {% else %}
                                            <p class="text-muted mb-0">No notes added for this period</p>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Quick Actions -->
                                    <div class="quick-actions mt-3">
                                        <button class="btn btn-sm btn-outline-info" onclick="viewPeriodAnalytics('{{ entry.id }}')">
                                            <i class="fas fa-chart-line me-1"></i>Analytics
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="sendClassAnnouncement('{{ entry.id }}')">
                                            <i class="fas fa-bullhorn me-1"></i>Announcement
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="scheduleMakeup('{{ entry.id }}')">
                                            <i class="fas fa-calendar-plus me-1"></i>Schedule Makeup
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="reportIssue('{{ entry.id }}')">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Report Issue
                                        </button>
                                    </div>
                                </div>
                                {% endif %}
                            {% else %}
                            <!-- Empty Period -->
                            <div class="empty-period">
                                <i class="fas fa-clock fa-3x mb-3"></i>
                                <h4>No Class Scheduled</h4>
                                <p class="text-muted">This time slot is currently empty</p>
                                <div class="mt-3">
                                    {% if is_admin %}
                                    <a href="{% url 'timetable_manage' timetable.pk %}" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>Add Class
                                    </a>
                                    {% endif %}
                                    <button class="btn btn-outline-secondary" onclick="suggestPeriod('{{ timeslot.id }}')">
                                        <i class="fas fa-lightbulb me-2"></i>Get Suggestions
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                            {% endwith %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="empty-period">
                        <i class="fas fa-calendar-times fa-3x mb-3"></i>
                        <h4>No Time Slots Configured</h4>
                        <p class="text-muted">Please contact administrator to set up time slots</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button class="btn btn-outline-primary" onclick="printSchedule()">
                            <i class="fas fa-print me-2"></i>Print Schedule
                        </button>
                        <button class="btn btn-outline-success" onclick="exportToCalendar()">
                            <i class="fas fa-calendar-plus me-2"></i>Export to Calendar
                        </button>
                        <button class="btn btn-outline-info" onclick="shareSchedule()">
                            <i class="fas fa-share-alt me-2"></i>Share with Class
                        </button>
                    </div>
                    <div>
                        <a href="{% url 'teacher_timetable_detail' timetable.pk %}" class="btn btn-secondary">
                            Cancel
                        </a>
                        {% if is_admin %}
                        <a href="{% url 'timetable_manage' timetable.pk %}" class="btn btn-primary">
                            <i class="fas fa-edit me-2"></i>Edit in Admin Mode
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resource Modal -->
<div class="modal fade" id="resourceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Teaching Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="resourceForm">
                    <div class="mb-3">
                        <label class="form-label">Resource Type</label>
                        <select class="form-select" id="resourceType">
                            <option value="document">Document</option>
                            <option value="presentation">Presentation</option>
                            <option value="video">Video</option>
                            <option value="link">Link</option>
                            <option value="assignment">Assignment</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="resourceTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="resourceDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Upload File</label>
                        <input type="file" class="form-control" id="resourceFile">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Share With</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shareStudents" checked>
                            <label class="form-check-label" for="shareStudents">
                                Students
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shareParents">
                            <label class="form-check-label" for="shareParents">
                                Parents
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveResourceBtn">Save Resource</button>
            </div>
        </div>
    </div>
</div>

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <div class="mb-3">
                        <label class="form-label">Note Type</label>
                        <select class="form-select" id="noteType">
                            <option value="general">General Note</option>
                            <option value="reminder">Reminder</option>
                            <option value="issue">Issue to Address</option>
                            <option value="achievement">Student Achievement</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea class="form-control" id="noteContent" rows="5" required></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="notePrivate">
                        <label class="form-check-label" for="notePrivate">
                            Private Note (Visible only to you)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNoteBtn">Save Note</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentReady', function() {
    let currentEntryId = null;
    
    // Resource modal
    document.getElementById('saveResourceBtn').addEventListener('click', function() {
        saveResource();
    });
    
    // Note modal
    document.getElementById('saveNoteBtn').addEventListener('click', function() {
        saveNote();
    });
});

function takeAttendance(entryId) {
    window.location.href = `/attendance/take/${entryId}/`;
}

function viewAttendanceReport(entryId) {
    window.location.href = `/attendance/report/${entryId}/`;
}

function addResource(entryId) {
    currentEntryId = entryId;
    const modal = new bootstrap.Modal(document.getElementById('resourceModal'));
    modal.show();
}

function saveResource() {
    const resourceData = {
        entry_id: currentEntryId,
        type: document.getElementById('resourceType').value,
        title: document.getElementById('resourceTitle').value,
        description: document.getElementById('resourceDescription').value,
        share_students: document.getElementById('shareStudents').checked,
        share_parents: document.getElementById('shareParents').checked
    };
    
    const fileInput = document.getElementById('resourceFile');
    if (fileInput.files.length > 0) {
        resourceData.file = fileInput.files[0];
    }
    
    // Save via AJAX
    const formData = new FormData();
    for (const key in resourceData) {
        formData.append(key, resourceData[key]);
    }
    
    fetch('{% url "add_teaching_resource" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('resourceModal')).hide();
            showToast('Resource added successfully!', 'success');
            // Refresh the resource list
            location.reload();
        }
    });
}

function addNote(entryId) {
    currentEntryId = entryId;
    const modal = new bootstrap.Modal(document.getElementById('noteModal'));
    modal.show();
}

function saveNote() {
    const noteData = {
        entry_id: currentEntryId,
        type: document.getElementById('noteType').value,
        content: document.getElementById('noteContent').value,
        is_private: document.getElementById('notePrivate').checked
    };
    
    fetch('{% url "add_period_note" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(noteData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
            showToast('Note saved successfully!', 'success');
            location.reload();
        }
    });
}

function viewResource(resourceId) {
    window.location.href = `/resources/view/${resourceId}/`;
}

function shareResource(resourceId) {
    // Implement sharing functionality
    showToast('Share functionality coming soon!', 'info');
}

function viewAllResources(entryId) {
    window.location.href = `/resources/entry/${entryId}/`;
}

function viewPeriodAnalytics(entryId) {
    window.location.href = `/analytics/period/${entryId}/`;
}

function sendClassAnnouncement(entryId) {
    const announcement = prompt('Enter announcement for this class:');
    if (announcement) {
        fetch('{% url "send_class_announcement" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                entry_id: entryId,
                announcement: announcement
            })
        })
        .then(() => {
            showToast('Announcement sent!', 'success');
        });
    }
}

function scheduleMakeup(entryId) {
    // Redirect to makeup scheduling page
    window.location.href = `/makeup/schedule/${entryId}/`;
}

function reportIssue(entryId) {
    window.location.href = `/issues/report/${entryId}/`;
}

function suggestPeriod(timeslotId) {
    fetch(`{% url "get_period_suggestions" %}?timeslot_id=${timeslotId}&class_level={{ timetable.class_level }}`)
        .then(response => response.json())
        .then(data => {
            if (data.suggestions.length > 0) {
                showSuggestionsModal(data.suggestions, timeslotId);
            } else {
                showToast('No suggestions available', 'info');
            }
        });
}

function showSuggestionsModal(suggestions, timeslotId) {
    // Create and show suggestions modal
    const modalHtml = `
        <div class="modal fade" id="suggestionsModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Period Suggestions</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="list-group">
                            ${suggestions.map(suggestion => `
                                <div class="list-group-item">
                                    <h6>${suggestion.subject}</h6>
                                    <small class="text-muted">Teacher: ${suggestion.teacher}</small>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-primary" onclick="applySuggestion(${timeslotId}, ${suggestion.id})">
                                            Apply This
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('suggestionsModal'));
    modal.show();
}

function applySuggestion(timeslotId, suggestionId) {
    fetch('{% url "apply_period_suggestion" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            timeslot_id: timeslotId,
            suggestion_id: suggestionId,
            timetable_id: {{ timetable.pk }}
        })
    })
    .then(() => {
        showToast('Suggestion applied!', 'success');
        location.reload();
    });
}

function printSchedule() {
    window.print();
}

function exportToCalendar() {
    // Export schedule to calendar
    fetch(`{% url "export_timetable_calendar" timetable.pk %}`)
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'class-schedule.ics';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        });
}

function shareSchedule() {
    const shareUrl = `${window.location.origin}{% url 'teacher_timetable_detail' timetable.pk %}`;
    const shareText = `Class schedule for {{ timetable.get_class_level_display }} - {{ timetable.get_day_of_week_display }}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Class Schedule',
            text: shareText,
            url: shareUrl
        });
    } else {
        navigator.clipboard.writeText(`${shareText}\n${shareUrl}`).then(() => {
            showToast('Schedule link copied to clipboard!', 'success');
        });
    }
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    const container = document.getElementById('toastContainer') || createToastContainer();
    container.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}
</script>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- Print Styles -->
<style media="print">
@media print {
    .navbar, .sidebar, .btn, .action-buttons, .modal, .toast-container {
        display: none !important;
    }
    
    .teacher-manage-container {
        box-shadow: none !important;
    }
    
    .manage-header {
        background: white !important;
        color: black !important;
        border-bottom: 2px solid #000 !important;
    }
    
    .period-manage-card {
        break-inside: avoid;
        border: 1px solid #000 !important;
    }
    
    body {
        padding: 20px !important;
    }
}
</style>
{% endblock %}