{% extends 'base.html' %}
{% load static %}
{% load timetable_filters %}

{% block title %}Timetable Details - {{ timetable.get_class_level_display }} - {{ timetable.get_day_of_week_display }}{% endblock %}

{% block extra_css %}
<style>
.timetable-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px 15px 0 0;
}
.period-card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    transition: all 0.3s ease;
    margin-bottom: 10px;
}
.period-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-color: #0d6efd;
}
.break-period {
    background: #f8f9fa;
    border-left: 4px solid #6c757d;
}
.class-period {
    background: white;
    border-left: 4px solid #0d6efd;
}
.period-time {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
}
.period-subject {
    font-weight: 600;
    color: #212529;
}
.period-teacher {
    font-size: 0.9rem;
    color: #495057;
}
.period-classroom {
    font-size: 0.8rem;
    color: #6c757d;
    background: #f1f3f4;
    padding: 2px 8px;
    border-radius: 12px;
    display: inline-block;
}
.stat-card {
    border: none;
    border-radius: 10px;
    overflow: hidden;
}
.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}
.day-badge {
    font-size: 2rem;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
}
.class-badge {
    font-size: 1.2rem;
    padding: 8px 20px;
    border-radius: 25px;
}
.empty-schedule {
    padding: 3rem;
    text-align: center;
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    background: #f8f9fa;
}
.time-slot-header {
    background: #f1f3f4;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-weight: 600;
    color: #5f6368;
}
.qr-code-container {
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
}
.action-btn {
    min-width: 120px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card timetable-header">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="day-badge bg-primary me-4">
                                    {{ timetable.day_of_week|add:"1" }}
                                </div>
                                <div>
                                    <h1 class="h2 mb-1">{{ timetable.get_class_level_display }}</h1>
                                    <div class="d-flex align-items-center flex-wrap gap-2">
                                        <span class="class-badge bg-white text-dark">
                                            {{ timetable.get_day_of_week_display }}
                                        </span>
                                        <span class="badge bg-light text-dark">
                                            <i class="fas fa-calendar-alt me-1"></i>{{ timetable.academic_year }}
                                        </span>
                                        <span class="badge bg-light text-dark">
                                            <i class="fas fa-layer-group me-1"></i>Term {{ timetable.term }}
                                        </span>
                                        {% if timetable.is_active %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Active
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-times-circle me-1"></i>Inactive
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                            <div class="btn-group">
                                <a href="{% url 'admin_timetable_list' %}" class="btn btn-light">
                                    <i class="fas fa-arrow-left me-2"></i>Back
                                </a>
                                <a href="{% url 'admin_timetable_manage' timetable.pk %}" class="btn btn-warning">
                                    <i class="fas fa-edit me-2"></i>Edit Schedule
                                </a>
                                <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#printModal">
                                            <i class="fas fa-print me-2"></i>Print
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'admin_print_timetable' timetable.pk %}" target="_blank">
                                            <i class="fas fa-file-pdf me-2"></i>Export PDF
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" id="shareBtn">
                                            <i class="fas fa-share-alt me-2"></i>Share
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="{% url 'admin_timetable_delete' timetable.pk %}">
                                            <i class="fas fa-trash me-2"></i>Delete
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-start border-primary border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total Periods</h6>
                            <h3 class="mb-0">{{ entries.count }}</h3>
                        </div>
                        <div class="stat-icon bg-primary">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-start border-success border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Class Periods</h6>
                            <h3 class="mb-0">{{ class_periods }}</h3>
                        </div>
                        <div class="stat-icon bg-success">
                            <i class="fas fa-chalkboard text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-start border-info border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Break Periods</h6>
                            <h3 class="mb-0">{{ break_periods }}</h3>
                        </div>
                        <div class="stat-icon bg-info">
                            <i class="fas fa-coffee text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-start border-warning border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Duration</h6>
                            <h3 class="mb-0">{{ total_hours }}h</h3>
                        </div>
                        <div class="stat-icon bg-warning">
                            <i class="fas fa-hourglass-half text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Schedule Column -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Daily Schedule</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="toggleBreakPeriods">
                            <i class="fas fa-eye-slash me-1"></i>Hide Breaks
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" id="printSchedule">
                            <i class="fas fa-print me-1"></i>Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if entries %}
                        {% for timeslot in timeslots %}
                            <div class="time-slot-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Period {{ timeslot.period_number }}</span>
                                    <span class="period-time">
                                        {{ timeslot.start_time|time:"g:i A" }} - {{ timeslot.end_time|time:"g:i A" }}
                                    </span>
                                </div>
                            </div>
                            
                            {% with entry=entries|get_item:timeslot.id %}
                            {% if entry %}
                                <div class="period-card {% if entry.is_break %}break-period{% else %}class-period{% endif %}" 
                                     data-entry-id="{{ entry.id }}">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-md-1">
                                                <span class="badge bg-secondary rounded-pill">#{{ timeslot.period_number }}</span>
                                            </div>
                                            <div class="col-md-7">
                                                {% if entry.is_break %}
                                                    <h6 class="period-subject mb-1">
                                                        <i class="fas fa-coffee me-2"></i>{{ entry.break_name|default:"Break" }}
                                                    </h6>
                                                    <div class="period-teacher">Break Time</div>
                                                {% else %}
                                                    <h6 class="period-subject mb-1">
                                                        <i class="fas fa-book me-2"></i>{{ entry.subject.name }}
                                                    </h6>
                                                    <div class="period-teacher">
                                                        <i class="fas fa-user-tie me-1"></i>{{ entry.teacher.get_full_name }}
                                                    </div>
                                                    {% if entry.classroom %}
                                                    <div class="mt-2">
                                                        <span class="period-classroom">
                                                            <i class="fas fa-door-open me-1"></i>{{ entry.classroom }}
                                                        </span>
                                                    </div>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <div class="btn-group">
                                                    {% if not entry.is_break %}
                                                    <button class="btn btn-sm btn-outline-info" 
                                                            data-bs-toggle="popover"
                                                            title="{{ entry.subject.name }} Details"
                                                            data-bs-content="
                                                                <strong>Subject:</strong> {{ entry.subject.name }}<br>
                                                                <strong>Teacher:</strong> {{ entry.teacher.get_full_name }}<br>
                                                                <strong>Classroom:</strong> {{ entry.classroom|default:'Not specified' }}<br>
                                                                <strong>Time:</strong> {{ timeslot.start_time|time:'g:i A' }} - {{ timeslot.end_time|time:'g:i A' }}
                                                            ">
                                                        <i class="fas fa-info-circle"></i>
                                                    </button>
                                                    {% endif %}
                                                    <a href="{% url 'admin_timetable_manage' timetable.pk %}" class="btn btn-sm btn-outline-warning">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="empty-schedule">
                                    <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                                    <h5>No Class Scheduled</h5>
                                    <p class="text-muted">This time slot is currently empty</p>
                                    <a href="{% url 'admin_timetable_manage' timetable.pk %}" class="btn btn-primary mt-2">
                                        <i class="fas fa-plus me-2"></i>Add Period
                                    </a>
                                </div>
                            {% endif %}
                            {% endwith %}
                        {% endfor %}
                    {% else %}
                        <div class="empty-schedule">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h4>No Schedule Created</h4>
                            <p class="text-muted">This timetable doesn't have any periods scheduled yet.</p>
                            <a href="{% url 'admin_timetable_manage' timetable.pk %}" class="btn btn-primary btn-lg mt-3">
                                <i class="fas fa-calendar-plus me-2"></i>Create Schedule
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar Column -->
        <div class="col-lg-4">
            <!-- Teacher Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-user-tie me-2"></i>Teachers Today</h6>
                </div>
                <div class="card-body">
                    {% if teachers_today %}
                        <div class="list-group list-group-flush">
                            {% for teacher in teachers_today %}
                            <div class="list-group-item d-flex align-items-center">
                                <div class="avatar avatar-sm me-3">
                                    {% if teacher.user.profile_picture %}
                                    <img src="{{ teacher.user.profile_picture.url }}" class="rounded-circle" width="40">
                                    {% else %}
                                    <div class="avatar-initials bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        {{ teacher.user.first_name|first }}{{ teacher.user.last_name|first }}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{{ teacher.user.get_full_name }}</h6>
                                    <small class="text-muted">
                                        {% for subject in teacher.subjects_today %}
                                            {{ subject }}{% if not forloop.last %}, {% endif %}
                                        {% endfor %}
                                    </small>
                                </div>
                                <span class="badge bg-info">{{ teacher.period_count }} periods</span>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No teachers scheduled today.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'admin_timetable_manage' timetable.pk %}" class="btn btn-primary action-btn">
                            <i class="fas fa-calendar-alt me-2"></i>Manage Schedule
                        </a>
                        <a href="{% url 'timetable_update' timetable.pk %}" class="btn btn-outline-primary action-btn">
                            <i class="fas fa-cog me-2"></i>Edit Details
                        </a>
                        <button class="btn btn-outline-success action-btn" id="copyTimetableBtn">
                            <i class="fas fa-copy me-2"></i>Copy to Another Day
                        </button>
                        <button class="btn btn-outline-info action-btn" id="shareLinkBtn">
                            <i class="fas fa-link me-2"></i>Copy Share Link
                        </button>
                    </div>
                </div>
            </div>

            <!-- QR Code -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-qrcode me-2"></i>Quick Access</h6>
                </div>
                <div class="card-body">
                    <div class="qr-code-container">
                        <div id="qrcode"></div>
                        <p class="mt-3 mb-0 small text-muted">Scan to view timetable</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Modal -->
<div class="modal fade" id="printModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Print Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Print Format</label>
                    <select class="form-select" id="printFormat">
                        <option value="detailed">Detailed View</option>
                        <option value="compact">Compact View</option>
                        <option value="teacher">Teacher View</option>
                        <option value="student">Student View</option>
                    </select>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeBreaks" checked>
                    <label class="form-check-label" for="includeBreaks">
                        Include break periods
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="includeQr" checked>
                    <label class="form-check-label" for="includeQr">
                        Include QR code
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="printNowBtn">Print Now</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/qrcode.min.js"></script>
<script>
$(document).ready(function() {
    // Calculate statistics
    const classPeriods = {{ class_periods }};
    const breakPeriods = {{ break_periods }};
    
    // Initialize QR Code
    const qrcode = new QRCode(document.getElementById("qrcode"), {
        text: window.location.href,
        width: 128,
        height: 128,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });

    // Toggle break periods
    let breaksVisible = true;
    $('#toggleBreakPeriods').click(function() {
        breaksVisible = !breaksVisible;
        $('.break-period').toggle(breaksVisible);
        $(this).html(
            breaksVisible 
                ? '<i class="fas fa-eye-slash me-1"></i>Hide Breaks'
                : '<i class="fas fa-eye me-1"></i>Show Breaks'
        );
    });

    // Print functionality
    $('#printNowBtn').click(function() {
        const format = $('#printFormat').val();
        const includeBreaks = $('#includeBreaks').is(':checked');
        const includeQr = $('#includeQr').is(':checked');
        
        // Add print-specific classes
        $('body').addClass('print-mode');
        if (!includeBreaks) $('.break-period').hide();
        
        // Print the page
        window.print();
        
        // Clean up
        $('body').removeClass('print-mode');
        if (!includeBreaks) $('.break-period').show();
        
        // Close modal
        $('#printModal').modal('hide');
    });

    // Copy timetable to another day
    $('#copyTimetableBtn').click(function() {
        const scheduleData = [];
        $('.period-card').each(function() {
            const entryId = $(this).data('entry-id');
            if (entryId) {
                const card = $(this);
                const isBreak = card.hasClass('break-period');
                const subject = card.find('.period-subject').text().trim();
                const teacher = card.find('.period-teacher').text().trim();
                scheduleData.push({ isBreak, subject, teacher });
            }
        });
        
        // Store in session storage for use in copy page
        sessionStorage.setItem('timetableToCopy', JSON.stringify(scheduleData));
        
        // Redirect to copy page
        window.location.href = `{% url 'admin_timetable_list' %}?copy_from={{ timetable.pk }}`;
    });

    // Share functionality
    $('#shareBtn').click(function() {
        if (navigator.share) {
            navigator.share({
                title: 'Timetable: {{ timetable.get_class_level_display }} - {{ timetable.get_day_of_week_display }}',
                text: 'Check out this timetable',
                url: window.location.href
            });
        } else {
            $('#shareLinkBtn').click();
        }
    });

    // Copy share link
    $('#shareLinkBtn').click(function() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(function() {
            showToast('Link copied to clipboard!', 'success');
        }, function() {
            // Fallback for older browsers
            const tempInput = $('<input>');
            $('body').append(tempInput);
            tempInput.val(url).select();
            document.execCommand('copy');
            tempInput.remove();
            showToast('Link copied to clipboard!', 'success');
        });
    });

    // Print schedule button
    $('#printSchedule').click(function() {
        $('#printModal').modal('show');
    });

    // Initialize popovers
    $('[data-bs-toggle="popover"]').popover({
        trigger: 'hover',
        placement: 'top',
        html: true,
        container: 'body'
    });

    // Highlight current time period
    function highlightCurrentPeriod() {
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();
        
        $('.period-card').each(function() {
            const timeText = $(this).closest('.time-slot-header').find('.period-time').text();
            const [startStr, endStr] = timeText.split(' - ');
            
            // Convert time string to minutes
            const startTime = convertTimeToMinutes(startStr);
            const endTime = convertTimeToMinutes(endStr);
            
            if (currentTime >= startTime && currentTime <= endTime) {
                $(this).addClass('current-period');
                $(this).css({
                    'border-color': '#198754',
                    'box-shadow': '0 0 0 0.25rem rgba(25, 135, 84, 0.25)'
                });
            }
        });
    }

    function convertTimeToMinutes(timeStr) {
        const [time, modifier] = timeStr.trim().split(' ');
        let [hours, minutes] = time.split(':').map(Number);
        
        if (modifier === 'PM' && hours < 12) hours += 12;
        if (modifier === 'AM' && hours === 12) hours = 0;
        
        return hours * 60 + minutes;
    }

    // Run current period highlight
    highlightCurrentPeriod();
    
    // Update every minute
    setInterval(highlightCurrentPeriod, 60000);
});

function showToast(message, type = 'info') {
    const toast = $(`
        <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `);
    
    $('#toastContainer').append(toast);
    const bsToast = new bootstrap.Toast(toast[0]);
    bsToast.show();
    
    toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
}
</script>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- Print Styles -->
<style media="print">
@media print {
    .navbar, .sidebar, .card-header .btn, .action-btn, .dropdown-menu,
    .modal, .toast-container, #toggleBreakPeriods, #printSchedule {
        display: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
    
    .card-header {
        background: white !important;
        color: black !important;
        border-bottom: 2px solid #000 !important;
    }
    
    .timetable-header {
        background: white !important;
        color: black !important;
    }
    
    .day-badge {
        background: #f8f9fa !important;
        color: black !important;
        border: 2px solid #000 !important;
    }
    
    .period-card {
        break-inside: avoid;
    }
    
    body {
        padding: 20px !important;
        font-size: 12pt !important;
    }
    
    h1, h2, h3, h4, h5, h6 {
        color: black !important;
    }
}
</style>
{% endblock %}