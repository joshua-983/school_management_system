{% extends 'base.html' %}

{% block title %}Manage Timetable - {{ timetable.get_class_level_display }} - {{ timetable.get_day_of_week_display }}{% endblock %}

{% block extra_css %}
<style>
    .timeslot-card {
        transition: all 0.2s ease-in-out;
        border: 1px solid #dee2e6;
        border-left: 4px solid #3a7bd5;
    }
    .timeslot-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .break-card {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        border-left-color: #ffc107;
    }
    .teacher-select, .subject-select {
        width: 100%;
    }
    .form-switch .form-check-input {
        width: 3em;
    }
    .collapsed .bi-chevron-down {
        transform: rotate(-90deg);
        transition: transform 0.2s ease-in-out;
    }
    .is-invalid {
        border-color: #dc3545 !important;
    }
    .is-valid {
        border-color: #198754 !important;
    }
    .error-message {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }
    .field-required::after {
        content: " *";
        color: #dc3545;
    }
    .period-time {
        font-weight: 600;
        color: #3a7bd5;
    }
    .break-fields, .class-fields {
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="bi bi-pencil-square me-2"></i>
                    Manage Timetable: {{ timetable.get_class_level_display }} - {{ timetable.get_day_of_week_display }}
                </h2>
                <div class="btn-group">
                    <a href="{% url 'timetable_detail' timetable.pk %}" class="btn btn-outline-primary">
                        <i class="bi bi-eye me-1"></i> View
                    </a>
                    <a href="{% url 'timetable_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i> Back
                    </a>
                </div>
            </div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'timetable_list' %}">Timetables</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'timetable_detail' timetable.pk %}">{{ timetable.get_class_level_display }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Manage</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Timetable Info -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Class Level:</strong>
                            <span class="badge bg-primary">{{ timetable.get_class_level_display }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Day:</strong>
                            <span class="badge bg-secondary">{{ timetable.get_day_of_week_display }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Academic Year:</strong>
                            {{ timetable.academic_year }}
                        </div>
                        <div class="col-md-3">
                            <strong>Term:</strong>
                            Term {{ timetable.term }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="timetableForm" novalidate>
        {% csrf_token %}
        <input type="hidden" name="timetable_id" value="{{ timetable.pk }}">
        
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Daily Schedule Configuration</h5>
                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                data-bs-toggle="collapse" data-bs-target="#helpCollapse">
                            <i class="bi bi-question-circle me-1"></i> Help & Instructions
                        </button>
                    </div>
                    <div class="collapse" id="helpCollapse">
                        <div class="card-body bg-light">
                            <p class="mb-2"><strong>Instructions:</strong></p>
                            <ol class="mb-3">
                                <li>For each time slot, either:
                                    <ul>
                                        <li>Select a subject and teacher for a class period</li>
                                        <li>OR mark as a break period and provide a break name</li>
                                    </ul>
                                </li>
                                <li>Assign classrooms if needed</li>
                                <li>Click "Save All Changes" when finished</li>
                            </ol>
                            <p class="mb-2"><strong>Tips:</strong></p>
                            <ul class="mb-0">
                                <li>Mark periods as breaks for lunch, recess, assemblies, etc.</li>
                                <li>Use descriptive break names like "Morning Assembly" or "Lunch Break"</li>
                                <li>Ensure teachers are not double-booked in the same period</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            {% for timeslot, form in entry_forms %}
            <div class="col-xl-6 col-lg-6 mb-4">
                <div class="card timeslot-card h-100 {% if form.initial.is_break %}break-card{% endif %}" 
                     id="timeslot-{{ timeslot.id }}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-clock me-1"></i>
                            <span class="period-time">{{ timeslot.get_period_number_display }}</span>
                            <small class="text-muted ms-2">
                                ({{ timeslot.start_time|time:"H:i" }} - {{ timeslot.end_time|time:"H:i" }})
                            </small>
                        </h6>
                        {% if timeslot.is_break %}
                        <span class="badge bg-warning">Pre-defined Break</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <!-- Hidden field for existing entry ID -->
                        <input type="hidden" name="entry_{{ timeslot.id }}" value="{{ form.instance.id|default:'' }}">
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input break-toggle" 
                                       type="checkbox" 
                                       name="timeslot_{{ timeslot.id }}_is_break" 
                                       id="break_{{ timeslot.id }}" 
                                       value="true" 
                                       {% if form.initial.is_break %}checked{% endif %}
                                       data-timeslot-id="{{ timeslot.id }}">
                                <label class="form-check-label" for="break_{{ timeslot.id }}">
                                    Mark as break period
                                </label>
                            </div>
                        </div>

                        <!-- BREAK FIELDS -->
                        <div id="break_fields_{{ timeslot.id }}" 
                             class="break-fields" 
                             style="display: {% if form.initial.is_break %}block{% else %}none{% endif %};">
                            <div class="mb-3">
                                <label for="break_name_{{ timeslot.id }}" class="form-label">
                                    Break Name
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       name="timeslot_{{ timeslot.id }}_break_name" 
                                       id="break_name_{{ timeslot.id }}" 
                                       value="{{ form.initial.break_name|default:timeslot.break_name|default:'' }}"
                                       placeholder="e.g., Lunch Break, Morning Recess, Assembly">
                                <div class="form-text">Optional: Name for this break period</div>
                            </div>
                        </div>

                        <!-- CLASS FIELDS -->
                        <div id="class_fields_{{ timeslot.id }}" 
                             class="class-fields" 
                             style="display: {% if form.initial.is_break %}none{% else %}block{% endif %};">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="subject_{{ timeslot.id }}" class="form-label field-required">
                                            Subject
                                        </label>
                                        <select class="form-select subject-select" 
                                                name="timeslot_{{ timeslot.id }}_subject" 
                                                id="subject_{{ timeslot.id }}"
                                                data-timeslot-id="{{ timeslot.id }}">
                                            <option value="">Select Subject</option>
                                            {% for subject in form.fields.subject.queryset %}
                                            <option value="{{ subject.id }}" 
                                                    {% if form.initial.subject.id == subject.id %}selected{% endif %}>
                                                {{ subject.name }} ({{ subject.code }})
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Please select a subject</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="teacher_{{ timeslot.id }}" class="form-label field-required">
                                            Teacher
                                        </label>
                                        <select class="form-select teacher-select" 
                                                name="timeslot_{{ timeslot.id }}_teacher" 
                                                id="teacher_{{ timeslot.id }}"
                                                data-timeslot-id="{{ timeslot.id }}">
                                            <option value="">Select Teacher</option>
                                            {% for teacher in form.fields.teacher.queryset %}
                                            <option value="{{ teacher.id }}" 
                                                    {% if form.initial.teacher.id == teacher.id %}selected{% endif %}>
                                                {{ teacher.get_full_name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Please select a teacher</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="classroom_{{ timeslot.id }}" class="form-label">
                                    Classroom / Location
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       name="timeslot_{{ timeslot.id }}_classroom" 
                                       id="classroom_{{ timeslot.id }}" 
                                       value="{{ form.initial.classroom|default:'' }}"
                                       placeholder="e.g., Room 101, Science Lab, Computer Lab">
                                <div class="form-text">Optional: Classroom or location for this period</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">
                            {% if form.instance.pk %}
                            <i class="bi bi-check-circle text-success me-1"></i> Configured
                            {% else %}
                            <i class="bi bi-clock text-muted me-1"></i> Not configured
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-secondary me-md-2" onclick="resetForm()">
                                <i class="bi bi-arrow-clockwise me-1"></i> Reset
                            </button>
                            <button type="submit" class="btn btn-primary" id="saveButton">
                                <i class="bi bi-check-circle me-1"></i> Save All Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block footer %}

{% endblock %}

{% block extra_js %}
<script>
// Function to toggle between break and class fields
function toggleBreakFields(timeslotId) {
    const isBreak = document.getElementById(`break_${timeslotId}`).checked;
    const breakFields = document.getElementById(`break_fields_${timeslotId}`);
    const classFields = document.getElementById(`class_fields_${timeslotId}`);
    const subjectSelect = document.getElementById(`subject_${timeslotId}`);
    const teacherSelect = document.getElementById(`teacher_${timeslotId}`);
    
    if (isBreak) {
        // Show break fields, hide class fields
        breakFields.style.display = 'block';
        classFields.style.display = 'none';
        
        // Clear and disable validation for class fields
        if (subjectSelect) {
            subjectSelect.value = '';
            subjectSelect.removeAttribute('required');
            subjectSelect.classList.remove('is-invalid', 'is-valid');
        }
        if (teacherSelect) {
            teacherSelect.value = '';
            teacherSelect.removeAttribute('required');
            teacherSelect.classList.remove('is-invalid', 'is-valid');
        }
        
        // Enable break name field
        const breakNameInput = document.getElementById(`break_name_${timeslotId}`);
        if (breakNameInput) {
            breakNameInput.removeAttribute('disabled');
        }
    } else {
        // Show class fields, hide break fields
        breakFields.style.display = 'none';
        classFields.style.display = 'block';
        
        // Enable validation for class fields
        if (subjectSelect) {
            subjectSelect.setAttribute('required', 'required');
        }
        if (teacherSelect) {
            teacherSelect.setAttribute('required', 'required');
        }
        
        // Clear break name field
        const breakNameInput = document.getElementById(`break_name_${timeslotId}`);
        if (breakNameInput) {
            breakNameInput.value = '';
            breakNameInput.setAttribute('disabled', 'disabled');
        }
    }
}

// Function to validate a single field
function validateField(field) {
    field.classList.remove('is-invalid', 'is-valid');
    
    const timeslotId = field.name.split('_')[1];
    const isBreak = document.getElementById(`break_${timeslotId}`)?.checked;
    
    // Skip validation for break-related fields when not in break mode
    if (field.name.includes('break_name')) {
        if (!isBreak) return;
        if (field.value.trim() === '') {
            field.classList.add('is-invalid');
        } else {
            field.classList.add('is-valid');
        }
        return;
    }
    
    // Validate subject and teacher when in class mode
    if ((field.name.includes('subject') || field.name.includes('teacher')) && !isBreak) {
        if (!field.value) {
            field.classList.add('is-invalid');
        } else {
            field.classList.add('is-valid');
        }
    }
}

// Function to check for teacher conflicts
function checkTeacherConflicts() {
    const teacherAssignments = {};
    const conflicts = [];
    
    // Gather all teacher assignments
    document.querySelectorAll('.teacher-select').forEach(select => {
        const teacherId = select.value;
        const timeslotId = select.getAttribute('data-timeslot-id');
        
        if (teacherId && timeslotId) {
            const isBreak = document.getElementById(`break_${timeslotId}`)?.checked;
            
            if (!isBreak) {
                if (!teacherAssignments[teacherId]) {
                    teacherAssignments[teacherId] = [];
                }
                
                const timeSlotElement = document.querySelector(`#timeslot-${timeslotId} .period-time`);
                const timeSlotText = timeSlotElement ? timeSlotElement.textContent : `Period ${timeslotId}`;
                
                teacherAssignments[teacherId].push({
                    timeslotId: timeslotId,
                    timeSlot: timeSlotText,
                    teacherName: select.options[select.selectedIndex].text
                });
            }
        }
    });
    
    // Check for conflicts (same teacher in multiple periods)
    for (const [teacherId, assignments] of Object.entries(teacherAssignments)) {
        if (assignments.length > 1) {
            conflicts.push({
                teacherName: assignments[0].teacherName,
                periods: assignments.map(a => a.timeSlot)
            });
        }
    }
    
    return conflicts;
}

// Function to reset the form
function resetForm() {
    if (confirm('Are you sure you want to reset all changes? This will clear all subject, teacher, and classroom selections.')) {
        document.querySelectorAll('select').forEach(select => {
            select.value = '';
            select.classList.remove('is-valid', 'is-invalid');
        });
        
        document.querySelectorAll('input[type="text"]').forEach(input => {
            if (!input.name.includes('break_name')) {
                input.value = '';
            }
        });
        
        document.querySelectorAll('.break-toggle').forEach(checkbox => {
            checkbox.checked = false;
            const timeslotId = checkbox.getAttribute('data-timeslot-id');
            toggleBreakFields(timeslotId);
        });
    }
}

// Main initialization when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 if available
    if (typeof $ !== 'undefined' && $.fn.select2) {
        $('.teacher-select, .subject-select').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'Select an option',
            allowClear: true
        }).on('change', function() {
            validateField(this);
        });
    }
    
    // Initialize all break toggles
    document.querySelectorAll('.break-toggle').forEach(toggle => {
        const timeslotId = toggle.getAttribute('data-timeslot-id');
        
        // Set initial state
        toggleBreakFields(timeslotId);
        
        // Add change event listener
        toggle.addEventListener('change', function() {
            toggleBreakFields(timeslotId);
        });
    });
    
    // Add validation events to all form fields
    document.querySelectorAll('select, input[type="text"]').forEach(field => {
        field.addEventListener('change', function() {
            validateField(this);
        });
        
        field.addEventListener('blur', function() {
            validateField(this);
        });
    });
    
    // Form submission handler
    const form = document.getElementById('timetableForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        let isValid = true;
        const errorMessages = [];
        
        // Validate all fields
        document.querySelectorAll('select[required], input[type="text"][required]').forEach(field => {
            const timeslotId = field.name.split('_')[1];
            const isBreak = document.getElementById(`break_${timeslotId}`)?.checked;
            
            // Skip validation for break name when not in break mode
            if (field.name.includes('break_name') && !isBreak) {
                return;
            }
            
            // Skip validation for subject/teacher when in break mode
            if ((field.name.includes('subject') || field.name.includes('teacher')) && isBreak) {
                return;
            }
            
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
                
                const fieldName = field.name.includes('subject') ? 'Subject' : 
                                 field.name.includes('teacher') ? 'Teacher' : 'Break Name';
                
                const timeslotElement = document.querySelector(`#timeslot-${timeslotId} .period-time`);
                const timeSlot = timeslotElement ? timeslotElement.textContent : `Period ${timeslotId}`;
                
                errorMessages.push(`${fieldName} is required for ${timeSlot}`);
            } else {
                field.classList.add('is-valid');
            }
        });
        
        // Check for teacher conflicts
        const conflicts = checkTeacherConflicts();
        if (conflicts.length > 0) {
            isValid = false;
            conflicts.forEach(conflict => {
                errorMessages.push(`Teacher ${conflict.teacherName} is assigned to multiple periods: ${conflict.periods.join(', ')}`);
            });
        }
        
        // Show errors or submit form
        if (!isValid) {
            // Scroll to first error
            const firstError = document.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
            
            // Show error alert
            let alertMessage = 'Please fix the following errors:\n\n' + errorMessages.join('\n');
            if (errorMessages.length > 5) {
                alertMessage = 'Please fix the errors in the form. The first error has been highlighted.';
            }
            
            alert(alertMessage);
            return false;
        }
        
        // All valid - show confirmation and submit
        const saveButton = document.getElementById('saveButton');
        const originalText = saveButton.innerHTML;
        
        saveButton.innerHTML = '<i class="bi bi-arrow-clockwise spin me-1"></i> Saving...';
        saveButton.disabled = true;
        
        // Add spinner animation
        const style = document.createElement('style');
        style.innerHTML = `
            .spin {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
        
        // Submit the form
        setTimeout(() => {
            form.submit();
        }, 500);
    });
    
    // Auto-save reminder
    let hasUnsavedChanges = false;
    const inputs = document.querySelectorAll('select, input[type="text"], input[type="checkbox"]');
    
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            hasUnsavedChanges = true;
            
            // Update save button text
            const saveButton = document.getElementById('saveButton');
            if (saveButton.innerHTML.includes('Save All Changes')) {
                saveButton.innerHTML = '<i class="bi bi-save me-1"></i> Save Changes*';
            }
        });
    });
    
    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return 'You have unsaved changes. Are you sure you want to leave?';
        }
    });
    
    // Clear unsaved changes flag on form submit
    form.addEventListener('submit', function() {
        hasUnsavedChanges = false;
    });
});
</script>
{% endblock %}