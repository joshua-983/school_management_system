<!-- templates/core/announcements/announcement_list.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Announcements - School Management System{% endblock %}

{% block extra_css %}
<style>
.announcement-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    margin-bottom: 20px;
    border-left: 4px solid #6c757d;
}

.announcement-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
}

.announcement-card.urgent {
    border-left-color: #dc3545;
    background: linear-gradient(135deg, #fff, #ffe6e6);
}

.announcement-card.high {
    border-left-color: #fd7e14;
    background: linear-gradient(135deg, #fff, #fff3e6);
}

.announcement-card.normal {
    border-left-color: #17a2b8;
    background: linear-gradient(135deg, #fff, #e6f7ff);
}

.announcement-card.low {
    border-left-color: #6c757d;
}

.priority-badge {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 6px;
}

.badge-urgent {
    background: #dc3545;
    color: white;
}

.badge-high {
    background: #fd7e14;
    color: white;
}

.badge-normal {
    background: #17a2b8;
    color: white;
}

.badge-low {
    background: #6c757d;
    color: white;
}

.announcement-header {
    display: flex;
    justify-content: between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.announcement-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    line-height: 1.4;
}

.announcement-meta {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 10px;
}

.announcement-content {
    color: #495057;
    line-height: 1.6;
    white-space: pre-line;
}

.announcement-actions {
    display: flex;
    gap: 8px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.status-badge {
    font-size: 0.7rem;
    padding: 3px 6px;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    color: #dee2e6;
}

.filter-buttons {
    margin-bottom: 25px;
}

.filter-btn.active {
    background-color: #007bff;
    color: white;
}

.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
}

.stats-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0;
}

.stats-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.search-box {
    position: relative;
}

.search-box .form-control {
    padding-left: 40px;
    border-radius: 25px;
}

.search-box i {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    z-index: 10;
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .announcement-header {
        flex-direction: column;
        gap: 10px;
    }
    
    .announcement-actions {
        flex-wrap: wrap;
    }
    
    .stats-card {
        text-align: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">Announcements</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                            <li class="breadcrumb-item active">Announcements</li>
                        </ol>
                    </nav>
                </div>
                {% if user.is_staff or user.is_teacher %}
                <a href="{% url 'create_announcement' %}" class="btn btn-primary">
                    <i class="fas fa-bullhorn me-2"></i>Create Announcement
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <h3 class="stats-number">{{ announcements.count }}</h3>
                <p class="stats-label">Total Announcements</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <h3 class="stats-number">{{ active_count }}</h3>
                <p class="stats-label">Active Announcements</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <h3 class="stats-number">{{ urgent_count }}</h3>
                <p class="stats-label">Urgent Priority</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <h3 class="stats-number">{{ today_count }}</h3>
                <p class="stats-label">Today's Announcements</p>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="filter-buttons">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="all">
                        All
                    </button>
                    <button type="button" class="btn btn-outline-primary filter-btn" data-filter="active">
                        Active
                    </button>
                    <button type="button" class="btn btn-outline-primary filter-btn" data-filter="urgent">
                        Urgent
                    </button>
                    <button type="button" class="btn btn-outline-primary filter-btn" data-filter="today">
                        Today
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" class="form-control" id="searchInput" placeholder="Search announcements...">
            </div>
        </div>
    </div>

    <!-- Announcements List -->
    <div class="row">
        <div class="col-12">
            {% if announcements %}
                <div id="announcementsContainer">
                    {% for announcement in announcements %}
                    <div class="card announcement-card {{ announcement.priority|lower }} fade-in" 
                         data-priority="{{ announcement.priority|lower }}"
                         data-status="{% if announcement.is_active %}active{% else %}inactive{% endif %}"
                         data-date="{{ announcement.created_at|date:'Y-m-d' }}">
                        <div class="card-body">
                            <div class="announcement-header">
                                <div class="flex-grow-1">
                                    <h5 class="announcement-title">
                                        {{ announcement.title }}
                                        <span class="priority-badge badge-{{ announcement.priority|lower }} ms-2">
                                            {{ announcement.priority }}
                                        </span>
                                        {% if not announcement.is_active %}
                                        <span class="badge bg-secondary status-badge ms-1">Expired</span>
                                        {% endif %}
                                        {% if announcement.created_at.date == today %}
                                        <span class="badge bg-success status-badge ms-1">New</span>
                                        {% endif %}
                                    </h5>
                                    <div class="announcement-meta">
                                        <i class="fas fa-user me-1"></i>By {{ announcement.created_by.get_full_name|default:announcement.created_by.username }}
                                        <i class="fas fa-clock ms-3 me-1"></i>{{ announcement.created_at|date:"M d, Y H:i" }}
                                        {% if announcement.end_date %}
                                        <i class="fas fa-calendar-times ms-3 me-1"></i>Expires: {{ announcement.end_date|date:"M d, Y H:i" }}
                                        {% endif %}
                                    </div>
                                </div>
                                {% if user.is_staff or user.is_teacher %}
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item" href="{% url 'update_announcement' announcement.pk %}">
                                                <i class="fas fa-edit me-2"></i>Edit
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" 
                                               data-bs-toggle="modal" data-bs-target="#deleteModal{{ announcement.pk }}">
                                                <i class="fas fa-trash me-2"></i>Delete
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>

                            <div class="announcement-content">
                                {{ announcement.message }}
                            </div>

                            {% if announcement.target_audience.exists %}
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-users me-1"></i>
                                    Target: 
                                    {% for class in announcement.target_audience.all %}
                                        <span class="badge bg-light text-dark me-1">{{ class.name }}</span>
                                    {% endfor %}
                                </small>
                            </div>
                            {% endif %}

                            {% if user.is_staff or user.is_teacher %}
                            <div class="announcement-actions">
                                <span class="badge {% if announcement.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                    {% if announcement.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                                <span class="badge bg-info">
                                    Views: {{ announcement.usernouncementview_set.count }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Delete Modal -->
                    {% if user.is_staff or user.is_teacher %}
                    <div class="modal fade" id="deleteModal{{ announcement.pk }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Confirm Delete</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    Are you sure you want to delete the announcement "{{ announcement.title }}"?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <form method="post" action="{% url 'delete_announcement' announcement.pk %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger">Delete</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if is_paginated %}
                <nav aria-label="Announcements pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                        </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

            {% else %}
                <!-- Empty State -->
                <div class="empty-state">
                    <i class="fas fa-bullhorn"></i>
                    <h3>No Announcements Yet</h3>
                    <p class="mb-4">There are no announcements to display at the moment.</p>
                    {% if user.is_staff or user.is_teacher %}
                    <a href="{% url 'create_announcement' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Create Your First Announcement
                    </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    const announcements = document.querySelectorAll('.announcement-card');
    const searchInput = document.getElementById('searchInput');
    
    // Today's date for filtering
    const today = new Date().toISOString().split('T')[0];
    
    // Filter buttons event listeners
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            const filter = this.getAttribute('data-filter');
            filterAnnouncements(filter);
        });
    });
    
    // Search functionality
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        filterAnnouncements('all', searchTerm);
    });
    
    function filterAnnouncements(filter, searchTerm = '') {
        announcements.forEach(card => {
            const priority = card.getAttribute('data-priority');
            const status = card.getAttribute('data-status');
            const date = card.getAttribute('data-date');
            const title = card.querySelector('.announcement-title').textContent.toLowerCase();
            const content = card.querySelector('.announcement-content').textContent.toLowerCase();
            
            let show = true;
            
            // Apply filter
            if (filter === 'active' && status !== 'active') {
                show = false;
            } else if (filter === 'urgent' && priority !== 'urgent') {
                show = false;
            } else if (filter === 'today' && date !== today) {
                show = false;
            }
            
            // Apply search
            if (show && searchTerm) {
                if (!title.includes(searchTerm) && !content.includes(searchTerm)) {
                    show = false;
                }
            }
            
            // Show/hide card
            if (show) {
                card.style.display = 'block';
                // Add fade-in animation
                card.classList.add('fade-in');
            } else {
                card.style.display = 'none';
                card.classList.remove('fade-in');
            }
        });
        
        // Show empty state if no cards visible
        const visibleCards = document.querySelectorAll('.announcement-card[style="display: block"]');
        const emptyState = document.querySelector('.empty-state');
        const announcementsContainer = document.getElementById('announcementsContainer');
        
        if (visibleCards.length === 0 && announcementsContainer) {
            if (!emptyState) {
                const noResultsHtml = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>No Announcements Found</h3>
                        <p>Try adjusting your search or filter criteria.</p>
                        <button class="btn btn-outline-primary" onclick="resetFilters()">
                            Reset Filters
                        </button>
                    </div>
                `;
                announcementsContainer.innerHTML = noResultsHtml;
            }
        } else if (emptyState && visibleCards.length > 0) {
            emptyState.remove();
        }
    }
    
    // Auto-dismiss new announcements after 5 seconds (for banner)
    setTimeout(() => {
        const newBadges = document.querySelectorAll('.badge.bg-success:contains("New")');
        newBadges.forEach(badge => {
            badge.style.opacity = '0.6';
        });
    }, 5000);
    
    // Real-time updates via WebSocket
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/notifications/`;
        
        try {
            const socket = new WebSocket(wsUrl);
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'new_announcement') {
                    showNewAnnouncementToast(data.announcement);
                }
            };
            
            socket.onclose = function() {
                // Attempt to reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
            
        } catch (error) {
            console.error('WebSocket connection failed:', error);
        }
    }
    
    function showNewAnnouncementToast(announcement) {
        // Create toast notification
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${announcement.priority === 'URGENT' ? 'danger' : 'primary'} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${announcement.title}</strong><br>
                        ${announcement.message.substring(0, 100)}...
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        const toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = toastHtml;
        const toastElement = tempDiv.firstElementChild;
        
        document.querySelector('.toast-container').appendChild(toastElement);
        
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            toast.hide();
        }, 5000);
    }
    
    // Initialize WebSocket connection
    connectWebSocket();
    
    // Add pulse animation to urgent announcements
    document.querySelectorAll('.announcement-card.urgent').forEach(card => {
        card.classList.add('animate-pulse');
    });
});

// Global function to reset filters
function resetFilters() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-filter') === 'all') {
            btn.classList.add('active');
        }
    });
    document.getElementById('searchInput').value = '';
    document.querySelectorAll('.announcement-card').forEach(card => {
        card.style.display = 'block';
        card.classList.add('fade-in');
    });
    
    // Remove any custom empty state
    const emptyState = document.querySelector('.empty-state');
    if (emptyState && emptyState.querySelector('h3').textContent === 'No Announcements Found') {
        emptyState.remove();
    }
}

// Helper function for contains selector
// This extends the :contains pseudo-selector which isn't native
document.querySelectorAll && (function (ElementPrototype) {
    ElementPrototype.matches = ElementPrototype.matches || 
        ElementPrototype.matchesSelector ||
        ElementPrototype.webkitMatchesSelector ||
        ElementPrototype.msMatchesSelector;
    
    ElementPrototype.closest = ElementPrototype.closest || function (selector) {
        let elem = this;
        while (elem && elem.nodeType === 1) {
            if (elem.matches(selector)) return elem;
            elem = elem.parentNode;
        }
        return null;
    };
})(Element.prototype);
</script>
{% endblock %}