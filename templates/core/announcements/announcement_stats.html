<!-- templates/core/announcements/announcement_stats.html -->
{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Announcement Statistics - School Management System{% endblock %}

{% block extra_css %}
<style>
.stats-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #007bff;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card.urgent {
    border-left-color: #dc3545;
}

.stat-card.high {
    border-left-color: #fd7e14;
}

.stat-card.active {
    border-left-color: #28a745;
}

.stat-card.expired {
    border-left-color: #6c757d;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: #2c3e50;
}

.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-change {
    font-size: 0.8rem;
    margin-top: 0.5rem;
}

.stat-change.positive {
    color: #28a745;
}

.stat-change.negative {
    color: #dc3545;
}

.chart-container {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
}

.priority-distribution {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.priority-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.priority-label {
    min-width: 80px;
    font-weight: 600;
}

.priority-progress {
    flex-grow: 1;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    height: 25px;
}

.progress-fill {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    font-size: 0.8rem;
    font-weight: 600;
    color: white;
    transition: width 0.5s ease;
}

.progress-urgent {
    background: linear-gradient(135deg, #dc3545, #c82333);
}

.progress-high {
    background: linear-gradient(135deg, #fd7e14, #e55a00);
}

.progress-normal {
    background: linear-gradient(135deg, #17a2b8, #138496);
}

.progress-low {
    background: linear-gradient(135deg, #6c757d, #545b62);
}

.activity-timeline {
    max-height: 400px;
    overflow-y: auto;
}

.timeline-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    border-left: 3px solid #007bff;
    background: #f8f9fa;
    margin-bottom: 0.5rem;
    border-radius: 0 8px 8px 0;
}

.timeline-item.urgent {
    border-left-color: #dc3545;
    background: #ffe6e6;
}

.timeline-item.high {
    border-left-color: #fd7e14;
    background: #fff3e6;
}

.timeline-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.timeline-icon.primary {
    background: #007bff;
    color: white;
}

.timeline-icon.success {
    background: #28a745;
    color: white;
}

.timeline-icon.warning {
    background: #ffc107;
    color: black;
}

.timeline-icon.danger {
    background: #dc3545;
    color: white;
}

.timeline-content {
    flex-grow: 1;
}

.timeline-time {
    font-size: 0.8rem;
    color: #6c757d;
}

.filter-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
}

.date-range-picker {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.export-buttons {
    display: flex;
    gap: 0.5rem;
}

.metric-comparison {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.metric-card {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #007bff;
}

.metric-label {
    font-size: 0.8rem;
    color: #6c757d;
    text-transform: uppercase;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .date-range-picker {
        flex-direction: column;
    }
    
    .export-buttons {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="stats-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h3 mb-2">Announcement Statistics</h1>
                <p class="mb-0">Comprehensive analytics and insights about your announcements</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'announcement_list' %}" class="btn btn-light me-2">
                    <i class="bi bi-arrow-left me-2"></i>Back to Announcements
                </a>
                <a href="{% url 'create_announcement' %}" class="btn btn-outline-light">
                    <i class="bi bi-plus-circle me-2"></i>Create New
                </a>
            </div>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="filter-section">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h6 class="mb-3">Filter by Date Range</h6>
                <div class="date-range-picker">
                    <div class="flex-grow-1">
                        <label class="form-label">From Date</label>
                        <input type="date" class="form-control" id="startDate" value="{{ default_start_date }}">
                    </div>
                    <div class="flex-grow-1">
                        <label class="form-label">To Date</label>
                        <input type="date" class="form-control" id="endDate" value="{{ default_end_date }}">
                    </div>
                    <div>
                        <button class="btn btn-primary mt-4" onclick="applyDateFilter()">
                            <i class="bi bi-filter me-2"></i>Apply
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <h6 class="mb-3">Export Data</h6>
                <div class="export-buttons">
                    <button class="btn btn-outline-success" onclick="exportData('pdf')">
                        <i class="bi bi-file-pdf me-2"></i>PDF Report
                    </button>
                    <button class="btn btn-outline-primary" onclick="exportData('excel')">
                        <i class="bi bi-file-excel me-2"></i>Excel Data
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportData('csv')">
                        <i class="bi bi-file-text me-2"></i>CSV Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_count }}</div>
            <div class="stat-label">Total Announcements</div>
            <div class="stat-change positive">
                <i class="bi bi-arrow-up me-1"></i>12% from last period
            </div>
        </div>

        <div class="stat-card active">
            <div class="stat-number">{{ active_count }}</div>
            <div class="stat-label">Active Announcements</div>
            <div class="stat-change positive">
                <i class="bi bi-arrow-up me-1"></i>8% from last period
            </div>
        </div>

        <div class="stat-card urgent">
            <div class="stat-number">{{ urgent_count }}</div>
            <div class="stat-label">Urgent Priority</div>
            <div class="stat-change negative">
                <i class="bi bi-arrow-down me-1"></i>5% from last period
            </div>
        </div>

        <div class="stat-card high">
            <div class="stat-number">{{ high_count }}</div>
            <div class="stat-label">High Priority</div>
            <div class="stat-change positive">
                <i class="bi bi-arrow-up me-1"></i>15% from last period
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-number">{{ today_count }}</div>
            <div class="stat-label">Created Today</div>
            <div class="stat-change positive">
                <i class="bi bi-arrow-up me-1"></i>20% from yesterday
            </div>
        </div>

        <div class="stat-card expired">
            <div class="stat-number">{{ expired_count }}</div>
            <div class="stat-label">Expired Announcements</div>
            <div class="stat-change negative">
                <i class="bi bi-arrow-down me-1"></i>3% from last period
            </div>
        </div>
    </div>

    <!-- Priority Distribution -->
    <div class="chart-container">
        <h5 class="mb-4">
            <i class="bi bi-pie-chart me-2"></i>Priority Distribution
        </h5>
        <div class="priority-distribution">
            {% for stat in priority_stats %}
            <div class="priority-bar">
                <span class="priority-label">{{ stat.label }}</span>
                <div class="priority-progress">
                    <div class="progress-fill progress-{{ stat.name|lower }}" 
                         style="width: {{ stat.percentage }}%">
                        {{ stat.percentage }}% ({{ stat.count }})
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="row">
        <!-- Recent Activity -->
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-4">
                    <i class="bi bi-clock-history me-2"></i>Recent Activity
                </h5>
                <div class="activity-timeline">
                    {% for activity in recent_activity %}
                    <div class="timeline-item {% if activity.priority == 'URGENT' %}urgent{% endif %}">
                        <div class="timeline-icon {{ activity.color }}">
                            <i class="bi bi-{{ activity.icon }}"></i>
                        </div>
                        <div class="timeline-content">
                            <h6 class="mb-1">{{ activity.title }}</h6>
                            <p class="mb-1 text-muted">{{ activity.description }}</p>
                            <div class="timeline-time">
                                <i class="bi bi-clock me-1"></i>{{ activity.time|naturaltime }}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <p class="text-muted mt-3">No recent activity</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-4">
                    <i class="bi bi-graph-up me-2"></i>Performance Metrics
                </h5>
                <div class="metric-comparison">
                    <div class="metric-card">
                        <div class="metric-value">78%</div>
                        <div class="metric-label">Read Rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">2.3m</div>
                        <div class="metric-label">Avg. View Time</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">45%</div>
                        <div class="metric-label">Engagement Rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">12h</div>
                        <div class="metric-label">Avg. Response Time</div>
                    </div>
                </div>

                <div class="mt-4">
                    <h6 class="mb-3">Top Performing Announcements</h6>
                    <div class="list-group">
                        {% for top in top_performers %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ top.title }}</h6>
                                    <small class="text-muted">{{ top.views }} views</small>
                                </div>
                                <span class="badge bg-{{ top.priority|lower }}">{{ top.priority }}</span>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-3">
                            <small class="text-muted">No performance data available</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Class Level Distribution -->
    <div class="chart-container">
        <h5 class="mb-4">
            <i class="bi bi-people me-2"></i>Audience Distribution by Class Level
        </h5>
        <div class="row">
            {% for class_stat in class_level_stats %}
            <div class="col-md-3 col-6 mb-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-primary">{{ class_stat.count }}</h3>
                        <small class="text-muted">{{ class_stat.class_level }}</small>
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar" style="width: {{ class_stat.percentage }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Monthly Trend -->
    <div class="chart-container">
        <h5 class="mb-4">
            <i class="bi bi-calendar-range me-2"></i>Monthly Announcement Trend
        </h5>
        <div id="monthlyTrendChart" style="height: 300px;">
            <!-- Chart will be rendered by JavaScript -->
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading chart...</span>
                </div>
                <p class="mt-2 text-muted">Loading trend data...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts and analytics
    initializeMonthlyTrendChart();
    initializePerformanceMetrics();
});

function applyDateFilter() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }
    
    // Reload page with date parameters
    const url = new URL(window.location.href);
    url.searchParams.set('start_date', startDate);
    url.searchParams.set('end_date', endDate);
    window.location.href = url.toString();
}

function exportData(format) {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    let url = `/announcements/export/${format}/`;
    if (startDate && endDate) {
        url += `?start_date=${startDate}&end_date=${endDate}`;
    }
    
    window.location.href = url;
}

function initializeMonthlyTrendChart() {
    // Simulated monthly data - in real implementation, fetch from API
    const monthlyData = {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        datasets: [
            {
                label: 'Announcements Created',
                data: [12, 19, 15, 25, 22, 30, 28, 26, 32, 35, 40, 38],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true,
                tension: 0.4
            },
            {
                label: 'Active Announcements',
                data: [8, 12, 10, 18, 16, 22, 20, 18, 25, 28, 32, 30],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                fill: true,
                tension: 0.4
            }
        ]
    };
    
    // In a real implementation, use Chart.js or similar library
    console.log('Monthly trend data:', monthlyData);
    
    // Simulate chart rendering completion
    setTimeout(() => {
        const chartContainer = document.getElementById('monthlyTrendChart');
        chartContainer.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-bar-chart display-4 text-primary"></i>
                <p class="mt-3 text-muted">Monthly trend chart would be displayed here</p>
                <small class="text-muted">Using Chart.js or similar visualization library</small>
            </div>
        `;
    }, 1000);
}

function initializePerformanceMetrics() {
    // Initialize any additional performance metrics
    console.log('Initializing performance metrics...');
}

// Auto-refresh data every 5 minutes
setInterval(() => {
    console.log('Refreshing announcement statistics...');
    // In real implementation, this would refresh the data
}, 300000);
</script>
{% endblock %}