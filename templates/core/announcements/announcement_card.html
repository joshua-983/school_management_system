{% load static %}
{% load humanize %}

<div class="announcement-card card card-hover border-0 shadow-sm mb-3 position-relative announcement-{{ announcement.priority|lower }}" 
     data-announcement-id="{{ announcement.id }}"
     data-priority="{{ announcement.priority|lower }}"
     data-status="{% if announcement.is_active %}active{% else %}inactive{% endif %}">
    
    <!-- Selection Checkbox (for staff/teachers only) -->
    {% if user.is_staff or user.teacher %}
    <div class="form-check announcement-checkbox-container position-absolute top-0 start-0 mt-2 ms-2" style="z-index: 2;">
        <input class="form-check-input announcement-checkbox" type="checkbox" 
               value="{{ announcement.id }}" 
               id="announcement_{{ announcement.id }}"
               data-announcement-id="{{ announcement.id }}">
        <label class="form-check-label visually-hidden" for="announcement_{{ announcement.id }}">
            Select {{ announcement.title }}
        </label>
    </div>
    {% endif %}
    
    <div class="card-header bg-transparent border-0 pb-0 position-relative">
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1" style="margin-left: {% if user.is_staff or user.teacher %}30px{% else %}0{% endif %};">
                <!-- Priority Badge and Title -->
                <div class="d-flex align-items-center mb-2 flex-wrap">
                    <span class="priority-indicator priority-{{ announcement.priority|lower }} me-2 flex-shrink-0"></span>
                    <h5 class="card-title mb-0 me-3 flex-grow-1">
                        <a href="{% url 'announcement_detail' announcement.pk %}" 
                           class="text-decoration-none text-dark stretched-link announcement-title-link">
                            {{ announcement.title }}
                        </a>
                    </h5>
                    
                    <!-- Status Badges -->
                    <div class="d-flex gap-1 flex-shrink-0">
                        {% if announcement.is_expired %}
                        <span class="badge bg-warning badge-sm">
                            <i class="bi bi-clock me-1"></i>Expired
                        </span>
                        {% endif %}
                        
                        {% if announcement.start_date > now %}
                        <span class="badge bg-info badge-sm">
                            <i class="bi bi-calendar-plus me-1"></i>Upcoming
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Meta Information -->
                <div class="d-flex flex-wrap align-items-center text-muted small gap-2">
                    <span class="d-flex align-items-center">
                        <i class="bi bi-person me-1"></i>
                        {{ announcement.created_by.get_full_name|default:announcement.created_by.username }}
                    </span>
                    <span class="d-flex align-items-center">
                        <i class="bi bi-clock me-1"></i>
                        <span class="announcement-time" data-timestamp="{{ announcement.created_at|date:'c' }}">
                            {{ announcement.created_at|naturaltime }}
                        </span>
                    </span>
                    
                    <!-- Target Classes -->
                    {% with target_classes=announcement.get_target_class_levels %}
                    {% if target_classes %}
                    <span class="d-flex align-items-center">
                        <i class="bi bi-people me-1"></i>
                        {{ target_classes|length }} class{{ target_classes|length|pluralize:"es" }}
                    </span>
                    {% else %}
                    <span class="d-flex align-items-center">
                        <i class="bi bi-globe me-1"></i>
                        School-wide
                    </span>
                    {% endif %}
                    {% endwith %}
                    
                    <!-- View Count -->
                    <span class="d-flex align-items-center">
                        <i class="bi bi-eye me-1"></i>
                        <span class="view-count" id="viewCount{{ announcement.id }}">
                            {{ announcement.views_count|default:0 }}
                        </span> views
                    </span>
                </div>
            </div>
            
            <!-- Status and Actions -->
            <div class="dropdown announcement-actions flex-shrink-0">
                <button class="btn btn-sm btn-outline-secondary border-0 dropdown-toggle" type="button" 
                        data-bs-toggle="dropdown" aria-expanded="false"
                        aria-label="Announcement actions">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li>
                        <a class="dropdown-item view-details" href="{% url 'announcement_detail' announcement.pk %}">
                            <i class="bi bi-eye me-2"></i>View Details
                        </a>
                    </li>
                    
                    <!-- Quick Actions -->
                    <li>
                        <button class="dropdown-item copy-link" onclick="announcementCard.copyLink({{ announcement.id }})">
                            <i class="bi bi-link-45deg me-2"></i>Copy Link
                        </button>
                    </li>
                    
                    {% if user.is_staff or user.teacher or user == announcement.created_by %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item" href="{% url 'update_announcement' announcement.id %}">
                            <i class="bi bi-pencil me-2"></i>Edit
                        </a>
                    </li>
                    <li>
                        {% if announcement.is_active %}
                        <button class="dropdown-item text-warning toggle-status" 
                                onclick="announcementCard.toggleStatus({{ announcement.id }}, false)">
                            <i class="bi bi-pause-circle me-2"></i>Deactivate
                        </button>
                        {% else %}
                        <button class="dropdown-item text-success toggle-status" 
                                onclick="announcementCard.toggleStatus({{ announcement.id }}, true)">
                            <i class="bi bi-play-circle me-2"></i>Activate
                        </button>
                        {% endif %}
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item text-danger" 
                           href="{% url 'delete_announcement' announcement.id %}">
                            <i class="bi bi-trash me-2"></i>Delete
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    
    <div class="card-body pt-2">
        <!-- Message Preview -->
        <div class="announcement-preview-container">
            <p class="card-text text-muted mb-3 announcement-preview">
                {{ announcement.message|truncatewords:30 }}
                {% if announcement.message|wordcount > 30 %}
                <a href="{% url 'announcement_detail' announcement.pk %}" class="text-primary text-decoration-none small read-more">
                    Read more
                </a>
                {% endif %}
            </p>
        </div>
        
        <!-- Priority and Status Badges -->
        <div class="d-flex flex-wrap gap-2 mb-3">
            <span class="badge priority-badge bg-{{ announcement.priority|lower }}">
                <i class="bi bi-flag me-1"></i>{{ announcement.priority }}
            </span>
            
            <span class="badge status-badge {% if announcement.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                {% if announcement.is_active %}
                <i class="bi bi-check-circle me-1"></i>Active
                {% else %}
                <i class="bi bi-pause-circle me-1"></i>Inactive
                {% endif %}
            </span>
            
            {% if announcement.end_date %}
            <span class="badge expiry-badge {% if announcement.is_expired %}bg-warning{% else %}bg-info{% endif %}">
                <i class="bi bi-clock me-1"></i>
                {% if announcement.is_expired %}
                Expired
                {% else %}
                Expires {{ announcement.end_date|naturaltime }}
                {% endif %}
            </span>
            {% endif %}
        </div>
        
        <!-- Footer Actions -->
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex gap-2 text-muted small flex-wrap">
                <!-- Schedule Info -->
                {% if announcement.start_date or announcement.end_date %}
                <span class="schedule-info">
                    <i class="bi bi-calendar-event me-1"></i>
                    {% if announcement.start_date %}
                    {{ announcement.start_date|date:"M j" }}
                    {% endif %}
                    {% if announcement.end_date %}
                    - {{ announcement.end_date|date:"M j" }}
                    {% endif %}
                </span>
                {% endif %}
            </div>
            
            <!-- Quick Actions -->
            <div class="d-flex gap-1 quick-actions">
                <button class="btn btn-sm btn-outline-secondary copy-link-btn" 
                        onclick="announcementCard.copyLink({{ announcement.id }})"
                        data-bs-toggle="tooltip" data-bs-title="Copy link" data-bs-placement="top">
                    <i class="bi bi-link-45deg"></i>
                </button>
                
                <!-- Dismiss Button (for non-creators) -->
                {% if user != announcement.created_by and announcement.is_active %}
                <button class="btn btn-sm btn-outline-warning dismiss-btn" 
                        onclick="announcementCard.dismiss({{ announcement.id }})"
                        data-bs-toggle="tooltip" data-bs-title="Dismiss announcement" data-bs-placement="top">
                    <i class="bi bi-eye-slash"></i>
                </button>
                {% endif %}
                
                <a href="{% url 'announcement_detail' announcement.pk %}" class="btn btn-sm btn-outline-primary view-details-btn"
                   data-bs-toggle="tooltip" data-bs-title="View details" data-bs-placement="top">
                    <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.announcement-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 4px solid transparent;
    opacity: 1;
    transform: translateY(0);
}

.announcement-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.announcement-card.animate-out {
    opacity: 0;
    transform: translateX(-100%);
    transition: all 0.3s ease-in-out;
}

/* Priority Indicators */
.priority-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
}

.priority-urgent { 
    background-color: #dc3545;
    box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
}
.priority-high { 
    background-color: #fd7e14;
    box-shadow: 0 0 0 2px rgba(253, 126, 20, 0.2);
}
.priority-normal { 
    background-color: #17a2b8;
    box-shadow: 0 0 0 2px rgba(23, 162, 184, 0.2);
}
.priority-low { 
    background-color: #6c757d;
    box-shadow: 0 0 0 2px rgba(108, 117, 125, 0.2);
}

/* Priority-specific card borders */
.announcement-urgent { border-left-color: #dc3545; }
.announcement-high { border-left-color: #fd7e14; }
.announcement-normal { border-left-color: #17a2b8; }
.announcement-low { border-left-color: #6c757d; }

/* Badge styles */
.priority-badge { font-size: 0.75rem; }
.status-badge { font-size: 0.75rem; }
.expiry-badge { font-size: 0.75rem; }

/* Checkbox container */
.announcement-checkbox-container {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.announcement-card:hover .announcement-checkbox-container {
    opacity: 1;
}

/* Preview text */
.announcement-preview {
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Quick actions */
.quick-actions .btn {
    border-radius: 6px;
    transition: all 0.2s ease;
}

.quick-actions .btn:hover {
    transform: scale(1.05);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .announcement-card .card-header .d-flex {
        flex-direction: column;
        align-items: start !important;
    }
    
    .announcement-actions {
        position: absolute;
        top: 15px;
        right: 15px;
    }
    
    .announcement-checkbox-container {
        opacity: 1; /* Always show on mobile */
    }
}

/* Animation for new announcements */
@keyframes highlightNew {
    0% { background-color: rgba(40, 167, 69, 0.1); }
    100% { background-color: transparent; }
}

.announcement-card.new-highlight {
    animation: highlightNew 2s ease-in-out;
}

/* Loading state */
.announcement-card.loading {
    opacity: 0.6;
    pointer-events: none;
}

.announcement-card.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.375rem;
}

.announcement-card.loading::before {
    content: '';
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1;
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}
</style>

<script>
// Namespaced announcement card functionality
const announcementCard = {
    // Copy announcement link
    copyLink: function(announcementId) {
        const link = `${window.location.origin}{% url 'announcement_detail' 0 %}`.replace('/0/', `/${announcementId}/`);
        
        navigator.clipboard.writeText(link).then(() => {
            this.showToast('Link copied to clipboard!', 'success');
        }).catch(() => {
            this.showToast('Failed to copy link', 'error');
        });
    },

    // Dismiss announcement
    dismiss: function(announcementId) {
        if (!confirm('Are you sure you want to dismiss this announcement? You can always find it in the announcements list.')) {
            return;
        }
        
        const card = this.getCardElement(announcementId);
        this.setLoading(card, true);
        
        fetch(`/announcements/${announcementId}/dismiss/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': this.getCookie('csrftoken'),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            this.setLoading(card, false);
            if (data.status === 'success') {
                this.showToast('Announcement dismissed', 'success');
                this.animateRemove(card);
            } else {
                this.showToast('Failed to dismiss announcement', 'error');
            }
        })
        .catch(error => {
            console.error('Error dismissing announcement:', error);
            this.setLoading(card, false);
            this.showToast('Failed to dismiss announcement', 'error');
        });
    },

    // Toggle announcement status
    toggleStatus: function(announcementId, activate) {
        const action = activate ? 'activate' : 'deactivate';
        
        if (!confirm(`Are you sure you want to ${action} this announcement?`)) {
            return;
        }
        
        const card = this.getCardElement(announcementId);
        this.setLoading(card, true);
        
        fetch(`/announcements/${announcementId}/toggle-status/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': this.getCookie('csrftoken'),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            this.setLoading(card, false);
            if (data.status === 'success') {
                this.showToast(`Announcement ${action}d successfully`, 'success');
                // Reload to reflect changes
                setTimeout(() => window.location.reload(), 1000);
            } else {
                this.showToast(`Failed to ${action} announcement`, 'error');
            }
        })
        .catch(error => {
            console.error('Error toggling announcement status:', error);
            this.setLoading(card, false);
            this.showToast(`Failed to ${action} announcement`, 'error');
        });
    },

    // Utility functions
    getCardElement: function(announcementId) {
        return document.querySelector(`[data-announcement-id="${announcementId}"]`);
    },

    setLoading: function(card, isLoading) {
        if (isLoading) {
            card.classList.add('loading');
        } else {
            card.classList.remove('loading');
        }
    },

    animateRemove: function(card) {
        card.classList.add('animate-out');
        setTimeout(() => {
            if (card.parentNode) {
                card.parentNode.removeChild(card);
            }
        }, 300);
    },

    showToast: function(message, type) {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        // Add to toast container
        let toastContainer = document.getElementById('announcementToastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'announcementToastContainer';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        
        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remove toast after hidden
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    },

    getCookie: function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    },

    // Initialize card functionality
    init: function() {
        // Add highlight animation for new announcements
        document.querySelectorAll('.announcement-card').forEach(card => {
            const timeElement = card.querySelector('.announcement-time');
            if (timeElement) {
                const timestamp = timeElement.getAttribute('data-timestamp');
                const announcementTime = new Date(timestamp);
                const now = new Date();
                const diffHours = (now - announcementTime) / (1000 * 60 * 60);
                
                if (diffHours < 24) { // Highlight announcements from last 24 hours
                    card.classList.add('new-highlight');
                }
            }
        });

        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
};

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    announcementCard.init();
});

// Export for use in other scripts
window.announcementCard = announcementCard;
</script>