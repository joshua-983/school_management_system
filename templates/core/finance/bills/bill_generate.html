{% extends 'base.html' %}
{% load static %}

{% block title %}Generate Bills{% endblock %}

{% block extra_css %}
<style>
    .generation-card {
        border-left: 4px solid #3a7bd5;
        border-radius: 10px;
    }
    .preview-card {
        background-color: #f8f9fa;
        border-radius: 10px;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #3a7bd5;
    }
    .recent-activity-item {
        border-left: 3px solid #3a7bd5;
        padding-left: 15px;
        margin-bottom: 15px;
    }
    .form-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="bi bi-gear me-2"></i>
                    Generate Bills
                </h2>
                <a href="{% url 'bill_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Bills
                </a>
            </div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'bill_list' %}">Bills</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Generate</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Messages Display -->
    {% if messages %}
    <div class="row mb-4">
        <div class="col-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm generation-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-cash-stack me-2"></i>
                        Bill Generation Settings
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="billGenerationForm" novalidate>
                        {% csrf_token %}
                        
                        <!-- Academic Year and Term -->
                        <div class="form-section">
                            <h6 class="mb-3"><i class="bi bi-calendar me-2"></i>Academic Information</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Academic Year *</label>
                                        <input type="text" class="form-control" name="academic_year" 
                                               placeholder="e.g., 2024/2025" required
                                               pattern="\d{4}/\d{4}" title="Format: YYYY/YYYY"
                                               value="{% if form.academic_year.value %}{{ form.academic_year.value }}{% else %}{{ current_year }}/{{ next_year }}{% endif %}">
                                        <div class="form-text">Format: YYYY/YYYY</div>
                                        {% if form.academic_year.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.academic_year.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Term *</label>
                                        <select class="form-select" name="term" required>
                                            <option value="">Select Term</option>
                                            <option value="1" {% if form.term.value == "1" %}selected{% endif %}>Term 1</option>
                                            <option value="2" {% if form.term.value == "2" %}selected{% endif %}>Term 2</option>
                                            <option value="3" {% if form.term.value == "3" %}selected{% endif %}>Term 3</option>
                                        </select>
                                        {% if form.term.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.term.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Class Levels and Due Date -->
                        <div class="form-section">
                            <h6 class="mb-3"><i class="bi bi-people me-2"></i>Target Students</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Class Levels</label>
                                        <select class="form-select" name="class_levels" multiple size="6" id="classLevels">
                                            {% for value, display in class_level_choices %}
                                            <option value="{{ value }}" 
                                                    {% if value in form.class_levels.value %}selected{% endif %}>
                                                {{ display }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">Hold Ctrl/Cmd to select multiple classes. Leave empty for all classes.</div>
                                        {% if form.class_levels.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.class_levels.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Due Date *</label>
                                        <input type="date" class="form-control" name="due_date" required
                                               value="{% if form.due_date.value %}{{ form.due_date.value }}{% else %}{{ default_due_date }}{% endif %}"
                                               min="{{ today }}">
                                        <div class="form-text">Bills will be due on this date</div>
                                        {% if form.due_date.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.due_date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Settings -->
                        <div class="form-section">
                            <h6 class="mb-3"><i class="bi bi-gear me-2"></i>Additional Settings</h6>
                            <div class="mb-3">
                                <label class="form-label">Notes (Optional)</label>
                                <textarea class="form-control" name="notes" rows="2" 
                                          placeholder="Optional notes for the bills">{% if form.notes.value %}{{ form.notes.value }}{% endif %}</textarea>
                                {% if form.notes.errors %}
                                <div class="text-danger small">
                                    {% for error in form.notes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" name="skip_existing" id="skipExisting" 
                                       {% if form.skip_existing.value %}checked{% endif %}>
                                <label class="form-check-label" for="skipExisting">
                                    Skip students who already have bills for this term
                                </label>
                                <div class="form-text">Prevents duplicate bill generation for the same term</div>
                            </div>
                        </div>

                        <!-- Generation Preview -->
                        <div class="alert alert-info" id="generationPreview">
                            <h6 class="alert-heading">
                                <i class="bi bi-eye me-2"></i>Generation Preview
                            </h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="fw-bold text-primary" id="previewStudentCount">0</div>
                                    <small class="text-muted">Students</small>
                                </div>
                                <div class="col-4">
                                    <div class="fw-bold text-success" id="previewCategoryCount">{{ fee_category_count }}</div>
                                    <small class="text-muted">Fee Categories</small>
                                </div>
                                <div class="col-4">
                                    <div class="fw-bold text-warning" id="previewTotalBills">0</div>
                                    <small class="text-muted">Total Bills</small>
                                </div>
                            </div>
                            <hr>
                            <div class="text-center">
                                <small class="text-muted">
                                    Estimated Revenue: <strong id="previewRevenue">GH₵0.00</strong>
                                </small>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="generateButton">
                                <i class="bi bi-gear me-2"></i>
                                Generate Bills
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Preview Card -->
            <div class="card shadow-sm preview-card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-eye me-2"></i>
                        System Overview
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="stat-number">{{ student_count }}</div>
                    <p class="text-muted">Active Students</p>
                    
                    <div class="stat-number">{{ fee_category_count }}</div>
                    <p class="text-muted">Mandatory Fee Categories</p>
                    
                    <hr>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle me-1"></i>
                        Bills will be generated for all active students with mandatory fee categories
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Recent Generations
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_generations %}
                    {% for generation in recent_generations %}
                    <div class="recent-activity-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="fw-medium">{{ generation.academic_year }} Term {{ generation.term }}</span>
                                <br>
                                <small class="text-muted">{{ generation.bills_created }} bills created</small>
                            </div>
                            <small class="text-muted">{{ generation.created_at|timesince }} ago</small>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-3">
                        <i class="bi bi-clock-history display-4 text-muted mb-3"></i>
                        <p class="text-muted">No recent bill generations</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Help Section -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-question-circle me-2"></i>
                        Help & Tips
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Before Generating:</h6>
                        <ul class="small">
                            <li>Verify active student count</li>
                            <li>Check mandatory fee categories</li>
                            <li>Set appropriate due date</li>
                            <li>Select specific classes if needed</li>
                        </ul>
                    </div>
                    <div class="mb-3">
                        <h6>After Generation:</h6>
                        <ul class="small">
                            <li>Bills will be visible in Bills list</li>
                            <li>Students/parents can view their bills</li>
                            <li>Payments can be recorded individually</li>
                            <li>Reports will update automatically</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Confirm Bill Generation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6>Generation Summary</h6>
                    <div class="row">
                        <div class="col-6">
                            <small>Academic Year:</small><br>
                            <strong id="confirmAcademicYear"></strong>
                        </div>
                        <div class="col-6">
                            <small>Term:</small><br>
                            <strong id="confirmTerm"></strong>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <small>Classes:</small><br>
                            <strong id="confirmClasses"></strong>
                        </div>
                        <div class="col-6">
                            <small>Due Date:</small><br>
                            <strong id="confirmDueDate"></strong>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <small>Total Bills:</small><br>
                            <strong id="confirmTotalBills"></strong>
                        </div>
                        <div class="col-6">
                            <small>Estimated Revenue:</small><br>
                            <strong id="confirmRevenue"></strong>
                        </div>
                    </div>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmGeneration">
                    <label class="form-check-label" for="confirmGeneration">
                        I understand that this action will generate multiple bills and cannot be easily undone
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmGenerateBtn" disabled>
                    <i class="bi bi-gear me-2"></i>Generate Bills
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('billGenerationForm');
    const classLevelsSelect = document.getElementById('classLevels');
    const dueDateInput = document.querySelector('input[name="due_date"]');
    const academicYearInput = document.querySelector('input[name="academic_year"]');
    const termSelect = document.querySelector('select[name="term"]');
    const skipExistingCheckbox = document.getElementById('skipExisting');
    
    // Preview elements
    const previewStudentCount = document.getElementById('previewStudentCount');
    const previewTotalBills = document.getElementById('previewTotalBills');
    const previewRevenue = document.getElementById('previewRevenue');
    
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    const defaultDueDate = new Date();
    defaultDueDate.setDate(defaultDueDate.getDate() + 30);
    
    if (dueDateInput && !dueDateInput.value) {
        dueDateInput.value = defaultDueDate.toISOString().split('T')[0];
        dueDateInput.min = today;
    }
    
    // Set current academic year if not set
    if (academicYearInput && !academicYearInput.value) {
        const currentYear = new Date().getFullYear();
        academicYearInput.value = `${currentYear}/${currentYear + 1}`;
    }
    
    // Update preview when inputs change
    function updateGenerationPreview() {
        const selectedClasses = Array.from(classLevelsSelect.selectedOptions).map(opt => opt.value);
        const academicYear = academicYearInput.value;
        const term = termSelect.value;
        
        // Mock data - in real implementation, you'd fetch this from the server
        const studentCount = selectedClasses.length > 0 ? selectedClasses.length * 25 : {{ student_count }};
        const categoryCount = {{ fee_category_count }};
        const totalBills = studentCount;
        const avgFeeAmount = 500; // Average fee amount per bill
        
        previewStudentCount.textContent = studentCount.toLocaleString();
        previewTotalBills.textContent = totalBills.toLocaleString();
        previewRevenue.textContent = 'GH₵' + (totalBills * avgFeeAmount).toLocaleString();
    }
    
    // Add event listeners for preview updates
    [classLevelsSelect, academicYearInput, termSelect].forEach(element => {
        if (element) {
            element.addEventListener('change', updateGenerationPreview);
        }
    });
    
    // Form validation
    function validateForm() {
        let isValid = true;
        
        // Validate academic year format
        if (academicYearInput.value && !academicYearInput.value.match(/^\d{4}\/\d{4}$/)) {
            showError(academicYearInput, 'Academic year must be in format YYYY/YYYY');
            isValid = false;
        } else {
            clearError(academicYearInput);
        }
        
        // Validate due date
        if (dueDateInput.value && new Date(dueDateInput.value) < new Date(today)) {
            showError(dueDateInput, 'Due date cannot be in the past');
            isValid = false;
        } else {
            clearError(dueDateInput);
        }
        
        // Validate required fields
        if (!academicYearInput.value) {
            showError(academicYearInput, 'Academic year is required');
            isValid = false;
        }
        
        if (!termSelect.value) {
            showError(termSelect, 'Term is required');
            isValid = false;
        }
        
        if (!dueDateInput.value) {
            showError(dueDateInput, 'Due date is required');
            isValid = false;
        }
        
        return isValid;
    }
    
    function showError(input, message) {
        clearError(input);
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback d-block';
        errorDiv.textContent = message;
        
        input.classList.add('is-invalid');
        input.parentNode.appendChild(errorDiv);
    }
    
    function clearError(input) {
        input.classList.remove('is-invalid');
        const existingError = input.parentNode.querySelector('.invalid-feedback');
        if (existingError) {
            existingError.remove();
        }
    }
    
    // Form submission handling
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateForm()) {
            showConfirmationModal();
        }
    });
    
    function showConfirmationModal() {
        const selectedClasses = Array.from(classLevelsSelect.selectedOptions);
        const classNames = selectedClasses.length > 0 
            ? selectedClasses.map(opt => opt.textContent).join(', ')
            : 'All Classes';
            
        // Set confirmation modal content
        document.getElementById('confirmAcademicYear').textContent = academicYearInput.value;
        document.getElementById('confirmTerm').textContent = 'Term ' + termSelect.options[termSelect.selectedIndex].text;
        document.getElementById('confirmClasses').textContent = classNames;
        document.getElementById('confirmDueDate').textContent = new Date(dueDateInput.value).toLocaleDateString();
        document.getElementById('confirmTotalBills').textContent = previewTotalBills.textContent;
        document.getElementById('confirmRevenue').textContent = previewRevenue.textContent;
        
        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        modal.show();
    }
    
    // Enable generate button when checkbox is checked
    document.getElementById('confirmGeneration').addEventListener('change', function() {
        document.getElementById('confirmGenerateBtn').disabled = !this.checked;
    });
    
    // Handle final confirmation
    document.getElementById('confirmGenerateBtn').addEventListener('click', function() {
        // Show loading state
        const generateBtn = document.getElementById('generateButton');
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
        generateBtn.disabled = true;
        
        // Submit the form
        form.submit();
    });
    
    // Initialize preview
    updateGenerationPreview();
    
    // Add select all functionality for class levels
    const selectAllOption = document.createElement('option');
    selectAllOption.value = 'all';
    selectAllOption.textContent = '--- Select All Classes ---';
    classLevelsSelect.insertBefore(selectAllOption, classLevelsSelect.firstChild);
    
    classLevelsSelect.addEventListener('change', function() {
        if (this.value === 'all') {
            // Select all options except "Select All"
            Array.from(this.options).forEach(option => {
                if (option.value !== 'all') {
                    option.selected = true;
                }
            });
        }
        updateGenerationPreview();
    });
});
</script>
{% endblock %}