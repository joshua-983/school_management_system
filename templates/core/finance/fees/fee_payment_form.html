{% extends 'base.html' %}

{% block title %}Record Payment{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
<style>
    .payment-summary-card {
        border-left: 4px solid #28a745;
        transition: all 0.3s ease;
    }
    .payment-summary-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .payment-alert {
        border-left: 4px solid #17a2b8;
        background-color: #f8f9fa;
    }
    .amount-input-group {
        max-width: 100%;
    }
    .student-info {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    .student-photo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 15px;
        border: 3px solid #f8f9fa;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .stats-card {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        text-align: center;
    }
    .stats-value {
        font-size: 1.25rem;
        font-weight: 600;
    }
    .payment-history-card {
        max-height: 300px;
        overflow-y: auto;
    }
    .payment-item {
        border-left: 3px solid #28a745;
        transition: all 0.3s ease;
    }
    .payment-item:hover {
        background-color: #f8f9fa;
        transform: translateX(3px);
    }
    .full-amount-btn {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
    .progress {
        height: 10px;
    }
    .section-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 1rem;
        position: relative;
        padding-left: 15px;
    }
    .section-title:before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        height: 20px;
        width: 4px;
        background-color: #3a7bd5;
        border-radius: 2px;
    }
    /* Animation for amount changes */
    @keyframes highlight {
        0% { background-color: #ffffcc; }
        100% { background-color: transparent; }
    }
    .highlight {
        animation: highlight 1s ease;
    }
    /* Form field styling */
    .form-select:disabled {
        background-color: #e9ecef;
        opacity: 1;
    }
    .form-control:disabled {
        background-color: #e9ecef;
        opacity: 1;
    }
    .field-help {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .student-info {
            flex-direction: column;
            text-align: center;
        }
        .student-photo {
            margin-right: 0;
            margin-bottom: 10px;
        }
    }
    .error-container {
        border-left: 4px solid #dc3545;
    }
    /* Message styling */
    .alert-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1050;
        min-width: 350px;
    }
    .recorder-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Messages Display -->
{% if messages %}
<div class="alert-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi 
                {% if message.tags == 'success' %}bi-check-circle-fill text-success
                {% elif message.tags == 'error' or message.tags == 'danger' %}bi-exclamation-triangle-fill text-danger
                {% else %}bi-info-circle-fill text-info{% endif %} me-2 fs-5">
            </i>
            <div class="flex-grow-1">
                <strong>
                    {% if message.tags == 'success' %}Success!
                    {% elif message.tags == 'error' or message.tags == 'danger' %}Error!
                    {% else %}Info{% endif %}
                </strong>
                <div class="mt-1">{{ message }}</div>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="bi bi-cash-coin me-2"></i>
                    Record Payment - {% firstof fee.student.get_full_name "Student" %}
                </h2>
                {% if fee and fee.pk %}
                <a href="{% url 'fee_detail' pk=fee.pk %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Fee
                </a>
                {% else %}
                <a href="{% url 'fee_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Fees
                </a>
                {% endif %}
            </div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'fee_list' %}">Fee Records</a></li>
                    {% if fee and fee.pk %}
                    <li class="breadcrumb-item"><a href="{% url 'fee_detail' pk=fee.pk %}">Details</a></li>
                    {% endif %}
                    <li class="breadcrumb-item active" aria-current="page">Record Payment</li>
                </ol>
            </nav>
        </div>
    </div>

    {% if not fee or not fee.pk %}
    <div class="alert alert-danger error-container">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
            <div>
                <h5 class="mb-1">Fee Record Not Found</h5>
                <p class="mb-0">The requested fee record could not be found or is invalid. Please check the fee ID and try again.</p>
            </div>
        </div>
        <div class="mt-3">
            <a href="{% url 'fee_list' %}" class="btn btn-primary">
                <i class="bi bi-arrow-left me-1"></i> Return to Fee List
            </a>
        </div>
    </div>
    {% else %}
    <!-- Recorder Information Banner -->
    <div class="recorder-info">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h5 class="mb-1"><i class="bi bi-person-check me-2"></i>Recording Payment As</h5>
                <p class="mb-0">
                    <strong>{{ request.user.get_full_name }}</strong> 
                    <span class="opacity-75">({{ request.user.username }})</span>
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <small class="opacity-75">
                    <i class="bi bi-calendar me-1"></i>
                    {% now "F j, Y" %}
                </small>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <!-- Student Information -->
                    <div class="student-info mb-4">
                        {% if fee.student.photo %}
                        <img src="{{ fee.student.photo.url }}" class="student-photo" alt="{{ fee.student.get_full_name }}">
                        {% else %}
                        <div class="student-photo bg-light d-flex align-items-center justify-content-center">
                            <i class="bi bi-person fs-3 text-muted"></i>
                        </div>
                        {% endif %}
                        <div>
                            <h4 class="mb-1">{{ fee.student.get_full_name }}</h4>
                            <p class="text-muted mb-1">
                                {{ fee.student.class_level }} • {{ fee.student.student_id }}
                            </p>
                            <span class="badge {% if fee.payment_status == 'paid' %}bg-success
                                {% elif fee.payment_status == 'unpaid' %}bg-danger
                                {% elif fee.payment_status == 'partial' %}bg-warning
                                {% elif fee.payment_status == 'overdue' %}bg-dark{% endif %}">
                                {{ fee.get_payment_status_display }}
                            </span>
                            <!-- Recorder info in student section -->
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-person-check me-1"></i>
                                    Recorded by: <strong>{{ request.user.get_full_name }}</strong>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Progress -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Payment Progress</span>
                            <span>{{ fee.payment_percentage|default:0 }}%</span>
                        </div>
                        <div class="progress mb-3" style="height: 10px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ fee.payment_percentage|default:0 }}%" 
                                 aria-valuenow="{{ fee.payment_percentage|default:0 }}" 
                                 aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="stats-card">
                                    <div class="text-muted small">Payable</div>
                                    <div class="stats-value">GH₵{{ fee.amount_payable|default:0|floatformat:2 }}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-card">
                                    <div class="text-muted small">Paid</div>
                                    <div class="stats-value text-success">GH₵{{ fee.amount_paid|default:0|floatformat:2 }}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-card">
                                    <div class="text-muted small">Balance</div>
                                    <div class="stats-value {% if fee.balance > 0 %}text-danger{% else %}text-success{% endif %}">
                                        GH₵{{ fee.balance|default:0|floatformat:2 }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert payment-alert mb-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle fs-4 me-3 text-info"></i>
                            <div>
                                <h5 class="mb-1">{{ fee.category.name|default:"Fee" }}</h5>
                                <p class="mb-1">Current Balance: <strong class="fs-4">GH₵{{ fee.balance|default:0|floatformat:2 }}</strong></p>
                                <small>Due: {{ fee.due_date|date:"M d, Y"|default:"Not specified" }}</small>
                            </div>
                        </div>
                    </div>

                    <form method="post" novalidate id="payment-form">
                        {% csrf_token %}
                        
                        <!-- Hidden fields -->
                        {{ form.fee }}
                        {{ form.recorded_by }}
                        {% if form.bill %}{{ form.bill }}{% endif %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            <h6 class="alert-heading">Please fix the following errors:</h6>
                            {% for error in form.non_field_errors %}
                            <p class="mb-1">• {{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <h5 class="section-title">Payment Details</h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.amount.id_for_label }}" class="form-label required-field">
                                    Payment Amount
                                </label>
                                <div class="input-group amount-input-group">
                                    <span class="input-group-text">GH₵</span>
                                    {{ form.amount }}
                                    <button type="button" class="btn btn-outline-primary full-amount-btn" id="pay-full-amount">
                                        Full Amount
                                    </button>
                                </div>
                                {% if form.amount.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.amount.errors %}
                                    <p class="mb-0">• {{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="field-help">
                                    Maximum: GH₵{{ fee.balance|floatformat:2 }}
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted" id="balance-after-payment">
                                        Balance after payment: GH₵{{ fee.balance|floatformat:2 }}
                                    </small>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.payment_mode.id_for_label }}" class="form-label required-field">
                                    Payment Method
                                </label>
                                {{ form.payment_mode }}
                                {% if form.payment_mode.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.payment_mode.errors %}
                                    <p class="mb-0">• {{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="field-help">
                                    Select how the payment was made
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.payment_date.id_for_label }}" class="form-label required-field">
                                    Payment Date
                                </label>
                                <div class="input-group">
                                    {{ form.payment_date }}
                                    <button class="btn btn-outline-secondary calendar-btn" type="button" id="calendar-btn">
                                        <i class="bi bi-calendar"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary today-btn" type="button" id="today-btn">
                                        Today
                                    </button>
                                </div>
                                {% if form.payment_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.payment_date.errors %}
                                    <p class="mb-0">• {{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="field-help">
                                    Date when payment was received
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.receipt_number.id_for_label }}" class="form-label">
                                    Receipt Number
                                </label>
                                {{ form.receipt_number }}
                                {% if form.receipt_number.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.receipt_number.errors %}
                                    <p class="mb-0">• {{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="field-help">
                                    Optional reference number for tracking
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                Payment Notes
                            </label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.notes.errors %}
                                <p class="mb-0">• {{ error }}</p>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="field-help">
                                Optional notes about this payment (e.g., transaction ID, purpose)
                            </div>
                        </div>

                        <!-- Confirmation Section -->
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-check fs-4 me-3 text-info"></i>
                                <div>
                                    <h6 class="mb-1">Payment Recording Confirmation</h6>
                                    <p class="mb-0">
                                        This payment will be recorded by: <strong>{{ request.user.get_full_name }}</strong>
                                        <br>
                                        <small class="text-muted">Date: {% now "F j, Y \a\t g:i A" %}</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end border-top pt-3">
                            <button type="submit" class="btn btn-success px-4" id="submit-btn">
                                <i class="bi bi-check-circle me-1"></i> Record Payment as {{ request.user.get_full_name }}
                            </button>
                            {% if fee.pk %}
                            <a href="{% url 'fee_detail' pk=fee.pk %}" class="btn btn-outline-secondary px-4">
                                <i class="bi bi-x-circle me-1"></i> Cancel
                            </a>
                            {% else %}
                            <a href="{% url 'fee_list' %}" class="btn btn-outline-secondary px-4">
                                <i class="bi bi-x-circle me-1"></i> Cancel
                            </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4 payment-summary-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-receipt me-2"></i> Fee Summary</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-tag me-2 text-primary"></i>Fee Category:</span>
                            <span>{{ fee.category.name|default:"-" }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-person me-2 text-primary"></i>Student:</span>
                            <span>{{ fee.student.get_full_name|default:"-" }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-currency-dollar me-2 text-primary"></i>Amount Payable:</span>
                            <span>GH₵{{ fee.amount_payable|default:0|floatformat:2 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-cash-coin me-2 text-primary"></i>Amount Paid:</span>
                            <span>GH₵{{ fee.amount_paid|default:0|floatformat:2 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-wallet2 me-2 text-primary"></i>Balance:</span>
                            <span class="fw-bold {% if fee.balance > 0 %}text-danger{% else %}text-success{% endif %}">
                                GH₵{{ fee.balance|default:0|floatformat:2 }}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-calendar me-2 text-primary"></i>Due Date:</span>
                            <span class="{% if fee.is_overdue %}text-danger{% endif %}">
                                {{ fee.due_date|date:"M d, Y"|default:"-" }}
                                {% if fee.is_overdue %}<span class="badge bg-danger ms-1">Overdue</span>{% endif %}
                            </span>
                        </li>
                        <!-- Recorder info in summary -->
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-person-check me-2 text-primary"></i>Recording As:</span>
                            <span class="fw-bold text-info">{{ request.user.get_full_name }}</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            {% if fee.payments.exists %}
            <div class="card shadow-sm payment-history-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i> Recent Payments</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for payment in fee.payments.all|slice:":5" %}
                        <div class="list-group-item payment-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">GH₵{{ payment.amount|floatformat:2 }}</h6>
                                <small>{{ payment.payment_date|date:"M d, Y" }}</small>
                            </div>
                            <p class="mb-1 text-muted">
                                <i class="bi bi-credit-card me-1"></i>
                                {{ payment.get_payment_mode_display }}
                                {% if payment.receipt_number %}({{ payment.receipt_number }}){% endif %}
                            </p>
                            {% if payment.notes %}
                            <small class="d-block text-truncate">{{ payment.notes }}</small>
                            {% endif %}
                            <!-- Show who recorded previous payments -->
                            <small class="text-muted">
                                <i class="bi bi-person me-1"></i>
                                Recorded by: {{ payment.recorded_by.get_full_name }}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                    {% if fee.payments.count > 5 %}
                    <div class="text-center mt-2">
                        <a href="{% url 'fee_detail' pk=fee.pk %}#payments" class="text-decoration-none">
                            View all {{ fee.payments.count }} payments
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Only initialize if fee exists
    {% if fee and fee.pk %}
    
    // Auto-hide messages after 5 seconds
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert-dismissible');
        alerts.forEach(alert => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);

    // Fix payment mode field immediately on load
    const paymentModeField = document.getElementById('{{ form.payment_mode.id_for_label }}');
    if (paymentModeField) {
        console.log('Payment mode field found, ensuring it is enabled...');
        paymentModeField.disabled = false;
        paymentModeField.readOnly = false;
        paymentModeField.classList.add('form-select');
        paymentModeField.classList.remove('is-invalid');
    }

    // Initialize datepicker
    $('#{{ form.payment_date.id_for_label }}').datepicker({
        format: 'yyyy-mm-dd',
        autoclose: true,
        todayHighlight: true,
        orientation: 'bottom auto',
        endDate: '0d' // Can't select future dates
    });

    // Calendar button
    $('#calendar-btn').click(function() {
        $('#{{ form.payment_date.id_for_label }}').datepicker('show');
    });

    // Set today date
    $('#today-btn').click(function() {
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        $('#{{ form.payment_date.id_for_label }}').val(dateStr);
        $('#{{ form.payment_date.id_for_label }}').datepicker('update');
    });

    // Set default to today if empty
    if (!$('#{{ form.payment_date.id_for_label }}').val()) {
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        $('#{{ form.payment_date.id_for_label }}').val(dateStr);
    }

    // Make date field readonly to prevent manual entry errors
    $('#{{ form.payment_date.id_for_label }}').attr('readonly', true);

    // Set full amount button
    $('#pay-full-amount').click(function() {
        const balance = parseFloat('{{ fee.balance|default:0 }}');
        if (balance > 0) {
            $('#{{ form.amount.id_for_label }}').val(balance.toFixed(2));
            updateBalanceAfterPayment();
            $('#{{ form.amount.id_for_label }}').addClass('highlight');
            setTimeout(() => $('#{{ form.amount.id_for_label }}').removeClass('highlight'), 1000);
        }
    });

    // Update balance after payment in real-time
    function updateBalanceAfterPayment() {
        const amount = parseFloat($('#{{ form.amount.id_for_label }}').val()) || 0;
        const currentBalance = parseFloat('{{ fee.balance|default:0 }}');
        const newBalance = currentBalance - amount;
        
        $('#balance-after-payment').text(`Balance after payment: GH₵${newBalance.toFixed(2)}`);
        
        if (newBalance <= 0) {
            $('#balance-after-payment').removeClass('text-danger').addClass('text-success');
        } else {
            $('#balance-after-payment').removeClass('text-success').addClass('text-danger');
        }
    }

    // Update balance as user types
    $('#{{ form.amount.id_for_label }}').on('input', function() {
        updateBalanceAfterPayment();
    });

    // Initialize balance display
    updateBalanceAfterPayment();

    // Enhanced form validation
    $('#payment-form').submit(function(e) {
        const submitBtn = $('#submit-btn');
        const originalText = submitBtn.html();
        
        // Show loading state
        submitBtn.prop('disabled', true).html('<i class="bi bi-hourglass-split me-1"></i> Processing...');
        
        let isValid = true;
        const errorMessages = [];

        // Validate amount
        const amount = parseFloat($('#{{ form.amount.id_for_label }}').val()) || 0;
        const balance = parseFloat('{{ fee.balance|default:0 }}');
        
        if (amount <= 0) {
            isValid = false;
            errorMessages.push('Please enter a valid payment amount (greater than 0)');
            $('#{{ form.amount.id_for_label }}').addClass('is-invalid');
        } else if (amount > balance) {
            isValid = false;
            errorMessages.push(`Payment amount cannot exceed the remaining balance of GH₵${balance.toFixed(2)}`);
            $('#{{ form.amount.id_for_label }}').addClass('is-invalid');
        } else {
            $('#{{ form.amount.id_for_label }}').removeClass('is-invalid');
        }
        
        // Validate payment date
        const paymentDate = $('#{{ form.payment_date.id_for_label }}').val();
        if (!paymentDate) {
            isValid = false;
            errorMessages.push('Please select a payment date');
            $('#{{ form.payment_date.id_for_label }}').addClass('is-invalid');
        } else {
            $('#{{ form.payment_date.id_for_label }}').removeClass('is-invalid');
        }
        
        // Validate payment mode
        const paymentMode = $('#{{ form.payment_mode.id_for_label }}').val();
        if (!paymentMode) {
            isValid = false;
            errorMessages.push('Please select a payment method');
            $('#{{ form.payment_mode.id_for_label }}').addClass('is-invalid');
        } else {
            $('#{{ form.payment_mode.id_for_label }}').removeClass('is-invalid');
        }

        if (!isValid) {
            e.preventDefault();
            const errorHtml = errorMessages.map(msg => `<p class="mb-1">• ${msg}</p>`).join('');
            showAlert('Please fix the following errors:', errorHtml, 'danger');
            submitBtn.prop('disabled', false).html(originalText);
            return false;
        }
        
        return true;
    });

    // Show custom alert function
    function showAlert(title, message, type = 'danger') {
        // Remove existing alerts
        $('.alert-dismissible').remove();
        
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <h6 class="alert-heading">${title}</h6>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        $('#payment-form').prepend(alertHtml);
    }

    // Add error classes to form fields with errors on page load
    {% if form.errors %}
    {% for field in form %}
        {% if field.errors %}
        $('#{{ field.id_for_label }}').addClass('is-invalid');
        {% endif %}
    {% endfor %}
    {% endif %}

    // Auto-focus on amount field for better UX
    $('#{{ form.amount.id_for_label }}').focus();

    {% endif %}
});
</script>
{% endblock %}