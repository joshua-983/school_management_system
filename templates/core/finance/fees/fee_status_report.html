<!-- finance/fee_status_report.html -->
{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2>Fee Status Report</h2>
            <form method="get" class="mb-4">
                <div class="row g-3">
                    <div class="col-md-3">
                        {{ form.date_range.label_tag }}
                        {{ form.date_range }}
                    </div>
                    <div class="col-md-3">
                        {{ form.class_level.label_tag }}
                        {{ form.class_level }}
                    </div>
                    <div class="col-md-3">
                        {{ form.category.label_tag }}
                        {{ form.category }}
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">Filter</button>
                        <button type="submit" name="export" value="1" class="btn btn-success">
                            Export
                        </button>
                    </div>
                </div>
            </form>
            
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <h5>Paid</h5>
                            <h3>{{ summary.counts.paid }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body">
                            <h5>Partial</h5>
                            <h3>{{ summary.counts.partial }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-danger">
                        <div class="card-body">
                            <h5>Unpaid</h5>
                            <h3>{{ summary.counts.unpaid }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-dark">
                        <div class="card-body">
                            <h5>Overdue</h5>
                            <h3>{{ summary.counts.overdue }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="feeStatusTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#paid">
                        Paid ({{ summary.counts.paid }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#partial">
                        Partial ({{ summary.counts.partial }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#unpaid">
                        Unpaid ({{ summary.counts.unpaid }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#overdue">
                        Overdue ({{ summary.counts.overdue }})
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content p-3 border border-top-0 rounded-bottom">
                <div class="tab-pane fade show active" id="paid">
                    {% include 'finance/_fee_table.html' with fees=paid_fees %}
                </div>
                <div class="tab-pane fade" id="partial">
                    {% include 'finance/_fee_table.html' with fees=partial_fees %}
                </div>
                <div class="tab-pane fade" id="unpaid">
                    {% include 'finance/_fee_table.html' with fees=unpaid_fees %}
                </div>
                <div class="tab-pane fade" id="overdue">
                    {% include 'finance/_fee_table.html' with fees=overdue_fees %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    initializeCharts();
    
    // Tab functionality
    initializeTabs();
    
    // Filter functionality
    initializeFilters();
    
    // Export functionality
    initializeExport();

    function initializeCharts() {
        // Summary Chart
        const summaryCtx = document.getElementById('summaryChart');
        if (summaryCtx) {
            new Chart(summaryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Paid', 'Partial', 'Unpaid', 'Overdue'],
                    datasets: [{
                        data: [
                            {{ summary.counts.paid }},
                            {{ summary.counts.partial }},
                            {{ summary.counts.unpaid }},
                            {{ summary.counts.overdue }}
                        ],
                        backgroundColor: [
                            '#28a745',
                            '#ffc107', 
                            '#dc3545',
                            '#6c757d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Revenue Trend Chart
        const revenueCtx = document.getElementById('revenueTrendChart');
        if (revenueCtx) {
            // This would use actual revenue data from your context
            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Revenue',
                        data: [12000, 19000, 15000, 25000, 22000, 30000],
                        borderColor: '#3a7bd5',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    }

    function initializeTabs() {
        const tabLinks = document.querySelectorAll('[data-bs-toggle="tab"]');
        
        tabLinks.forEach(link => {
            link.addEventListener('shown.bs.tab', function(e) {
                // Update URL hash without page reload
                const target = e.target.getAttribute('data-bs-target');
                history.replaceState(null, null, target);
                
                // Update export button text
                const exportBtn = document.getElementById('exportBtn');
                if (exportBtn) {
                    const tabName = e.target.textContent.trim().split(' ')[0];
                    exportBtn.innerHTML = `<i class="bi bi-download me-2"></i>Export ${tabName} Data`;
                }
            });
        });

        // Load saved tab from URL
        const hash = window.location.hash;
        if (hash) {
            const tab = document.querySelector(`[data-bs-target="${hash}"]`);
            if (tab) {
                new bootstrap.Tab(tab).show();
            }
        }
    }

    function initializeFilters() {
        const filterForm = document.getElementById('filterForm');
        const filterInputs = filterForm.querySelectorAll('select, input');
        
        // Auto-submit on change
        filterInputs.forEach(input => {
            input.addEventListener('change', function() {
                // Add loading indicator
                const submitBtn = filterForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Filtering...';
                
                setTimeout(() => {
                    filterForm.submit();
                }, 500);
            });
        });

        // Date range preset buttons
        const presetButtons = document.querySelectorAll('.date-preset');
        presetButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const days = parseInt(this.dataset.days);
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - days);
                
                document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
                document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
                
                filterForm.submit();
            });
        });

        // Quick status filters
        const statusFilters = document.querySelectorAll('.status-filter');
        statusFilters.forEach(filter => {
            filter.addEventListener('click', function() {
                const status = this.dataset.status;
                document.querySelector('select[name="payment_status"]').value = status;
                filterForm.submit();
            });
        });
    }

    function initializeExport() {
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                const activeTab = document.querySelector('.tab-pane.active');
                const tabName = document.querySelector('[data-bs-target="#' + activeTab.id + '"]').textContent.trim().split(' ')[0];
                
                // Get current filters
                const formData = new FormData(document.getElementById('filterForm'));
                formData.set('export', 'true');
                formData.set('tab', tabName.toLowerCase());
                
                // Show loading
                const originalHtml = this.innerHTML;
                this.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Exporting...';
                this.disabled = true;
                
                // Create and submit form
                const exportForm = document.createElement('form');
                exportForm.method = 'GET';
                exportForm.action = window.location.pathname;
                
                for (let [key, value] of formData) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    exportForm.appendChild(input);
                }
                
                document.body.appendChild(exportForm);
                exportForm.submit();
                
                // Reset button after delay
                setTimeout(() => {
                    this.innerHTML = originalHtml;
                    this.disabled = false;
                }, 3000);
            });
        }

        // Print functionality
        const printBtn = document.getElementById('printBtn');
        if (printBtn) {
            printBtn.addEventListener('click', function() {
                const activeTab = document.querySelector('.tab-pane.active');
                const tabName = document.querySelector('[data-bs-target="#' + activeTab.id + '"]').textContent.trim();
                
                // Create print-friendly version
                const printContent = activeTab.cloneNode(true);
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Fee Status Report - ${tabName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f8f9fa; }
                            .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
                            .bg-success { background-color: #28a745; color: white; }
                            .bg-warning { background-color: #ffc107; color: black; }
                            .bg-danger { background-color: #dc3545; color: white; }
                            .text-end { text-align: right; }
                            .summary { margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; }
                        </style>
                    </head>
                    <body>
                        <h2>Fee Status Report - ${tabName}</h2>
                        <div class="summary">
                            <strong>Generated:</strong> ${new Date().toLocaleString()}<br>
                            <strong>Total Records:</strong> ${activeTab.querySelector('tbody tr').length}
                        </div>
                        ${printContent.innerHTML}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.print();
            });
        }
    }

    // Real-time data updates
    function initializeRealTimeUpdates() {
        // Refresh data every 2 minutes if enabled
        const refreshToggle = document.getElementById('autoRefreshToggle');
        let refreshInterval;
        
        if (refreshToggle) {
            refreshToggle.addEventListener('change', function() {
                if (this.checked) {
                    refreshInterval = setInterval(() => {
                        if (document.visibilityState === 'visible') {
                            refreshData();
                        }
                    }, 120000); // 2 minutes
                } else {
                    clearInterval(refreshInterval);
                }
            });
        }
    }

    function refreshData() {
        // Show refresh indicator
        const indicator = document.getElementById('refreshIndicator');
        if (!indicator) {
            const refreshDiv = document.createElement('div');
            refreshDiv.id = 'refreshIndicator';
            refreshDiv.className = 'alert alert-info alert-dismissible fade show';
            refreshDiv.innerHTML = `
                <i class="bi bi-arrow-clockwise me-2"></i>
                Auto-refreshing data...
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').prepend(refreshDiv);
        }
        
        // Reload page after short delay
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + 1-4 for tabs
        if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '4') {
            e.preventDefault();
            const tabIndex = parseInt(e.key) - 1;
            const tab = document.querySelectorAll('[data-bs-toggle="tab"]')[tabIndex];
            if (tab) bootstrap.Tab.getOrCreateInstance(tab).show();
        }
        
        // Ctrl/Cmd + E for export
        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
            e.preventDefault();
            document.getElementById('exportBtn')?.click();
        }
        
        // Ctrl/Cmd + P for print
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
            e.preventDefault();
            document.getElementById('printBtn')?.click();
        }
    });

    // Initialize all components
    initializeRealTimeUpdates();
});
</script>
{% endblock %}