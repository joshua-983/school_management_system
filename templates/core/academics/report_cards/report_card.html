<!-- core/academics/report_cards/report_card.html -->
{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load report_card_filters %}

{% block title %}{{ student.get_full_name }} - Report Card{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
/* CRITICAL FIX: Add CSS reset at the beginning */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #2c3e50;
    --primary-dark: #1a252f;
    --secondary: #34495e;
    --success: #27ae60;
    --danger: #e74c3c;
    --warning: #f39c12;
    --info: #3498db;
    --light: #f8f9fa;
    --dark: #2c3e50;
    --accent: #2980b9;
    --border-radius: 8px;
    --shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    --transition: all 0.3s ease;
}

body {
    background: #f8f9fa;
    min-height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 14px;
    line-height: 1.4;
}

.report-card-container {
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow);
    overflow: hidden;
    margin: 1rem auto;
    max-width: 1200px;
    border: 1px solid #e9ecef;
}

/* HEADER FIXES */
.report-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 1.5rem;
    position: relative;
    border-bottom: 3px solid var(--accent);
}

.school-logo {
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 6px;
    padding: 8px;
    background: rgba(255,255,255,0.1);
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.school-logo img {
    width: 60px;
    height: 60px;
    object-fit: contain;
}

.school-name {
    font-family: 'Georgia', serif;
    font-weight: 700;
    font-size: 1.4rem;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
}

/* EDIT MODE CRITICAL FIXES */
.edit-mode-indicator {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
    border-left: 4px solid #ffc107;
    color: #000;
    padding: 1rem;
    margin: 0;
}

.editable-field {
    border: 2px solid #007bff !important;
    background-color: #f8f9fa !important;
    font-weight: 500;
    padding: 0.3rem 0.5rem !important;
    border-radius: 4px;
    text-align: center;
}

.editable-field:focus {
    border-color: #0056b3 !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
    background-color: #fff !important;
}

.percentage-input {
    width: 80px;
    text-align: center;
    padding: 0.3rem 0.5rem;
    border-radius: 4px;
    border: 1px solid #ddd;
    font-weight: 600;
    transition: var(--transition);
}

.percentage-input-group .input-group-text {
    font-size: 0.8rem;
    font-weight: 600;
}

.remarks-input {
    width: 100%;
    padding: 0.5rem;
    border-radius: 4px;
    border: 1px solid #ddd;
    font-size: 0.85rem;
    transition: var(--transition);
}

/* INFO SECTIONS FIXES */
.additional-info-section,
.attendance-section,
.student-info-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    border: 1px solid #e9ecef;
}

.additional-info-grid,
.info-grid,
.attendance-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-top: 0.5rem;
}

.additional-info-item,
.info-item,
.attendance-item {
    background: white;
    padding: 0.8rem;
    border-radius: 6px;
    border: 1px solid #e9ecef;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

/* FIXED: Added missing label/value styles */
.additional-info-label,
.info-label,
.attendance-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 0.3rem;
}

.additional-info-value,
.info-value,
.attendance-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--primary);
}

/* STUDENT PHOTO FIXES - REDUCED SIZE */
.student-photo {
    border: 3px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    width: 120px;
    height: 160px;
    margin: 0 auto;
}

.student-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.student-photo-placeholder {
    border: 2px dashed #dee2e6;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    width: 120px;
    height: 160px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: #6c757d;
    border-radius: 8px;
    margin: 0 auto;
}

.student-photo-placeholder i {
    font-size: 3rem;
    margin-bottom: 0.5rem;
}

.student-photo-placeholder p {
    font-size: 0.75rem;
    margin-bottom: 0.25rem;
}

.student-photo-placeholder small {
    font-size: 0.65rem;
}

/* ATTENDANCE SECTION FIXES - UPDATED STYLING */
.attendance-section {
    background: #fff8e6;
    border-left: 4px solid var(--warning);
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

.attendance-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.attendance-item {
    background: white;
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid #e9ecef;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    text-align: center;
}

.attendance-value {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 0.25rem;
}

.attendance-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    font-weight: 600;
}

.attendance-status {
    margin-top: 0.75rem;
    text-align: center;
}

/* PERFORMANCE TABLE FIXES - UPDATED FOR PERCENTAGE SYSTEM */
.performance-table {
    border-radius: 8px;
    overflow: hidden;
    margin: 1.5rem 0;
    border: 1px solid #e9ecef;
    background: white;
}

.performance-table thead th {
    background: var(--primary);
    color: white;
    border: none;
    font-weight: 600;
    padding: 0.8rem 0.5rem;
    text-align: center;
    vertical-align: middle;
    font-size: 0.75rem;
    text-transform: uppercase;
    white-space: nowrap;
    line-height: 1.2;
}

.performance-table tbody td {
    padding: 0.75rem 0.5rem;
    vertical-align: middle;
    border-color: #f1f3f4;
    text-align: center;
    font-weight: 500;
}

/* WEIGHTED CONTRIBUTION STYLE */
.weighted-contribution {
    font-size: 0.7rem;
    color: #666;
    margin-top: 2px;
    display: block;
}

/* GRADE BADGE FIXES */
.grade-badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
    min-width: 35px;
    text-align: center;
    border-radius: 20px;
    font-weight: 700;
    display: inline-block;
}

.grade-1, .grade-2 { 
    background: #27ae60;
    color: white; 
}
.grade-3, .grade-4 { 
    background: #3498db;
    color: white; 
}
.grade-5, .grade-6 { 
    background: #f1c40f;
    color: #000; 
}
.grade-7, .grade-8 { 
    background: #e67e22;
    color: white; 
}
.grade-9, .grade-F { 
    background: #e74c3c;
    color: white; 
}

/* OVERALL PERFORMANCE FIX */
.overall-performance {
    background: var(--primary);
    color: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1.5rem 0;
}

.performance-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    text-align: center;
}

.stat-item {
    background: rgba(255,255,255,0.1);
    padding: 1rem;
    border-radius: 8px;
}

.stat-value {
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 0.3rem;
}

/* SIGNATURE SECTION FIX */
.signature-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 2rem;
    border-top: 3px solid var(--primary);
}

.signature-line {
    text-align: center;
    padding: 1rem;
}

.signature-name {
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.signature-space {
    border-top: 1px solid #bdc3c7;
    padding-top: 2rem;
    margin-top: 0.5rem;
    color: #7f8c8d;
    font-size: 0.8rem;
    height: 50px;
}

/* ACTION BUTTONS FIX */
.action-buttons {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 2rem;
    border: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn {
    border-radius: 6px;
    padding: 0.6rem 1.5rem;
    font-weight: 500;
    font-size: 0.85rem;
    border: none;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* ADD NEW GRADE FORM FIX - UPDATED FOR PERCENTAGE SYSTEM */
#addGradeForm {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

#addGradeForm .form-select,
#addGradeForm .form-control {
    height: 40px;
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid #ddd;
}

/* PERCENTAGE INPUT GROUP */
.input-group.percentage-group {
    width: 120px;
}

/* LOADING OVERLAY FIX */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
}

.loading-overlay .text-white {
    text-align: center;
    padding: 2rem;
    background: rgba(0,0,0,0.7);
    border-radius: 12px;
}

/* PRINT FIXES */
@media print {
    body {
        background: white !important;
        color: black !important;
        font-size: 11px !important;
    }
    
    .report-card-container {
        box-shadow: none !important;
        margin: 0 !important;
        border-radius: 0 !important;
        border: 1px solid #000 !important;
        width: 100%;
    }
    
    .no-print, .btn, .action-buttons, .input-group-text, .percentage-input-group {
        display: none !important;
    }
    
    .report-header {
        background: #f8f9fa !important;
        color: #000 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .grade-badge {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        border: 1px solid #000 !important;
    }
    
    /* Force page break after signature */
    .signature-section {
        page-break-inside: avoid;
    }
}

/* MOBILE RESPONSIVE FIXES */
@media (max-width: 768px) {
    .report-header {
        padding: 1rem;
        text-align: center;
    }
    
    .school-name {
        font-size: 1.1rem;
    }
    
    .performance-table {
        font-size: 0.7rem;
    }
    
    .performance-table thead th {
        padding: 0.5rem;
        font-size: 0.65rem;
    }
    
    .performance-table tbody td {
        padding: 0.5rem;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .action-buttons .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    /* Mobile table view */
    .performance-table thead {
        display: none;
    }
    
    .performance-table tbody tr {
        display: block;
        margin-bottom: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 0.5rem;
    }
    
    .performance-table tbody td {
        display: block;
        text-align: right;
        padding-left: 50%;
        position: relative;
        border: none;
        border-bottom: 1px solid #eee;
    }
    
    .performance-table tbody td:last-child {
        border-bottom: none;
    }
    
    .performance-table tbody td::before {
        content: attr(data-label);
        position: absolute;
        left: 1rem;
        font-weight: 600;
        color: var(--primary);
        text-align: left;
    }
    
    /* Adjust for percentage inputs on mobile */
    .percentage-input-group {
        width: 100% !important;
    }
}

/* FIX FOR DATA LABELS ON MOBILE */
@media (max-width: 768px) {
    td[data-label]::before {
        font-weight: 600 !important;
        color: var(--primary) !important;
        background: #f8f9fa;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
    }
}

/* ERROR STATE FIXES */
.is-invalid {
    border-color: #dc3545 !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(.375em + .1875rem) center;
    background-size: calc(.75em + .375rem) calc(.75em + .375rem);
}

.error-message {
    color: #dc3545;
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

/* SCROLLBAR FIX */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* TOOLTIP FIX */
[data-bs-toggle="tooltip"] {
    cursor: help;
}

/* FOCUS STATES FIX */
:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* CONFIG WEIGHT DISPLAY */
.weight-display {
    font-size: 0.75rem;
    opacity: 0.8;
    font-weight: 500;
}

/* ATTENDANCE STATUS BADGE */
.attendance-badge {
    font-size: 0.75rem;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-weight: 600;
}

.attendance-excellent { background: #27ae60; color: white; }
.attendance-good { background: #3498db; color: white; }
.attendance-satisfactory { background: #f1c40f; color: #000; }
.attendance-needs-improvement { background: #e67e22; color: white; }
.attendance-unsatisfactory { background: #e74c3c; color: white; }

/* DEBUG STYLES */
.debug-info {
    background: #f8f9fa;
    border-left: 4px solid #6c757d;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    color: #6c757d;
}

.debug-info .debug-label {
    font-weight: 600;
    margin-right: 0.5rem;
}

/* POSITION DISPLAY STYLING */
.position-display {
    font-weight: 700;
    color: var(--primary);
    font-size: 1rem;
}

.position-subtext {
    font-size: 0.7rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

/* FIXED: Add CSS for toast notifications */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
}

.custom-toast {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
    min-width: 300px;
    max-width: 400px;
    display: flex;
    align-items: center;
    animation: slideInRight 0.3s ease-out;
    border-left: 4px solid;
}

.custom-toast.success {
    border-left-color: var(--success);
}

.custom-toast.error {
    border-left-color: var(--danger);
}

.custom-toast.warning {
    border-left-color: var(--warning);
}

.custom-toast.info {
    border-left-color: var(--info);
}

.custom-toast .toast-icon {
    font-size: 1.5rem;
    margin-right: 1rem;
    flex-shrink: 0;
}

.custom-toast .toast-content {
    flex-grow: 1;
}

.custom-toast .toast-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.custom-toast .toast-message {
    font-size: 0.9rem;
    color: #666;
}

.custom-toast .toast-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    color: #999;
    cursor: pointer;
    padding: 0;
    margin-left: 1rem;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="report-card-container">
        <!-- Professional Header -->
        <div class="report-header">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    <div class="school-logo">
                        <img src="{% static 'img/school-logo.png' %}" alt="School Logo" 
                             onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHJ4PSI4IiBmaWxsPSIjMmMzZTUwIi8+PHBhdGggZD0iTTIwIDI1aDIwdjEwSDBWMjVoMTVtMjAgMTBIMjB2MTBoMjB2LTEwTTIwIDQwSDQwdjEwSDBWNDBoMTVtMjAgMTBIMjB2MTBoMjB2LTEwIiBmaWxsPSIjZmZmIi8+PC9zdmc+';">
                    </div>
                </div>
                <div class="col-md-8 text-center">
                    <h1 class="school-name mb-2">JUDITH INTERNATIONAL SCHOOL</h1>
                    <p class="school-motto mb-2"><i>"Excellence in Education and Character Development"</i></p>
                    <h2 class="mb-0" style="font-size: 1.1rem; font-weight: 600;">ACADEMIC REPORT CARD</h2>
                </div>
                <div class="col-md-2 text-center">
                    <div class="report-id bg-white text-dark p-2 rounded" style="font-size: 0.8rem;">
                        <strong>ID: {{ report_card.id|default:"DRAFT" }}</strong>
                        <br>
                        <small>{{ academic_year }} - Term {{ term }}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Mode Indicator -->
        {% if editable_mode %}
        <div class="edit-mode-indicator no-print">
            <div class="d-flex align-items-center">
                <i class="fas fa-edit fa-lg me-3"></i>
                <div class="flex-grow-1">
                    <h5 class="mb-1 fw-bold">Edit Mode Active</h5>
                    <p class="mb-0">You can now edit grades and remarks. Changes are saved when you click the save buttons.</p>
                </div>
                <div class="badge bg-dark fs-6">EDITING</div>
            </div>
        </div>
        {% endif %}

        <!-- Debug Information -->
        {% if debug_mode %}
        <div class="debug-info no-print">
            <div class="row">
                <div class="col-md-3">
                    <span class="debug-label">Grades:</span> {{ grades.count }}
                </div>
                <div class="col-md-3">
                    <span class="debug-label">Attendance Data:</span> {{ attendance.total_days }} days
                </div>
                <div class="col-md-3">
                    <span class="debug-label">Position:</span> {{ position_in_class|default:"Not calculated" }}
                </div>
                <div class="col-md-3">
                    <span class="debug-label">Class:</span> {{ student.get_class_level_display }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Main Content Container -->
        <div class="container-fluid p-3">
            <!-- Additional Information Section - FIXED -->
            <div class="additional-info-section">
                <h5 class="mb-2" style="font-size: 0.9rem; color: var(--primary);">
                    <i class="fas fa-calendar-alt me-2"></i>Academic Calendar Information
                </h5>
                <div class="additional-info-grid">
                    <div class="additional-info-item">
                        <div class="additional-info-label">Vacation Date</div>
                        <div class="additional-info-value">
                            {% if vacation_date and vacation_date != "To be announced" %}
                                {{ vacation_date }}
                            {% else %}
                                <span class="text-muted">To be announced</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="additional-info-item">
                        <div class="additional-info-label">Reopening Date</div>
                        <div class="additional-info-value">
                            {% if reopening_date and reopening_date != "To be announced" %}
                                {{ reopening_date }}
                            {% else %}
                                <span class="text-muted">To be announced</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="additional-info-item">
                        <div class="additional-info-label">Position in Class</div>
                        <div class="additional-info-value position-display" id="position-in-class">
                            {% if position_in_class and position_in_class != "Not ranked" and position_in_class != "Error calculating position" %}
                                {{ position_in_class }}
                                {% if debug_mode %}
                                <div class="position-subtext">
                                    (Class: {{ student.get_class_level_display }})
                                </div>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">
                                    {% if position_in_class == "Error calculating position" %}
                                        Calculation Error
                                    {% else %}
                                        Not ranked
                                    {% endif %}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Information Section - FIXED -->
            <div class="student-info-section">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2" style="font-size: 0.9rem; color: var(--primary);">
                            <i class="fas fa-user-graduate me-2"></i>Student Information
                        </h5>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Student Name</div>
                                <div class="info-value fw-bold">{{ student.get_full_name }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Student ID</div>
                                <div class="info-value">{{ student.student_id }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Class Level</div>
                                <div class="info-value">{{ student.get_class_level_display }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Academic Year</div>
                                <div class="info-value">{{ academic_year }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Term</div>
                                <div class="info-value">Term {{ term }}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Gender</div>
                                <div class="info-value">{{ student.get_gender_display }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <!-- Student Photo Section - FIXED SIZE -->
                        {% if student.profile_picture and student.profile_picture.url %}
                        <div class="student-photo mb-3" style="width: 120px; height: 150px; margin: 0 auto;">
                            <img src="{{ student.profile_picture.url }}" 
                                 alt="{{ student.get_full_name }}"
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"
                                 onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\"student-photo-placeholder\" style=\"width: 120px; height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 2px dashed #ddd; border-radius: 8px;\"><i class=\"fas fa-user-graduate fa-2x text-muted mb-2\"></i><p class=\"text-muted mb-0 fw-bold\" style=\"font-size: 0.8rem;\">Photo Not Available</p><small class=\"text-muted\" style=\"font-size: 0.7rem;\">ID: {{ student.student_id }}</small></div>'">
                        </div>
                        {% else %}
                        <div class="student-photo-placeholder" style="width: 120px; height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 2px dashed #ddd; border-radius: 8px; margin: 0 auto;">
                            <i class="fas fa-user-graduate fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0 fw-bold" style="font-size: 0.8rem;">Student Photo</p>
                            <small class="text-muted" style="font-size: 0.7rem;">ID: {{ student.student_id }}</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Attendance Section - FIXED -->
            <div class="attendance-section">
                <h5 class="mb-2" style="font-size: 0.9rem; color: var(--primary);">
                    <i class="fas fa-calendar-check me-2"></i>Attendance Summary
                    {% if debug_mode and attendance.total_days == 0 %}
                    <small class="text-muted">(No attendance records found)</small>
                    {% endif %}
                </h5>
                <div class="attendance-stats">
                    <div class="attendance-item">
                        <div class="attendance-value" id="attendance-present">
                            {{ attendance.present_days|default:"0" }}
                        </div>
                        <div class="attendance-label">Days Present</div>
                    </div>
                    <div class="attendance-item">
                        <div class="attendance-value" id="attendance-total">
                            {{ attendance.total_days|default:"0" }}
                        </div>
                        <div class="attendance-label">Total Days</div>
                    </div>
                    <div class="attendance-item">
                        <div class="attendance-value" id="attendance-rate">
                            {{ attendance.attendance_rate|default:"0"|floatformat:1 }}%
                        </div>
                        <div class="attendance-label">Attendance Rate</div>
                    </div>
                    <div class="attendance-item">
                        <div class="attendance-value" id="attendance-absent">
                            {{ attendance.absence_count|default:"0" }}
                        </div>
                        <div class="attendance-label">Days Absent</div>
                    </div>
                </div>
                
                <!-- Show attendance status if available -->
                {% if attendance.attendance_status %}
                <div class="attendance-status">
                    <span class="badge 
                        {% if attendance.attendance_status == 'Excellent' %}attendance-excellent
                        {% elif attendance.attendance_status == 'Good' %}attendance-good
                        {% elif attendance.attendance_status == 'Satisfactory' %}attendance-satisfactory
                        {% elif attendance.attendance_status == 'Needs Improvement' %}attendance-needs-improvement
                        {% else %}attendance-unsatisfactory{% endif %}"
                        style="font-size: 0.75rem;">
                        {{ attendance.attendance_status }}
                        {% if attendance.is_ges_compliant %}
                        <i class="fas fa-check-circle ms-1"></i>
                        {% endif %}
                    </span>
                    <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">
                        GES Compliant: {% if attendance.is_ges_compliant %}Yes{% else %}No{% endif %}
                    </small>
                </div>
                {% endif %}
            </div>

            <!-- Overall Performance Summary -->
            {% if grades %}
            <div class="overall-performance">
                <div class="performance-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ average_score|floatformat:1 }}%</div>
                        <div class="stat-label">Overall Average</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ overall_grade }}</div>
                        <div class="stat-label">Final Grade</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ grades|length }}</div>
                        <div class="stat-label">Subjects</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">
                            {% with total=grades|length passed=grades|length %}
                            {{ passed }}/{{ total }}
                            {% endwith %}
                        </div>
                        <div class="stat-label">Subjects Passed</div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- ACADEMIC PERFORMANCE TABLE - UPDATED FOR PERCENTAGE SYSTEM -->
            <div class="performance-table-container">
                <div class="performance-table">
                    <table class="table table-bordered table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th class="text-center">Homework<br>
                                    <small class="weight-display">{{ config.homework_weight|default:20 }}% weight</small>
                                </th>
                                <th class="text-center">Classwork<br>
                                    <small class="weight-display">{{ config.classwork_weight|default:30 }}% weight</small>
                                </th>
                                <th class="text-center">Test<br>
                                    <small class="weight-display">{{ config.test_weight|default:10 }}% weight</small>
                                </th>
                                <th class="text-center">Exam<br>
                                    <small class="weight-display">{{ config.exam_weight|default:40 }}% weight</small>
                                </th>
                                <th class="text-center">Total<br>
                                    <small class="weight-display">100%</small>
                                </th>
                                <th class="text-center">Grade</th>
                                <th class="text-center">Remarks</th>
                                {% if editable_mode %}
                                <th class="text-center no-print">Actions</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody id="grades-table-body">
                            {% for grade in grades %}
                            {% with contributions=grade.get_weighted_contributions %}
                            <tr id="grade-row-{{ grade.id }}">
                                <td data-label="Subject" class="fw-bold">{{ grade.subject.name }}</td>
                                
                                <!-- Homework Score - PERCENTAGE BASED -->
                                <td data-label="Homework" class="text-center">
                                    {% if editable_mode %}
                                    <div class="input-group input-group-sm percentage-input-group">
                                        <input type="number" class="form-control percentage-input editable-field homework-input" 
                                               name="homework_percentage_{{ grade.id }}" 
                                               value="{{ grade.homework_percentage|floatformat:1|default:'0.0' }}" 
                                               min="0" max="100" step="0.1"
                                               data-grade-id="{{ grade.id }}"
                                               data-field="homework_percentage">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="weighted-contribution homework-contribution" id="homework-contribution-{{ grade.id }}">
                                        = {{ contributions.homework.contribution|floatformat:1 }} of {{ config.homework_weight|default:20 }}%
                                    </small>
                                    {% else %}
                                    <strong>{{ grade.homework_percentage|floatformat:1|default:'0.0' }}%</strong>
                                    <br>
                                    <small class="weighted-contribution">
                                        ({{ contributions.homework.contribution|floatformat:1 }}/{{ config.homework_weight|default:20 }}%)
                                    </small>
                                    {% endif %}
                                </td>
                                
                                <!-- Classwork Score - PERCENTAGE BASED -->
                                <td data-label="Classwork" class="text-center">
                                    {% if editable_mode %}
                                    <div class="input-group input-group-sm percentage-input-group">
                                        <input type="number" class="form-control percentage-input editable-field classwork-input" 
                                               name="classwork_percentage_{{ grade.id }}" 
                                               value="{{ grade.classwork_percentage|floatformat:1|default:'0.0' }}" 
                                               min="0" max="100" step="0.1"
                                               data-grade-id="{{ grade.id }}"
                                               data-field="classwork_percentage">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="weighted-contribution classwork-contribution" id="classwork-contribution-{{ grade.id }}">
                                        = {{ contributions.classwork.contribution|floatformat:1 }} of {{ config.classwork_weight|default:30 }}%
                                    </small>
                                    {% else %}
                                    <strong>{{ grade.classwork_percentage|floatformat:1|default:'0.0' }}%</strong>
                                    <br>
                                    <small class="weighted-contribution">
                                        ({{ contributions.classwork.contribution|floatformat:1 }}/{{ config.classwork_weight|default:30 }}%)
                                    </small>
                                    {% endif %}
                                </td>
                                
                                <!-- Test Score - PERCENTAGE BASED -->
                                <td data-label="Test" class="text-center">
                                    {% if editable_mode %}
                                    <div class="input-group input-group-sm percentage-input-group">
                                        <input type="number" class="form-control percentage-input editable-field test-input" 
                                               name="test_percentage_{{ grade.id }}" 
                                               value="{{ grade.test_percentage|floatformat:1|default:'0.0' }}" 
                                               min="0" max="100" step="0.1"
                                               data-grade-id="{{ grade.id }}"
                                               data-field="test_percentage">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="weighted-contribution test-contribution" id="test-contribution-{{ grade.id }}">
                                        = {{ contributions.test.contribution|floatformat:1 }} of {{ config.test_weight|default:10 }}%
                                    </small>
                                    {% else %}
                                    <strong>{{ grade.test_percentage|floatformat:1|default:'0.0' }}%</strong>
                                    <br>
                                    <small class="weighted-contribution">
                                        ({{ contributions.test.contribution|floatformat:1 }}/{{ config.test_weight|default:10 }}%)
                                    </small>
                                    {% endif %}
                                </td>
                                
                                <!-- Exam Score - PERCENTAGE BASED -->
                                <td data-label="Exam" class="text-center">
                                    {% if editable_mode %}
                                    <div class="input-group input-group-sm percentage-input-group">
                                        <input type="number" class="form-control percentage-input editable-field exam-input" 
                                               name="exam_percentage_{{ grade.id }}" 
                                               value="{{ grade.exam_percentage|floatformat:1|default:'0.0' }}" 
                                               min="0" max="100" step="0.1"
                                               data-grade-id="{{ grade.id }}"
                                               data-field="exam_percentage">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="weighted-contribution exam-contribution" id="exam-contribution-{{ grade.id }}">
                                        = {{ contributions.exam.contribution|floatformat:1 }} of {{ config.exam_weight|default:40 }}%
                                    </small>
                                    {% else %}
                                    <strong>{{ grade.exam_percentage|floatformat:1|default:'0.0' }}%</strong>
                                    <br>
                                    <small class="weighted-contribution">
                                        ({{ contributions.exam.contribution|floatformat:1 }}/{{ config.exam_weight|default:40 }}%)
                                    </small>
                                    {% endif %}
                                </td>
                                
                                <!-- Total Score -->
                                <td data-label="Total" class="text-center fw-bold">
                                    <span id="total_{{ grade.id }}" class="grade-total">
                                        {{ grade.total_score|floatformat:1|default:'0.0' }}%
                                    </span>
                                </td>
                                
                                <!-- Grade Badge -->
                                <td data-label="Grade" class="text-center">
                                    <span class="badge grade-badge grade-{{ grade.ges_grade|default:'9' }}"
                                          id="grade-badge-{{ grade.id }}">
                                        {{ grade.ges_grade|default:'9' }}
                                    </span>
                                </td>
                                
                                <!-- Remarks -->
                                <td data-label="Remarks" class="text-center">
                                    {% if editable_mode %}
                                    <input type="text" class="remarks-input editable-field" 
                                           name="remarks_{{ grade.id }}" 
                                           value="{{ grade.remarks|default:'' }}" 
                                           placeholder="Enter remarks..."
                                           data-grade-id="{{ grade.id }}"
                                           data-field="remarks">
                                    {% else %}
                                    {{ grade.remarks|default:"-" }}
                                    {% endif %}
                                </td>
                                
                                <!-- Actions (Edit Mode Only) -->
                                {% if editable_mode %}
                                <td data-label="Actions" class="text-center no-print">
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-success update-grade-btn" 
                                                data-grade-id="{{ grade.id }}"
                                                title="Save Changes">
                                            <i class="fas fa-save"></i>
                                        </button>
                                        <button type="button" class="btn btn-danger delete-grade-btn" 
                                                data-grade-id="{{ grade.id }}"
                                                title="Delete Grade">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                            {% endwith %}
                            {% empty %}
                            <tr id="no-grades-row">
                                <td colspan="{% if editable_mode %}9{% else %}8{% endif %}" class="text-center py-4" style="font-size: 0.8rem;">
                                    <i class="fas fa-inbox fa-2x mb-2 d-block text-muted"></i>
                                    No grades available for this academic period
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add New Grade Form (Edit Mode Only) - UPDATED FOR PERCENTAGE SYSTEM -->
            {% if editable_mode and can_edit %}
            <div class="card mt-3 no-print">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-plus me-2"></i>Add New Subject Grade</h6>
                </div>
                <div class="card-body">
                    <!-- FIXED: Added action attribute to the form -->
                    <form id="addGradeForm" class="row g-2" 
                          action="{% url 'add_grade' student.id %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="academic_year" value="{{ academic_year }}">
                        <input type="hidden" name="term" value="{{ term }}">
                        <input type="hidden" name="student_id" value="{{ student.id }}">
                        <div class="col-md-3">
                            <label class="form-label">Subject</label>
                            <select name="subject" class="form-select" required id="new-grade-subject">
                                <option value="">Select Subject</option>
                                {% for subject in available_subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Homework (%)</label>
                            <div class="input-group">
                                <input type="number" name="homework_percentage" class="form-control" min="0" max="100" step="0.1" value="0" required>
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">{{ config.homework_weight|default:20 }}% weight</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Classwork (%)</label>
                            <div class="input-group">
                                <input type="number" name="classwork_percentage" class="form-control" min="0" max="100" step="0.1" value="0" required>
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">{{ config.classwork_weight|default:30 }}% weight</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Test (%)</label>
                            <div class="input-group">
                                <input type="number" name="test_percentage" class="form-control" min="0" max="100" step="0.1" value="0" required>
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">{{ config.test_weight|default:10 }}% weight</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Exam (%)</label>
                            <div class="input-group">
                                <input type="number" name="exam_percentage" class="form-control" min="0" max="100" step="0.1" value="0" required>
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">{{ config.exam_weight|default:40 }}% weight</small>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100" id="add-grade-btn">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Grading System and Performance Analysis -->
            <div class="row mt-3">
                <!-- Grading Scale -->
                <div class="col-md-6 mb-3">
                    <div class="card summary-card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-graduation-cap me-2"></i>Grading System</h6>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0" style="font-size: 0.8rem;">
                                <thead>
                                    <tr>
                                        <th>Grade</th>
                                        <th>Score Range</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>1</td><td>90 - 100%</td><td>Outstanding</td></tr>
                                    <tr><td>2</td><td>80 - 89%</td><td>Excellent</td></tr>
                                    <tr><td>3</td><td>70 - 79%</td><td>Very Good</td></tr>
                                    <tr><td>4</td><td>60 - 69%</td><td>Good</td></tr>
                                    <tr><td>5</td><td>50 - 59%</td><td>Satisfactory</td></tr>
                                    <tr><td>6</td><td>40 - 49%</td><td>Fair</td></tr>
                                    <tr><td>7</td><td>30 - 39%</td><td>Weak</td></tr>
                                    <tr><td>8</td><td>20 - 29%</td><td>Very Weak</td></tr>
                                    <tr><td>9</td><td>0 - 19%</td><td>Fail</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="col-md-6 mb-3">
                    <div class="card summary-card h-100">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Performance Analysis</h6>
                        </div>
                        <div class="card-body">
                            {% if grades %}
                            <div class="chart-container" style="height: 200px; position: relative;">
                                <canvas id="performanceChart"></canvas>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-3" style="font-size: 0.8rem;">
                                <i class="fas fa-chart-bar fa-2x mb-2 d-block"></i>
                                <p>Performance data not available</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signature Section -->
            <div class="signature-section">
                <div class="row">
                    <div class="col-md-4">
                        <div class="signature-line">
                            <div class="signature-name">Class Teacher</div>
                            <div class="signature-space"></div>
                            <small>Signature & Date</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="signature-line">
                            <div class="signature-name">Head of Department</div>
                            <div class="signature-space"></div>
                            <small>Signature & Date</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="signature-line">
                            <div class="signature-name">School Principal</div>
                            <div class="signature-space"></div>
                            <small>Signature & Date</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons no-print">
                <div>
                    {% if not report_card and is_teacher and not editable_mode %}
                    <form method="post" action="{% url 'save_report_card' student.pk %}" class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="academic_year" value="{{ academic_year }}">
                        <input type="hidden" name="term" value="{{ term }}">
                        <button type="submit" class="btn btn-success me-2">
                            <i class="fas fa-save me-1"></i> Save Report
                        </button>
                    </form>
                    {% elif editable_mode and can_edit %}
                    <!-- Edit mode buttons -->
                    <div class="btn-group">
                        <button type="button" class="btn btn-success me-2" id="saveAllChangesBtn">
                            <i class="fas fa-save me-1"></i> Save All Changes
                        </button>
                        <button type="button" class="btn btn-primary me-2" id="recalculateTotalsBtn">
                            <i class="fas fa-calculator me-1"></i> Recalculate
                        </button>
                        <a href="{% url 'report_card_dashboard' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i> Cancel
                        </a>
                    </div>
                    {% endif %}
                </div>
                <div>
                    <div class="btn-group">
                        {% if not editable_mode and can_edit %}
                        <!-- Edit button when not in edit mode -->
                        <a href="?editable=true{% if report_card %}&report_card_id={{ report_card.id }}{% endif %}" 
                           class="btn btn-warning me-2">
                            <i class="fas fa-edit me-1"></i> Edit Report Card
                        </a>
                        {% endif %}
                        
                        <button onclick="window.print()" class="btn btn-info me-2">
                            <i class="fas fa-print me-1"></i> Print
                        </button>
                        <a href="{% if report_card %}{% url 'report_card_pdf_detail' student.pk report_card.pk %}{% else %}{% url 'report_card_pdf' student.pk %}?academic_year={{ academic_year }}&term={{ term }}{% endif %}" 
                           class="btn btn-danger me-2" id="pdfDownloadBtn">
                            <i class="fas fa-file-pdf me-1"></i> Export PDF
                        </a>
                        <a href="{% url 'report_card_dashboard' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <!-- Warning Alert for Draft Report Cards -->
            {% if not report_card and not editable_mode %}
            <div class="alert alert-warning mt-2 no-print" style="font-size: 0.8rem;">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <div>
                        <strong>Preview Mode</strong> - This is a draft preview of the report card. 
                        {% if is_teacher %}Save it to create an official record.{% else %}This document is not yet finalized.{% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center text-white">
        <div class="spinner-border text-light mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5>Processing...</h5>
        <p>Please wait while we process your request</p>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div class="toast-container" id="toastContainer"></div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log(' Report Card Page Initialized - Percentage System');
    
    // Get CSRF token safely
    function getCSRFToken() {
        // Try multiple ways to get the CSRF token
        let csrfToken = '';
        
        // Method 1: From meta tag
        const metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken) {
            csrfToken = metaToken.getAttribute('content');
        }
        
        // Method 2: From hidden input
        if (!csrfToken) {
            const inputToken = document.querySelector('[name="csrfmiddlewaretoken"]');
            if (inputToken) {
                csrfToken = inputToken.value;
            }
        }
        
        // Method 3: From cookies (fallback)
        if (!csrfToken) {
            csrfToken = getCookie('csrftoken');
        }
        
        if (!csrfToken) {
            console.warn('CSRF token not found!');
        }
        
        return csrfToken;
    }
    
    // Helper to get cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Toast Notification System
    function showToast(type, title, message) {
        const icons = {
            success: 'fas fa-check-circle text-success',
            error: 'fas fa-times-circle text-danger',
            warning: 'fas fa-exclamation-triangle text-warning',
            info: 'fas fa-info-circle text-info'
        };
        
        const toast = document.createElement('div');
        toast.className = `custom-toast ${type}`;
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="${icons[type]}"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        const container = document.getElementById('toastContainer');
        if (container) {
            container.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }
    }
    
    // Show loading overlay
    function showLoading(message = 'Processing...') {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.querySelector('h5').textContent = message;
            overlay.style.display = 'flex';
        }
    }
    
    // Hide loading overlay
    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.style.display = 'none';
    }
    
    // Parse JSON response or handle HTML error
    function parseResponse(response) {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            // It's HTML, likely an error page
            return response.text().then(html => {
                throw new Error('Server returned HTML instead of JSON. Please refresh the page.');
            });
        }
    }
    
    // =============================================
    // PERCENTAGE-BASED EDIT MODE FUNCTIONALITY - FIXED
    // =============================================
    {% if editable_mode %}
    
    // Get configuration weights from template
    const homeworkWeight = {{ config.homework_weight|default:20 }};
    const classworkWeight = {{ config.classwork_weight|default:30 }};
    const testWeight = {{ config.test_weight|default:10 }};
    const examWeight = {{ config.exam_weight|default:40 }};
    
    // Auto-calculate totals when percentage inputs change
    document.querySelectorAll('.percentage-input').forEach(input => {
        input.addEventListener('input', function() {
            const gradeId = this.getAttribute('data-grade-id');
            if (gradeId) {
                calculateTotal(gradeId);
            }
        });
    });

    // Calculate total for a specific grade using percentage system
    function calculateTotal(gradeId) {
        const homeworkInput = document.querySelector(`input[name="homework_percentage_${gradeId}"]`);
        const classworkInput = document.querySelector(`input[name="classwork_percentage_${gradeId}"]`);
        const testInput = document.querySelector(`input[name="test_percentage_${gradeId}"]`);
        const examInput = document.querySelector(`input[name="exam_percentage_${gradeId}"]`);
        
        const homeworkPercent = parseFloat(homeworkInput?.value) || 0;
        const classworkPercent = parseFloat(classworkInput?.value) || 0;
        const testPercent = parseFloat(testInput?.value) || 0;
        const examPercent = parseFloat(examInput?.value) || 0;
        
        // Calculate weighted contributions
        const homeworkContribution = (homeworkPercent / 100) * homeworkWeight;
        const classworkContribution = (classworkPercent / 100) * classworkWeight;
        const testContribution = (testPercent / 100) * testWeight;
        const examContribution = (examPercent / 100) * examWeight;
        
        const total = homeworkContribution + classworkContribution + testContribution + examContribution;
        
        // Update display
        const totalElement = document.getElementById(`total_${gradeId}`);
        if (totalElement) {
            totalElement.textContent = total.toFixed(1) + '%';
            updateGradeBadge(gradeId, total);
        }
        
        // Update weighted contribution display
        updateWeightedDisplay(gradeId, {
            homework: homeworkContribution,
            classwork: classworkContribution,
            test: testContribution,
            exam: examContribution
        });
    }

    // Update weighted contribution display
    function updateWeightedDisplay(gradeId, contributions) {
        // Update homework contribution
        const homeworkSmall = document.getElementById(`homework-contribution-${gradeId}`);
        if (homeworkSmall) {
            homeworkSmall.textContent = `= ${contributions.homework.toFixed(1)} of ${homeworkWeight}%`;
        }
        
        // Update classwork contribution
        const classworkSmall = document.getElementById(`classwork-contribution-${gradeId}`);
        if (classworkSmall) {
            classworkSmall.textContent = `= ${contributions.classwork.toFixed(1)} of ${classworkWeight}%`;
        }
        
        // Update test contribution
        const testSmall = document.getElementById(`test-contribution-${gradeId}`);
        if (testSmall) {
            testSmall.textContent = `= ${contributions.test.toFixed(1)} of ${testWeight}%`;
        }
        
        // Update exam contribution
        const examSmall = document.getElementById(`exam-contribution-${gradeId}`);
        if (examSmall) {
            examSmall.textContent = `= ${contributions.exam.toFixed(1)} of ${examWeight}%`;
        }
    }

    // Update grade badge based on score (GES System: 1-9)
    function updateGradeBadge(gradeId, score) {
        const badge = document.getElementById(`grade-badge-${gradeId}`);
        if (!badge) return;
        
        let grade = '9'; // Default to fail
        if (score >= 90) grade = '1';
        else if (score >= 80) grade = '2';
        else if (score >= 70) grade = '3';
        else if (score >= 60) grade = '4';
        else if (score >= 50) grade = '5';
        else if (score >= 40) grade = '6';
        else if (score >= 30) grade = '7';
        else if (score >= 20) grade = '8';
        
        badge.textContent = grade;
        
        // Set badge color
        const colorClass = getGradeColorClass(grade);
        badge.className = `badge grade-badge ${colorClass}`;
    }
    
    // Get CSS class for grade color
    function getGradeColorClass(grade) {
        if (grade === '1' || grade === '2') return 'grade-1-2';
        if (grade === '3' || grade === '4') return 'grade-3-4';
        if (grade === '5' || grade === '6') return 'grade-5-6';
        if (grade === '7' || grade === '8') return 'grade-7-8';
        return 'grade-9';
    }

    // Update individual grade - FIXED VERSION
    function updateGrade(gradeId) {
        const homeworkInput = document.querySelector(`input[name="homework_percentage_${gradeId}"]`);
        const classworkInput = document.querySelector(`input[name="classwork_percentage_${gradeId}"]`);
        const testInput = document.querySelector(`input[name="test_percentage_${gradeId}"]`);
        const examInput = document.querySelector(`input[name="exam_percentage_${gradeId}"]`);
        const remarksInput = document.querySelector(`input[name="remarks_${gradeId}"]`);
        
        if (!homeworkInput || !classworkInput || !testInput || !examInput) {
            showToast('error', 'Error', 'Missing grade input fields');
            return;
        }
        
        const homework = parseFloat(homeworkInput.value) || 0;
        const classwork = parseFloat(classworkInput.value) || 0;
        const test = parseFloat(testInput.value) || 0;
        const exam = parseFloat(examInput.value) || 0;
        const remarks = remarksInput?.value || '';
        
        showLoading('Saving grade...');
        
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            showToast('error', 'Security Error', 'Please refresh the page and try again.');
            hideLoading();
            return;
        }
        
        // Send the update request
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        formData.append('homework_percentage', homework);
        formData.append('classwork_percentage', classwork);
        formData.append('test_percentage', test);
        formData.append('exam_percentage', exam);
        formData.append('remarks', remarks);
        formData.append('grade_id', gradeId);
        
        fetch(`/grades/${gradeId}/edit/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(parseResponse)
        .then(data => {
            hideLoading();
            if (data.success) {
                showToast('success', 'Success', 'Grade updated successfully!');
                
                // Update display with new data
                if (data.total_score !== undefined) {
                    const totalElement = document.getElementById(`total_${gradeId}`);
                    if (totalElement) {
                        totalElement.textContent = parseFloat(data.total_score).toFixed(1) + '%';
                        updateGradeBadge(gradeId, parseFloat(data.total_score));
                    }
                }
                
                // Update form fields if returned
                if (data.homework_percentage !== undefined && homeworkInput) {
                    homeworkInput.value = data.homework_percentage;
                }
                if (data.classwork_percentage !== undefined && classworkInput) {
                    classworkInput.value = data.classwork_percentage;
                }
                if (data.test_percentage !== undefined && testInput) {
                    testInput.value = data.test_percentage;
                }
                if (data.exam_percentage !== undefined && examInput) {
                    examInput.value = data.exam_percentage;
                }
                if (data.remarks !== undefined && remarksInput) {
                    remarksInput.value = data.remarks;
                }
            } else {
                showToast('error', 'Error', data.error || 'Failed to update grade');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Update error:', error);
            
            if (error.message.includes('HTML instead of JSON')) {
                showToast('error', 'Session Expired', 'Please refresh the page and log in again.');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showToast('error', 'Error', 'Failed to update grade: ' + error.message);
            }
        });
    }

    // Add event listeners for update buttons
    document.querySelectorAll('.update-grade-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const gradeId = this.getAttribute('data-grade-id');
            if (gradeId) {
                updateGrade(gradeId);
            }
        });
    });

    // Save all changes - SIMPLIFIED VERSION
    document.getElementById('saveAllChangesBtn')?.addEventListener('click', function() {
        const updateButtons = document.querySelectorAll('.update-grade-btn');
        
        if (updateButtons.length === 0) {
            showToast('info', 'Info', 'No grades to save.');
            return;
        }
        
        if (confirm(`Are you sure you want to save changes for ${updateButtons.length} grades?`)) {
            const btn = this;
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving All...';
            
            let savedCount = 0;
            let errorCount = 0;
            
            const processNext = (index) => {
                if (index >= updateButtons.length) {
                    // All processed
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    
                    if (errorCount === 0) {
                        showToast('success', 'Success', `Successfully saved all ${savedCount} grades.`);
                    } else {
                        showToast('warning', 'Partial Success', 
                            `${savedCount} saved, ${errorCount} failed. Please check individual grades.`);
                    }
                    return;
                }
                
                const gradeId = updateButtons[index].getAttribute('data-grade-id');
                if (gradeId) {
                    // Simulate click to trigger update
                    updateButtons[index].click();
                    
                    // Wait a bit before next
                    setTimeout(() => {
                        savedCount++;
                        processNext(index + 1);
                    }, 800);
                } else {
                    processNext(index + 1);
                }
            };
            
            showLoading(`Saving ${updateButtons.length} grades...`);
            processNext(0);
        }
    });

    // Recalculate all totals
    document.getElementById('recalculateTotalsBtn')?.addEventListener('click', function() {
        const gradeIds = [];
        document.querySelectorAll('.update-grade-btn').forEach(btn => {
            const gradeId = btn.getAttribute('data-grade-id');
            if (gradeId) gradeIds.push(gradeId);
        });
        
        gradeIds.forEach(gradeId => {
            calculateTotal(gradeId);
        });
        
        showToast('info', 'Recalculated', `Recalculated totals for ${gradeIds.length} subjects`);
    });

    // =============================================
    // FIXED: Add new grade form functionality
    // =============================================
    document.getElementById('addGradeForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('add-grade-btn');
        const csrfToken = getCSRFToken();
        
        if (!csrfToken) {
            showToast('error', 'Security Error', 'Please refresh the page and try again.');
            return;
        }
        
        // Validate subject selection
        const subjectSelect = document.getElementById('new-grade-subject');
        if (!subjectSelect || !subjectSelect.value) {
            showToast('error', 'Validation Error', 'Please select a subject.');
            return;
        }
        
        // Validate percentage values
        const homeworkInput = this.querySelector('[name="homework_percentage"]');
        const classworkInput = this.querySelector('[name="classwork_percentage"]');
        const testInput = this.querySelector('[name="test_percentage"]');
        const examInput = this.querySelector('[name="exam_percentage"]');
        
        const homework = parseFloat(homeworkInput.value) || 0;
        const classwork = parseFloat(classworkInput.value) || 0;
        const test = parseFloat(testInput.value) || 0;
        const exam = parseFloat(examInput.value) || 0;
        
        // Validate percentages are within 0-100 range
        if (homework < 0 || homework > 100 || 
            classwork < 0 || classwork > 100 || 
            test < 0 || test > 100 || 
            exam < 0 || exam > 100) {
            showToast('error', 'Validation Error', 'Percentages must be between 0 and 100.');
            return;
        }
        
        showLoading('Adding new grade...');
        submitBtn.disabled = true;
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
        
        // Collect form data
        const formData = new FormData(this);
        
        // Add action parameter for the backend to identify this request
        formData.append('action', 'add_grade');
        
        // Send AJAX request
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(parseResponse)
        .then(data => {
            hideLoading();
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
            
            if (data.success) {
                showToast('success', 'Success', 'Grade added successfully!');
                
                // Reset form
                this.reset();
                homeworkInput.value = '0';
                classworkInput.value = '0';
                testInput.value = '0';
                examInput.value = '0';
                
                // Reload the page after 1.5 seconds to show the new grade
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } else {
                showToast('error', 'Error', data.error || 'Failed to add grade');
            }
        })
        .catch(error => {
            hideLoading();
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
            console.error('Add grade error:', error);
            
            if (error.message.includes('HTML instead of JSON')) {
                showToast('error', 'Session Expired', 'Please refresh the page and log in again.');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showToast('error', 'Error', 'Failed to add grade: ' + error.message);
            }
        });
    });

    // Delete grade
    document.querySelectorAll('.delete-grade-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const gradeId = this.getAttribute('data-grade-id');
            
            if (confirm(' Are you sure you want to delete this grade? This action cannot be undone.')) {
                showLoading('Deleting grade...');
                
                const csrfToken = getCSRFToken();
                if (!csrfToken) {
                    showToast('error', 'Security Error', 'Please refresh the page.');
                    hideLoading();
                    return;
                }
                
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', csrfToken);
                formData.append('confirm', 'true');
                
                fetch(`/grades/delete/${gradeId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                })
                .then(parseResponse)
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showToast('success', 'Success', 'Grade deleted successfully!');
                        
                        // Remove the row
                        const row = document.getElementById(`grade-row-${gradeId}`);
                        if (row) {
                            row.remove();
                        }
                        
                        // Show empty message if no grades left
                        const tableBody = document.getElementById('grades-table-body');
                        if (tableBody && tableBody.children.length === 0) {
                            const emptyRow = document.createElement('tr');
                            emptyRow.id = 'no-grades-row';
                            emptyRow.innerHTML = `
                                <td colspan="9" class="text-center py-4" style="font-size: 0.8rem;">
                                    <i class="fas fa-inbox fa-2x mb-2 d-block text-muted"></i>
                                    No grades available for this academic period
                                </td>`;
                            tableBody.appendChild(emptyRow);
                        }
                    } else {
                        showToast('error', 'Error', data.error || 'Failed to delete grade');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Delete error:', error);
                    
                    if (error.message.includes('HTML instead of JSON')) {
                        showToast('error', 'Session Expired', 'Please refresh the page.');
                    } else {
                        showToast('error', 'Error', 'Failed to delete grade: ' + error.message);
                    }
                });
            }
        });
    });

    {% endif %}

    // =============================================
    // PERFORMANCE CHART
    // =============================================
    {% if grades %}
    try {
        const ctx = document.getElementById('performanceChart');
        if (ctx) {
            const subjects = [{% for grade in grades %}'{{ grade.subject.name|escapejs }}',{% endfor %}];
            const scores = [{% for grade in grades %}{{ grade.total_score|default:0 }},{% endfor %}];
            
            const performanceChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: subjects,
                    datasets: [{
                        label: 'Performance Score (%)',
                        data: scores,
                        backgroundColor: scores.map(score => {
                            if (score >= 90) return '#27ae60';
                            if (score >= 70) return '#3498db';
                            if (score >= 50) return '#f1c40f';
                            if (score >= 30) return '#e67e22';
                            return '#e74c3c';
                        }),
                        borderColor: '#2c3e50',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Score: ${context.raw}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                stepSize: 20
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 9 }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Chart error:', error);
    }
    {% endif %}

    // =============================================
    // PRINT FUNCTIONALITY
    // =============================================
    document.querySelector('[onclick="window.print()"]')?.addEventListener('click', function(e) {
        e.preventDefault();
        showLoading('Preparing for print...');
        setTimeout(() => {
            hideLoading();
            window.print();
        }, 1000);
    });

    // =============================================
    // FORM VALIDATION
    // =============================================
    const percentageInputs = document.querySelectorAll('.percentage-input');
    percentageInputs.forEach(input => {
        input.addEventListener('blur', function() {
            const value = parseFloat(this.value);
            if (isNaN(value)) {
                this.value = 0;
                return;
            }
            if (value > 100) {
                this.value = 100;
                showToast('warning', 'Warning', 'Percentage cannot exceed 100%');
            }
            if (value < 0) {
                this.value = 0;
                showToast('warning', 'Warning', 'Percentage cannot be negative');
            }
        });
    });

    // =============================================
    // AUTO-SAVE WARNING
    // =============================================
    {% if editable_mode %}
    let hasUnsavedChanges = false;
    
    document.querySelectorAll('.editable-field').forEach(field => {
        field.addEventListener('input', () => hasUnsavedChanges = true);
    });
    
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        }
    });
    {% endif %}

    // =============================================
    // KEYBOARD SHORTCUTS
    // =============================================
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + S to save
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            {% if editable_mode %}
            const saveBtn = document.getElementById('saveAllChangesBtn');
            if (saveBtn) saveBtn.click();
            {% endif %}
        }
    });

    // =============================================
    // INITIAL CALCULATION FOR EXISTING GRADES
    // =============================================
    {% if editable_mode %}
    // Calculate totals for all grades on page load
    setTimeout(() => {
        const updateButtons = document.querySelectorAll('.update-grade-btn');
        updateButtons.forEach(btn => {
            const gradeId = btn.getAttribute('data-grade-id');
            if (gradeId) {
                calculateTotal(gradeId);
            }
        });
    }, 500);
    {% endif %}

    console.log(' Report Card (Percentage System) functionality loaded');
});
</script>

<style>
/* Grade badge colors */
.grade-badge {
    font-weight: bold;
    font-size: 0.85rem;
    min-width: 30px;
    padding: 4px 8px;
}

.grade-1-2 {
    background-color: #28a745 !important;
    color: white;
}

.grade-3-4 {
    background-color: #17a2b8 !important;
    color: white;
}

.grade-5-6 {
    background-color: #ffc107 !important;
    color: #212529;
}

.grade-7-8 {
    background-color: #fd7e14 !important;
    color: white;
}

.grade-9 {
    background-color: #dc3545 !important;
    color: white;
}

/* Toast notifications */
.custom-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    align-items: center;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 15px;
    max-width: 350px;
    animation: slideInRight 0.3s ease-out;
    border-left: 4px solid;
}

.custom-toast.success {
    border-left-color: #28a745;
}

.custom-toast.error {
    border-left-color: #dc3545;
}

.custom-toast.warning {
    border-left-color: #ffc107;
}

.custom-toast.info {
    border-left-color: #17a2b8;
}

.toast-icon {
    margin-right: 12px;
    font-size: 1.2rem;
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    margin-bottom: 2px;
}

.toast-message {
    font-size: 0.9rem;
    color: #666;
}

.toast-close {
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    font-size: 0.9rem;
    margin-left: 10px;
}

.toast-close:hover {
    color: #666;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Loading overlay */
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 99999;
}

.loading-content {
    background: white;
    padding: 30px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.loading-content h5 {
    margin-top: 15px;
    color: #333;
}
</style>
{% endblock %}