{% extends 'base.html' %}
{% load static grade_tags %}

{% block title %}Best Students - {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header d-flex justify-content-between align-items-center">
                <h1 class="h2 mb-0">
                    <i class="fas fa-trophy me-2"></i>Top Performing Students
                </h1>
                <div class="btn-group">
                    <a href="{% url 'grade_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-list me-1"></i>All Grades
                    </a>
                    <a href="{% url 'grade_report' %}" class="btn btn-outline-primary">
                        <i class="fas fa-chart-bar me-1"></i>Grade Reports
                    </a>
                </div>
            </div>
            <p class="text-muted">
                Top performing students 
                {% if selected_year %}
                for {{ selected_year }}
                {% endif %}
                {% if selected_term %}
                Term {{ selected_term }}
                {% endif %}
                {% if selected_class %}
                in {{ selected_class }}
                {% endif %}
                based on average grades.
            </p>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3" id="filterForm">
                        <div class="col-md-3">
                            <label class="form-label">Academic Year</label>
                            <select name="academic_year" class="form-select">
                                <option value="">All Years</option>
                                {% for year in academic_years %}
                                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>
                                    {{ year }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Term</label>
                            <select name="term" class="form-select">
                                <option value="">All Terms</option>
                                <option value="1" {% if selected_term == "1" %}selected{% endif %}>Term 1</option>
                                <option value="2" {% if selected_term == "2" %}selected{% endif %}>Term 2</option>
                                <option value="3" {% if selected_term == "3" %}selected{% endif %}>Term 3</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Class Level</label>
                            <select name="class_level" class="form-select">
                                <option value="">All Classes</option>
                                {% for code, name in class_levels %}
                                <option value="{{ code }}" {% if code == selected_class %}selected{% endif %}>
                                    {{ name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-grow-1">
                                    <i class="fas fa-filter me-1"></i>Apply Filters
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                                    <i class="fas fa-redo me-1"></i>Reset
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Top Student</h6>
                            <h4 class="mb-0">
                                {% if top_students %}
                                    {{ top_students.0.get_full_name|truncatechars:15 }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </h4>
                        </div>
                        <div class="avatar avatar-lg bg-white text-primary rounded-circle">
                            <i class="fas fa-crown fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Highest Average</h6>
                            <h4 class="mb-0">
                                {% if top_students %}
                                    {{ top_students.0.avg_grade|floatformat:2 }}%
                                {% else %}
                                    0.00%
                                {% endif %}
                            </h4>
                        </div>
                        <div class="avatar avatar-lg bg-white text-info rounded-circle">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Students Ranked</h6>
                            <h4 class="mb-0">{{ total_students }}</h4>
                        </div>
                        <div class="avatar avatar-lg bg-white text-success rounded-circle">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Overall Average</h6>
                            <h4 class="mb-0">{{ overall_average|floatformat:2 }}%</h4>
                        </div>
                        <div class="avatar avatar-lg bg-white text-warning rounded-circle">
                            <i class="fas fa-percentage fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Students Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list-ol me-2"></i>Top {{ top_students|length }} Students
                    </h5>
                </div>
                <div class="card-body">
                    {% if top_students %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">Rank</th>
                                    <th>Student</th>
                                    <th>Class</th>
                                    <th>Average Grade</th>
                                    <th>GES Grade</th>
                                    <th>Letter Grade</th>
                                    <th>Performance</th>
                                    <th>Subjects Taken</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in top_students %}
                                <tr>
                                    <td>
                                        {% if forloop.counter == 1 %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-crown me-1"></i>{{ forloop.counter }}
                                        </span>
                                        {% elif forloop.counter == 2 %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-medal me-1"></i>{{ forloop.counter }}
                                        </span>
                                        {% elif forloop.counter == 3 %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-medal me-1"></i>{{ forloop.counter }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-primary">{{ forloop.counter }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm bg-primary rounded-circle me-2">
                                                <span class="text-white">{{ student.get_initials }}</span>
                                            </div>
                                            <div>
                                                <strong>{{ student.get_full_name }}</strong>
                                                <br>
                                                <small class="text-muted">{{ student.student_id }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">
                                            {{ student.get_class_level_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <h5 class="mb-0">
                                            <span class="badge 
                                                {% if student.avg_grade >= 80 %}bg-success
                                                {% elif student.avg_grade >= 60 %}bg-info
                                                {% elif student.avg_grade >= 40 %}bg-warning
                                                {% else %}bg-danger{% endif %}">
                                                {{ student.avg_grade|floatformat:2 }}%
                                            </span>
                                        </h5>
                                    </td>
                                    <td>
                                        {% with ges_grade=student.get_avg_ges_grade %}
                                        <span class="badge 
                                            {% if student.avg_grade >= 80 %}bg-success
                                            {% elif student.avg_grade >= 60 %}bg-info
                                            {% elif student.avg_grade >= 40 %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ ges_grade }}
                                        </span>
                                        {% endwith %}
                                    </td>
                                    <td>
                                        {% with letter_grade=student.get_avg_letter_grade %}
                                        <span class="badge 
                                            {% if student.avg_grade >= 80 %}bg-success
                                            {% elif student.avg_grade >= 60 %}bg-info
                                            {% elif student.avg_grade >= 40 %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ letter_grade }}
                                        </span>
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                                <div class="progress-bar 
                                                    {% if student.avg_grade >= 80 %}bg-success
                                                    {% elif student.avg_grade >= 60 %}bg-info
                                                    {% elif student.avg_grade >= 40 %}bg-warning
                                                    {% else %}bg-danger{% endif %}" 
                                                    role="progressbar" 
                                                    style="width: {{ student.avg_grade }}%; max-width: 100%">
                                                </div>
                                            </div>
                                            <small>{{ student.performance_level }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            {{ student.subject_count }} subjects
                                        </span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                onclick="showStudentDetails('{{ student.id }}')">
                                            <i class="fas fa-eye me-1"></i>View Details
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No student data available</h5>
                        <p class="text-muted">No grades have been recorded for the selected filters.</p>
                        <div class="mt-3">
                            <a href="{% url 'grade_list' %}" class="btn btn-primary me-2">
                                <i class="fas fa-list me-1"></i>View All Grades
                            </a>
                            <a href="{% url 'grade_add' %}" class="btn btn-success">
                                <i class="fas fa-plus me-1"></i>Add Grades
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">
                                Data as of {% now "F j, Y" %} | 
                                Showing top {{ top_students|length }} students
                            </small>
                        </div>
                        {% if top_students %}
                        <div>
                            <button class="btn btn-outline-secondary" onclick="exportBestStudents()">
                                <i class="fas fa-download me-1"></i>Export List
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if top_students %}
    <!-- Performance Distribution -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Performance Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="performanceChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Class Level Performance
                    </h5>
                </div>
                <div class="card-body">
                    {% if class_performance %}
                    <canvas id="classChart" height="250"></canvas>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No class performance data</h5>
                        <p class="text-muted">Multiple class levels are required to show this chart.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Student Details Modal -->
<div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-labelledby="studentDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentDetailsModalLabel">Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="studentDetailsContent">
                <!-- Content loaded via AJAX -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading student details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="retryLoading()" id="retryButton" style="display: none;">
                    <i class="fas fa-redo me-1"></i>Retry
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global variables
    let performanceChart = null;
    let classChart = null;
    let currentStudentId = null;
    
    // Reset filters function
    function resetFilters() {
        // Reset all select elements to their default values
        const form = document.getElementById('filterForm');
        const selects = form.querySelectorAll('select');
        
        selects.forEach(select => {
            select.selectedIndex = 0; // Select the first option (empty value)
        });
        
        // Submit the form to reload the page with default values
        form.submit();
    }
    
    // Function to show student details - FIXED VERSION
    function showStudentDetails(studentId) {
        console.log(`Loading details for student ID: ${studentId}`);
        
        // Store current student ID
        currentStudentId = studentId;
        
        // Show loading content
        $('#studentDetailsContent').html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading student details...</p>
                <p class="text-muted small mb-2">Student ID: ${studentId}</p>
            </div>
        `);
        
        // Hide retry button initially
        $('#retryButton').hide();
        
        // Show modal
        const modalElement = document.getElementById('studentDetailsModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        // Build URL - Use the correct API endpoint
        const url = `/grades/api/student-grade-summary/${studentId}/`;
        console.log("Fetching from URL:", url);
        
        // Set timeout for the request (8 seconds)
        const requestTimeout = setTimeout(() => {
            console.log("Request timeout after 8 seconds");
            showErrorMessage(
                'Request Timeout', 
                'The request took too long to complete. The server might be busy.',
                studentId
            );
        }, 8000);
        
        // Make the AJAX request
        $.ajax({
            url: url,
            method: 'GET',
            timeout: 10000, // 10 second timeout
            dataType: 'json',
            beforeSend: function(xhr) {
                console.log("AJAX request starting...");
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            },
            success: function(data, status, xhr) {
                clearTimeout(requestTimeout);
                console.log("AJAX Success! Status:", status);
                
                if (data.error) {
                    showErrorMessage(
                        'API Error', 
                        data.message || data.error,
                        studentId
                    );
                    return;
                }
                
                // Display the data
                displayStudentData(data, studentId);
            },
            error: function(xhr, status, error) {
                clearTimeout(requestTimeout);
                console.error("AJAX Error Details:");
                console.error("Status:", status);
                console.error("Error:", error);
                console.error("XHR Status:", xhr.status);
                console.error("XHR Status Text:", xhr.statusText);
                
                let errorMessage = 'An error occurred while loading student details.';
                let errorDetails = '';
                
                switch(status) {
                    case 'timeout':
                        errorMessage = 'The request timed out.';
                        errorDetails = 'Server took too long to respond.';
                        break;
                    case 'error':
                        if (xhr.status === 0) {
                            errorMessage = 'Network error.';
                            errorDetails = 'Check your internet connection or server availability.';
                        } else if (xhr.status === 404) {
                            errorMessage = 'Student not found.';
                            errorDetails = 'The requested student does not exist (404).';
                        } else if (xhr.status === 403) {
                            errorMessage = 'Permission denied.';
                            errorDetails = 'You do not have permission to view this student\'s details.';
                        } else if (xhr.status === 500) {
                            errorMessage = 'Server error.';
                            errorDetails = 'Internal server error (500). Please try again later.';
                        } else {
                            errorMessage = `HTTP Error ${xhr.status}`;
                            errorDetails = xhr.statusText;
                        }
                        break;
                    case 'parsererror':
                        errorMessage = 'Data format error';
                        errorDetails = 'The server returned invalid JSON data.';
                        break;
                    case 'abort':
                        errorMessage = 'Request Aborted';
                        errorDetails = 'The request was cancelled.';
                        break;
                }
                
                showErrorMessage(errorMessage, errorDetails, studentId);
            },
            complete: function(xhr, status) {
                console.log("AJAX request completed with status:", status);
            }
        });
    }
    
    // Function to display error messages
    function showErrorMessage(title, message, studentId) {
        $('#studentDetailsContent').html(`
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>${title}</h5>
                <p>${message}</p>
                <div class="mt-3">
                    <p class="small text-muted mb-1"><strong>Details:</strong></p>
                    <p class="small text-muted">Student ID: ${studentId}</p>
                </div>
            </div>
        `);
        $('#retryButton').show();
    }
    
    // Function to retry loading
    function retryLoading() {
        if (currentStudentId) {
            showStudentDetails(currentStudentId);
        }
    }
    
    // Function to display student data
    function displayStudentData(data, studentId) {
        console.log("Displaying student data:", data);
        
        const student = data.student;
        const summary = data.grades_summary;
        
        let html = `
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="avatar avatar-lg bg-primary rounded-circle mb-3 mx-auto">
                                <span class="text-white">${student.name ? student.name.charAt(0) : '?'}</span>
                            </div>
                            <h5>${student.name || 'Unknown Student'}</h5>
                            <p class="text-muted">${student.student_id || 'N/A'}</p>
                            <p><span class="badge bg-info">${student.class_level_display || student.class_level || 'N/A'}</span></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <h6>Performance Summary</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Average Score:</strong></td>
                                    <td><span class="badge bg-primary">${(summary.average_score || 0).toFixed(2)}%</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Total Subjects:</strong></td>
                                    <td>${summary.total_subjects || 0}</td>
                                </tr>
                                <tr>
                                    <td><strong>Passing Subjects:</strong></td>
                                    <td><span class="badge bg-success">${summary.passing_subjects || 0}</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Passing Rate:</strong></td>
                                    <td><span class="badge ${(summary.passing_rate || 0) >= 50 ? 'bg-success' : 'bg-warning'}">${(summary.passing_rate || 0).toFixed(1)}%</span></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add recent grades table if available
        if (data.recent_grades && data.recent_grades.length > 0) {
            html += `
                <div class="mt-3">
                    <h6>Recent Grades (${data.recent_grades.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Score</th>
                                    <th>GES Grade</th>
                                    <th>Letter Grade</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            data.recent_grades.forEach(grade => {
                const isPassing = grade.is_passing || (grade.score >= 40);
                const score = grade.score || 0;
                const gesGrade = grade.ges_grade || 'N/A';
                const letterGrade = grade.letter_grade || 'N/A';
                const subjectName = grade.subject || 'Unknown';
                
                html += `
                    <tr>
                        <td>${subjectName}</td>
                        <td>${score.toFixed(2)}%</td>
                        <td><span class="badge bg-secondary">${gesGrade}</span></td>
                        <td><span class="badge bg-secondary">${letterGrade}</span></td>
                        <td><span class="badge ${isPassing ? 'bg-success' : 'bg-danger'}">${isPassing ? 'PASS' : 'FAIL'}</span></td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="mt-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        No recent grade data available for this student.
                    </div>
                </div>
            `;
        }
        
        // Add term-wise breakdown if available
        if (data.grades_by_term && Object.keys(data.grades_by_term).length > 0) {
            html += `
                <div class="mt-3">
                    <h6>Grade Breakdown by Term</h6>
                    <div class="accordion" id="gradesAccordion">
            `;
            
            let accordionIndex = 0;
            for (const [termKey, termData] of Object.entries(data.grades_by_term)) {
                const termGrades = termData.grades || [];
                const uniqueId = `term-${accordionIndex}`;
                
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading${uniqueId}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${uniqueId}" aria-expanded="false" aria-controls="collapse${uniqueId}">
                                ${termKey}
                            </button>
                        </h2>
                        <div id="collapse${uniqueId}" class="accordion-collapse collapse" aria-labelledby="heading${uniqueId}" data-bs-parent="#gradesAccordion">
                            <div class="accordion-body">
                                ${termGrades.length > 0 ? `
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Subject</th>
                                                <th>Score</th>
                                                <th>Grade</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${termGrades.map(grade => `
                                                <tr>
                                                    <td>${grade.subject || 'Unknown'}</td>
                                                    <td>${(grade.score || 0).toFixed(2)}%</td>
                                                    <td><span class="badge bg-secondary">${grade.grade_display || grade.ges_grade || 'N/A'}</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<p class="text-muted">No grades for this term.</p>'}
                            </div>
                        </div>
                    </div>
                `;
                
                accordionIndex++;
            }
            
            html += `
                    </div>
                </div>
            `;
        }
        
        // Add success message
        html += `
            <div class="mt-3 text-end small text-muted">
                <i class="fas fa-check-circle me-1 text-success"></i>
                Data loaded successfully
            </div>
        `;
        
        $('#studentDetailsContent').html(html);
        $('#retryButton').hide();
    }
    
    // Test function for debugging
    function testStudentDetails(studentId = 1) {
        console.log("=== Testing student details function ===");
        showStudentDetails(studentId);
    }
    
    // Export function
    function exportBestStudents() {
        const params = new URLSearchParams({
            academic_year: '{{ selected_year|default:"" }}',
            term: '{{ selected_term|default:"" }}',
            class_level: '{{ selected_class|default:"" }}',
            format: 'csv'
        });
        
        window.location.href = `{% url 'export_grades' %}?${params.toString()}`;
    }
    
    // Initialize charts
    function initializeCharts() {
        // Destroy existing charts
        if (performanceChart) performanceChart.destroy();
        if (classChart) classChart.destroy();
        
        // Performance Distribution Chart
        const ctx1 = document.getElementById('performanceChart');
        if (ctx1) {
            performanceChart = new Chart(ctx1.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Excellent (â‰¥80%)', 'Good (60-79%)', 'Fair (40-59%)', 'Poor (<40%)'],
                    datasets: [{
                        data: [
                            {{ excellent_count|default:0 }},
                            {{ good_count|default:0 }},
                            {{ fair_count|default:0 }},
                            {{ poor_count|default:0 }}
                        ],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(23, 162, 184, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        // Class Level Chart
        const ctx2 = document.getElementById('classChart');
        if (ctx2 && {{ class_performance|length }} > 0) {
            classChart = new Chart(ctx2.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [{% for class_data in class_performance %}'{{ class_data.class_level }}',{% endfor %}],
                    datasets: [{
                        label: 'Average Score',
                        data: [{% for class_data in class_performance %}{{ class_data.average_score|floatformat:2 }},{% endfor %}],
                        backgroundColor: 'rgba(54, 162, 235, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Average Score (%)' }
                        }
                    }
                }
            });
        }
    }
    
    // Document ready
    $(document).ready(function() {
        console.log("Best Students page loaded");
        console.log("Available functions:");
        console.log("- showStudentDetails(studentId)");
        console.log("- testStudentDetails(studentId) - for testing");
        console.log("- resetFilters() - to clear all filters");
        
        // Initialize charts
        {% if top_students %}
        initializeCharts();
        {% endif %}
        
        // Make test function available globally
        window.testStudentDetails = testStudentDetails;
        window.resetFilters = resetFilters;
    });
    
    // Resize charts
    $(window).on('resize', function() {
        if (performanceChart || classChart) {
            initializeCharts();
        }
    });
</script>
{% endblock %}