{% extends 'base.html' %}
{% load static crispy_forms_tags %}

{% block title %}Grade Configuration - {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header d-flex justify-content-between align-items-center">
                <h1 class="h2 mb-0">
                    <i class="fas fa-cog me-2"></i>Grade Configuration
                </h1>
                <div class="btn-group">
                    <a href="{% url 'grade_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Grades
                    </a>
                    <a href="{% url 'grade_calculator' %}" class="btn btn-outline-primary">
                        <i class="fas fa-calculator me-1"></i>Grade Calculator
                    </a>
                </div>
            </div>
            <p class="text-muted">
                Configure grading systems, grade boundaries, and assessment weights.
            </p>
        </div>
    </div>

    <!-- System Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-info-circle me-2"></i>Current System Status
                    </h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="alert alert-info">
                                <strong>Active System:</strong>
                                <span class="badge bg-primary ms-2">{{ form.instance.get_grading_system_display }}</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-{% if form.instance.is_locked %}danger{% else %}success{% endif %}">
                                <strong>Configuration:</strong>
                                <span class="badge {% if form.instance.is_locked %}bg-danger{% else %}bg-success{% endif %} ms-2">
                                    {% if form.instance.is_locked %}Locked{% else %}Editable{% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-secondary">
                                <strong>School Level:</strong>
                                <span class="badge bg-secondary ms-2">{{ form.instance.get_school_level_display }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Presets -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Presets
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Apply standard configurations for different school levels:
                    </p>
                    <div class="row g-2">
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary w-100 preset-btn" data-level="primary">
                                <i class="fas fa-school me-1"></i>Primary School
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary w-100 preset-btn" data-level="jhs">
                                <i class="fas fa-graduation-cap me-1"></i>Junior High School
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary w-100 preset-btn" data-level="shs">
                                <i class="fas fa-university me-1"></i>Senior High School
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="resetToDefaults()">
                                <i class="fas fa-undo me-1"></i>Reset to Defaults
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Configuration Form -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-edit me-2"></i>Configuration Settings
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="gradeConfigForm">
                        {% csrf_token %}
                        
                        <!-- Grading System Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-chart-bar me-2"></i>Grading System
                                </h6>
                                {{ form.grading_system|as_crispy_field }}
                                {{ form.school_level|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-sliders-h me-2"></i>Assessment Weights
                                </h6>
                                <div class="row">
                                    <div class="col-6">
                                        {{ form.classwork_weight|as_crispy_field }}
                                    </div>
                                    <div class="col-6">
                                        {{ form.homework_weight|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        {{ form.test_weight|as_crispy_field }}
                                    </div>
                                    <div class="col-6">
                                        {{ form.exam_weight|as_crispy_field }}
                                    </div>
                                </div>
                                <div class="alert alert-info mt-2" id="weightTotal">
                                    <strong>Total:</strong> <span id="totalWeight">0.00</span>%
                                </div>
                            </div>
                        </div>

                        <!-- Grade Boundaries -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-sort-amount-down me-2"></i>Grade Boundaries
                                </h6>
                                <p class="text-muted">
                                    Set minimum percentages for each grade. Values must be in descending order.
                                </p>
                            </div>
                        </div>

                        <!-- GES Grade Boundaries -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">GES Number System (1-9)</h6>
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Grade</th>
                                                <th>Description</th>
                                                <th>Minimum Score (%)</th>
                                                <th>Maximum Score (%)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Grade 1 -->
                                            <tr>
                                                <td><strong>1</strong></td>
                                                <td>Excellent</td>
                                                <td>{{ form.grade_1_min }}</td>
                                                <td>100.00</td>
                                            </tr>
                                            <!-- Grade 2 -->
                                            <tr>
                                                <td><strong>2</strong></td>
                                                <td>Very Good</td>
                                                <td>{{ form.grade_2_min }}</td>
                                                <td>
                                                    {% with grade_1_min=form.grade_1_min.value|default:"90.00" %}
                                                    {{ grade_1_min|floatformat:2 }} (Grade 1 min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- Grade 3 -->
                                            <tr>
                                                <td><strong>3</strong></td>
                                                <td>Good</td>
                                                <td>{{ form.grade_3_min }}</td>
                                                <td>
                                                    {% with grade_2_min=form.grade_2_min.value|default:"80.00" %}
                                                    {{ grade_2_min|floatformat:2 }} (Grade 2 min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- Grade 4 -->
                                            <tr>
                                                <td><strong>4</strong></td>
                                                <td>Satisfactory</td>
                                                <td>{{ form.grade_4_min }}</td>
                                                <td>
                                                    {% with grade_3_min=form.grade_3_min.value|default:"70.00" %}
                                                    {{ grade_3_min|floatformat:2 }} (Grade 3 min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- Grade 5 -->
                                            <tr>
                                                <td><strong>5</strong></td>
                                                <td>Fair</td>
                                                <td>{{ form.grade_5_min }}</td>
                                                <td>
                                                    {% with grade_4_min=form.grade_4_min.value|default:"60.00" %}
                                                    {{ grade_4_min|floatformat:2 }} (Grade 4 min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- Grade 6 -->
                                            <tr>
                                                <td><strong>6</strong></td>
                                                <td>Marginal (Pass)</td>
                                                <td>{{ form.grade_6_min }}</td>
                                                <td>
                                                    {% with grade_5_min=form.grade_5_min.value|default:"50.00" %}
                                                    {{ grade_5_min|floatformat:2 }} (Grade 5 min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- Grade 7 -->
                                            <tr>
                                                <td><strong>7</strong></td>
                                                <td>Poor</td>
                                                <td>{{ form.grade_7_min }}</td>
                                                <td>
                                                    {% with grade_6_min=form.grade_6_min.value|default:"40.00" %}
                                                    {{ grade_6_min|floatformat:2 }} (Grade 6 min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- Grade 8 -->
                                            <tr>
                                                <td><strong>8</strong></td>
                                                <td>Very Poor</td>
                                                <td>{{ form.grade_8_min }}</td>
                                                <td>
                                                    {% with grade_7_min=form.grade_7_min.value|default:"30.00" %}
                                                    {{ grade_7_min|floatformat:2 }} (Grade 7 min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- Grade 9 (Fail) -->
                                            <tr class="table-danger">
                                                <td><strong>9</strong></td>
                                                <td>Fail</td>
                                                <td>0.00</td>
                                                <td>
                                                    {% with grade_8_min=form.grade_8_min.value|default:"20.00" %}
                                                    {{ grade_8_min|floatformat:2 }} (Grade 8 min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Letter Grade Boundaries -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3">Letter Grading System (A-F)</h6>
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Grade</th>
                                                <th>Description</th>
                                                <th>Minimum Score (%)</th>
                                                <th>Maximum Score (%)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- A+ -->
                                            <tr>
                                                <td><strong>A+</strong></td>
                                                <td>Outstanding</td>
                                                <td>{{ form.letter_a_plus_min }}</td>
                                                <td>100.00</td>
                                            </tr>
                                            <!-- A -->
                                            <tr>
                                                <td><strong>A</strong></td>
                                                <td>Excellent</td>
                                                <td>{{ form.letter_a_min }}</td>
                                                <td>
                                                    {% with a_plus_min=form.letter_a_plus_min.value|default:"95.00" %}
                                                    {{ a_plus_min|floatformat:2 }} (A+ min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- B+ -->
                                            <tr>
                                                <td><strong>B+</strong></td>
                                                <td>Very Good</td>
                                                <td>{{ form.letter_b_plus_min }}</td>
                                                <td>
                                                    {% with a_min=form.letter_a_min.value|default:"90.00" %}
                                                    {{ a_min|floatformat:2 }} (A min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- B -->
                                            <tr>
                                                <td><strong>B</strong></td>
                                                <td>Good</td>
                                                <td>{{ form.letter_b_min }}</td>
                                                <td>
                                                    {% with b_plus_min=form.letter_b_plus_min.value|default:"85.00" %}
                                                    {{ b_plus_min|floatformat:2 }} (B+ min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- C+ -->
                                            <tr>
                                                <td><strong>C+</strong></td>
                                                <td>Satisfactory</td>
                                                <td>{{ form.letter_c_plus_min }}</td>
                                                <td>
                                                    {% with b_min=form.letter_b_min.value|default:"80.00" %}
                                                    {{ b_min|floatformat:2 }} (B min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- C -->
                                            <tr>
                                                <td><strong>C</strong></td>
                                                <td>Fair</td>
                                                <td>{{ form.letter_c_min }}</td>
                                                <td>
                                                    {% with c_plus_min=form.letter_c_plus_min.value|default:"75.00" %}
                                                    {{ c_plus_min|floatformat:2 }} (C+ min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- D+ -->
                                            <tr>
                                                <td><strong>D+</strong></td>
                                                <td>Marginal</td>
                                                <td>{{ form.letter_d_plus_min }}</td>
                                                <td>
                                                    {% with c_min=form.letter_c_min.value|default:"70.00" %}
                                                    {{ c_min|floatformat:2 }} (C min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- D -->
                                            <tr>
                                                <td><strong>D</strong></td>
                                                <td>Poor</td>
                                                <td>{{ form.letter_d_min }}</td>
                                                <td>
                                                    {% with d_plus_min=form.letter_d_plus_min.value|default:"65.00" %}
                                                    {{ d_plus_min|floatformat:2 }} (D+ min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            <!-- F -->
                                            <tr class="table-danger">
                                                <td><strong>F</strong></td>
                                                <td>Fail</td>
                                                <td>0.00</td>
                                                <td>
                                                    {% with d_min=form.letter_d_min.value|default:"60.00" %}
                                                    {{ d_min|floatformat:2 }} (D min - 0.01)
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Passing Mark and Lock -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-check-circle me-2"></i>Passing Criteria
                                </h6>
                                {{ form.passing_mark|as_crispy_field }}
                                <div class="alert alert-warning">
                                    <small>
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Note: Passing mark cannot be higher than Grade 6 minimum.
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-lock me-2"></i>Security Settings
                                </h6>
                                {{ form.is_locked|as_crispy_field }}
                                <div class="alert alert-info">
                                    <small>
                                        <i class="fas fa-info-circle me-1"></i>
                                        When locked, only administrators can modify these settings.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'grade_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </a>
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i>Save Configuration
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" onclick="testConfiguration()">
                                            <i class="fas fa-play me-1"></i>Test Configuration
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .preset-btn:hover {
        transform: translateY(-2px);
        transition: transform 0.2s;
    }
    .grade-boundary-input {
        width: 120px;
    }
    table td {
        vertical-align: middle;
    }
    .form-control.grade-boundary-input {
        text-align: center;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        console.log("Grade configuration page loaded");
        
        // Calculate total weight
        function calculateTotalWeight() {
            let total = 0;
            let weightInputs = [];
            
            $('input[id$="_weight"]').each(function() {
                const value = parseFloat($(this).val()) || 0;
                total += value;
                weightInputs.push({
                    id: $(this).attr('id'),
                    value: value
                });
            });
            
            const formattedTotal = total.toFixed(2);
            $('#totalWeight').text(formattedTotal);
            
            // Debug logging
            console.log("Weight calculation:", {
                inputs: weightInputs,
                total: total,
                formattedTotal: formattedTotal
            });
            
            if (Math.abs(total - 100) < 0.01) {
                $('#weightTotal').removeClass('alert-danger').addClass('alert-success');
                console.log("✅ Weights total 100% - OK");
            } else {
                $('#weightTotal').removeClass('alert-success').addClass('alert-danger');
                console.warn(`⚠️ Weights total ${formattedTotal}% - should be 100%`);
            }
        }
        
        // Initial calculation
        calculateTotalWeight();
        
        // Update on input change
        $('input[id$="_weight"]').on('input', calculateTotalWeight);
        
        // Preset buttons
        $('.preset-btn').click(function() {
            const level = $(this).data('level');
            const presets = {
                'primary': {
                    school_level: 'PRIMARY',
                    grade_6_min: 40.00,
                    grade_7_min: 30.00,
                    passing_mark: 40.00,
                    classwork_weight: 40.00,
                    homework_weight: 0.00,
                    test_weight: 0.00,
                    exam_weight: 60.00,
                    grading_system: 'GES'
                },
                'jhs': {
                    school_level: 'JHS',
                    grade_6_min: 45.00,
                    grade_7_min: 35.00,
                    passing_mark: 45.00,
                    classwork_weight: 30.00,
                    homework_weight: 10.00,
                    test_weight: 10.00,
                    exam_weight: 50.00,
                    grading_system: 'GES'
                },
                'shs': {
                    school_level: 'SHS',
                    grade_6_min: 45.00,
                    grade_7_min: 35.00,
                    passing_mark: 45.00,
                    classwork_weight: 40.00,
                    homework_weight: 10.00,
                    test_weight: 10.00,
                    exam_weight: 40.00,
                    grading_system: 'BOTH'
                }
            };
            
            if (confirm(`Apply ${level.toUpperCase()} preset configuration? This will override current values.`)) {
                const preset = presets[level];
                console.log(`Applying ${level} preset:`, preset);
                
                for (const [key, value] of Object.entries(preset)) {
                    const field = $(`#id_${key}`);
                    if (field.length) {
                        field.val(value);
                        console.log(`Set ${key} = ${value}`);
                    } else {
                        console.warn(`Field ${key} not found`);
                    }
                }
                
                calculateTotalWeight();
                alert('Preset applied! Please review and save.');
            }
        });
    });
    
    function testConfiguration() {
        // Get current values
        const scoreInput = prompt('Enter a test score to see how it would be graded (0-100):');
        
        if (scoreInput === null) return; // User cancelled
        
        const score = parseFloat(scoreInput);
        
        if (isNaN(score) || score < 0 || score > 100) {
            alert('Please enter a valid score between 0 and 100.');
            return;
        }
        
        // Get GES boundaries
        const gesMins = {};
        const gesFieldNames = [
            'grade_1_min', 'grade_2_min', 'grade_3_min', 'grade_4_min',
            'grade_5_min', 'grade_6_min', 'grade_7_min', 'grade_8_min'
        ];
        
        gesFieldNames.forEach(field => {
            const value = parseFloat($(`#id_${field}`).val()) || 0;
            gesMins[field] = value;
        });
        
        // Get letter boundaries
        const letterMins = {};
        const letterFieldNames = [
            'letter_a_plus_min', 'letter_a_min', 'letter_b_plus_min', 'letter_b_min',
            'letter_c_plus_min', 'letter_c_min', 'letter_d_plus_min', 'letter_d_min'
        ];
        
        letterFieldNames.forEach(field => {
            const value = parseFloat($(`#id_${field}`).val()) || 0;
            letterMins[field] = value;
        });
        
        // Get passing mark
        const passingMark = parseFloat($('#id_passing_mark').val()) || 40;
        
        // Calculate GES grade
        let gesGrade = '9'; // Default fail
        const gradeOrder = [
            'grade_1_min', 'grade_2_min', 'grade_3_min', 'grade_4_min',
            'grade_5_min', 'grade_6_min', 'grade_7_min', 'grade_8_min'
        ];
        
        for (const gradeField of gradeOrder) {
            if (score >= gesMins[gradeField]) {
                // Extract grade number from field name (e.g., "grade_1_min" -> "1")
                gesGrade = gradeField.split('_')[1];
                break;
            }
        }
        
        // Calculate letter grade
        let letterGrade = 'F'; // Default fail
        const letterOrder = [
            'letter_a_plus_min', 'letter_a_min', 'letter_b_plus_min', 'letter_b_min',
            'letter_c_plus_min', 'letter_c_min', 'letter_d_plus_min', 'letter_d_min'
        ];
        
        const letterMapping = {
            'letter_a_plus_min': 'A+',
            'letter_a_min': 'A',
            'letter_b_plus_min': 'B+',
            'letter_b_min': 'B',
            'letter_c_plus_min': 'C+',
            'letter_c_min': 'C',
            'letter_d_plus_min': 'D+',
            'letter_d_min': 'D'
        };
        
        for (const letterField of letterOrder) {
            if (score >= letterMins[letterField]) {
                letterGrade = letterMapping[letterField];
                break;
            }
        }
        
        // Check passing status
        const isPassing = score >= passingMark;
        
        // Show result
        const resultHtml = `
            <div class="alert alert-info">
                <h6 class="alert-heading">Test Configuration Result</h6>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Test Score:</strong> ${score.toFixed(2)}%
                    </div>
                    <div class="col-md-6">
                        <strong>Passing Mark:</strong> ${passingMark}%
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <strong>GES Grade:</strong> 
                        <span class="badge bg-${gesGrade <= '2' ? 'success' : gesGrade <= '4' ? 'info' : gesGrade <= '6' ? 'warning' : 'danger'}">
                            ${gesGrade}
                        </span>
                    </div>
                    <div class="col-md-6">
                        <strong>Letter Grade:</strong> 
                        <span class="badge bg-${letterGrade >= 'A' ? 'success' : letterGrade >= 'B' ? 'info' : letterGrade >= 'C' ? 'warning' : 'danger'}">
                            ${letterGrade}
                        </span>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <strong>Status:</strong> 
                        <span class="badge bg-${isPassing ? 'success' : 'danger'}">
                            ${isPassing ? 'PASSING' : 'FAILING'}
                        </span>
                    </div>
                </div>
            </div>
        `;
        
        Swal.fire({
            title: 'Test Result',
            html: resultHtml,
            icon: 'info',
            confirmButtonText: 'OK',
            width: '600px'
        });
    }
    
    function resetToDefaults() {
        if (confirm('Reset all values to GES standard defaults?\n\nThis will set:\n• Classwork: 30%\n• Homework: 10%\n• Test: 10%\n• Exam: 50%\n• Passing mark: 40%\n\nAll grade boundaries will be set to standard values.')) {
            // Reset weights
            $('#id_classwork_weight').val('30.00');
            $('#id_homework_weight').val('10.00');
            $('#id_test_weight').val('10.00');
            $('#id_exam_weight').val('50.00');
            
            // Reset GES grade boundaries
            $('#id_grade_1_min').val('90.00');
            $('#id_grade_2_min').val('80.00');
            $('#id_grade_3_min').val('70.00');
            $('#id_grade_4_min').val('60.00');
            $('#id_grade_5_min').val('50.00');
            $('#id_grade_6_min').val('40.00');
            $('#id_grade_7_min').val('30.00');
            $('#id_grade_8_min').val('20.00');
            
            // Reset letter grade boundaries
            $('#id_letter_a_plus_min').val('95.00');
            $('#id_letter_a_min').val('90.00');
            $('#id_letter_b_plus_min').val('85.00');
            $('#id_letter_b_min').val('80.00');
            $('#id_letter_c_plus_min').val('75.00');
            $('#id_letter_c_min').val('70.00');
            $('#id_letter_d_plus_min').val('65.00');
            $('#id_letter_d_min').val('60.00');
            
            // Reset passing mark
            $('#id_passing_mark').val('40.00');
            
            // Recalculate total weight
            calculateTotalWeight();
            
            alert('Reset to GES standard defaults completed!');
        }
    }
    
    // Make calculateTotalWeight available globally
    window.calculateTotalWeight = function() {
        let total = 0;
        $('input[id$="_weight"]').each(function() {
            total += parseFloat($(this).val()) || 0;
        });
        $('#totalWeight').text(total.toFixed(2));
        
        if (Math.abs(total - 100) < 0.01) {
            $('#weightTotal').removeClass('alert-danger').addClass('alert-success');
        } else {
            $('#weightTotal').removeClass('alert-success').addClass('alert-danger');
        }
    };
</script>
{% endblock %}