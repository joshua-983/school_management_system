{% extends "base.html" %}
{% load static crispy_forms_tags %}

{% block title %}Create Academic Year{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Create Academic Year Card -->
            <div class="card shadow">
                <div class="card-header bg-white py-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h2 mb-1">
                                <i class="fas fa-calendar-plus text-primary me-2"></i>
                                Create Academic Year
                            </h1>
                            <p class="text-muted mb-0">Set up a complete academic year with all terms</p>
                        </div>
                        <a href="{% url 'academic_dashboard' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Dashboard
                        </a>
                    </div>
                </div>
                
                <div class="card-body p-4">
                    <!-- Form Steps -->
                    <div class="mb-5">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="text-center">
                                    <div class="mb-2">
                                        <span class="badge bg-primary rounded-circle p-3">1</span>
                                    </div>
                                    <h6 class="mb-0">Year Details</h6>
                                    <small class="text-muted">Basic information</small>
                                </div>
                            </div>
                            <div class="col">
                                <div class="text-center">
                                    <div class="mb-2">
                                        <span class="badge bg-secondary rounded-circle p-3">2</span>
                                    </div>
                                    <h6 class="mb-0">System Selection</h6>
                                    <small class="text-muted">Term/Semester system</small>
                                </div>
                            </div>
                            <div class="col">
                                <div class="text-center">
                                    <div class="mb-2">
                                        <span class="badge bg-secondary rounded-circle p-3">3</span>
                                    </div>
                                    <h6 class="mb-0">Term Dates</h6>
                                    <small class="text-muted">Schedule configuration</small>
                                </div>
                            </div>
                            <div class="col">
                                <div class="text-center">
                                    <div class="mb-2">
                                        <span class="badge bg-secondary rounded-circle p-3">4</span>
                                    </div>
                                    <h6 class="mb-0">Review & Create</h6>
                                    <small class="text-muted">Final confirmation</small>
                                </div>
                            </div>
                        </div>
                        <div class="progress mt-3" style="height: 4px;">
                            <div class="progress-bar bg-primary" style="width: 25%"></div>
                        </div>
                    </div>
                    
                    <!-- Main Form -->
                    <form method="post" id="academicYearForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <!-- Academic Year -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 border">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-calendar-alt me-2"></i>
                                            Academic Year
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Academic Year *</label>
                                            {{ form.academic_year }}
                                            {% if form.academic_year.errors %}
                                            <div class="text-danger small mt-1">
                                                {{ form.academic_year.errors }}
                                            </div>
                                            {% endif %}
                                            <small class="text-muted">
                                                Format: YYYY/YYYY (e.g., 2024/2025)
                                            </small>
                                        </div>
                                        
                                        <!-- Year Preview -->
                                        <div class="card bg-primary bg-opacity-10 border-primary mt-3">
                                            <div class="card-body py-2">
                                                <div class="row text-center">
                                                    <div class="col">
                                                        <small class="text-muted">Start Date</small>
                                                        <div class="fw-bold" id="yearStartPreview">September 1</div>
                                                    </div>
                                                    <div class="col">
                                                        <small class="text-muted">End Date</small>
                                                        <div class="fw-bold" id="yearEndPreview">August 31</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Period System -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 border">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-cogs me-2"></i>
                                            Period System
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Academic Period System *</label>
                                            {{ form.period_system }}
                                            {% if form.period_system.errors %}
                                            <div class="text-danger small mt-1">
                                                {{ form.period_system.errors }}
                                            </div>
                                            {% endif %}
                                            <small class="text-muted">Select the academic period structure</small>
                                        </div>
                                        
                                        <!-- System Info -->
                                        <div id="systemInfo" class="mt-3">
                                            {% for system_code, system_name in period_systems %}
                                            <div class="system-desc" id="desc-{{ system_code }}" 
                                                 style="display: none;">
                                                <div class="alert alert-info small mb-0">
                                                    <strong>{{ system_name }} System:</strong>
                                                    <ul class="mb-0 mt-1">
                                                        {% if system_code == 'TERM' %}
                                                        <li>3 terms per academic year</li>
                                                        <li>Common in Ghana Education System</li>
                                                        <li>Terms: Sep-Dec, Jan-Apr, Apr-Jul</li>
                                                        {% elif system_code == 'SEMESTER' %}
                                                        <li>2 semesters per academic year</li>
                                                        <li>Common in higher education</li>
                                                        <li>Semesters: Sep-Jan, Feb-Jun</li>
                                                        {% elif system_code == 'QUARTER' %}
                                                        <li>4 quarters per academic year</li>
                                                        <li>Common in some international schools</li>
                                                        <li>Approximately 9-10 weeks each</li>
                                                        {% elif system_code == 'TRIMESTER' %}
                                                        <li>3 trimesters per academic year</li>
                                                        <li>Similar to term system</li>
                                                        <li>Balanced workload distribution</li>
                                                        {% else %}
                                                        <li>Custom period structure</li>
                                                        <li>Flexible configuration</li>
                                                        <li>Define your own periods</li>
                                                        {% endif %}
                                                    </ul>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Term Generation Options -->
                        <div class="card border mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-calendar-check me-2"></i>
                                    Term Generation Options
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            {{ form.auto_generate_dates }}
                                            <label class="form-check-label fw-bold" 
                                                   for="{{ form.auto_generate_dates.id_for_label }}">
                                                Auto-generate Term Dates
                                            </label>
                                            <small class="text-muted d-block">
                                                Use Ghana Education System calendar defaults
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            {{ form.set_first_term_active }}
                                            <label class="form-check-label fw-bold" 
                                                   for="{{ form.set_first_term_active.id_for_label }}">
                                                Set First Term as Active
                                            </label>
                                            <small class="text-muted d-block">
                                                Automatically activate the first term
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Term Preview -->
                                <div class="mt-3" id="termPreview">
                                    <h6 class="mb-3">Term Preview</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Term</th>
                                                    <th>Name</th>
                                                    <th>Start Date</th>
                                                    <th>End Date</th>
                                                    <th>Duration</th>
                                                </tr>
                                            </thead>
                                            <tbody id="previewTableBody">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted py-3">
                                                        Select academic year and system to see preview
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'academic_dashboard' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i> Cancel
                            </a>
                            <div>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-calendar-plus me-2"></i> Create Academic Year
                                </button>
                                <small class="text-muted d-block mt-1">
                                    This will create the academic year with all configured terms
                                </small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Existing Academic Years -->
            <div class="card shadow mt-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Existing Academic Years
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for year in existing_years|slice:":6" %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0">{{ year.name }}</h5>
                                        {% if year.is_active %}
                                        <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </div>
                                    <p class="card-text small text-muted">
                                        {{ year.start_date|date:"M d, Y" }} - {{ year.end_date|date:"M d, Y" }}
                                    </p>
                                    <div class="progress mb-2" style="height: 4px;">
                                        <div class="progress-bar bg-success" 
                                             style="width: {{ year.get_progress_percentage }}%">
                                        </div>
                                    </div>
                                    <div class="small text-muted">
                                        {{ year.terms.count }} terms â€¢ 
                                        {{ year.get_progress_percentage|floatformat:0 }}% complete
                                    </div>
                                    <a href="{% url 'academic_term_list' %}?academic_year={{ year.name }}" 
                                       class="btn btn-sm btn-outline-primary mt-2">
                                        View Terms
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-calendar-alt fa-3x mb-3"></i>
                                <h5>No academic years yet</h5>
                                <p>Create your first academic year to get started</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.system-desc {
    animation: fadeIn 0.3s;
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
.progress {
    background-color: #e9ecef;
}
.form-switch .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const yearInput = document.getElementById('{{ form.academic_year.id_for_label }}');
    const periodSystem = document.getElementById('{{ form.period_system.id_for_label }}');
    const autoGenerate = document.getElementById('{{ form.auto_generate_dates.id_for_label }}');
    const previewTable = document.getElementById('previewTableBody');
    const yearStartPreview = document.getElementById('yearStartPreview');
    const yearEndPreview = document.getElementById('yearEndPreview');
    
    // Ghana Education System term dates
    const ghanaTermDates = {
        'TERM': [
            {number: 1, name: 'First Term', startMonth: 9, startDay: 2, endMonth: 12, endDay: 18},
            {number: 2, name: 'Second Term', startMonth: 1, startDay: 8, endMonth: 4, endDay: 1},
            {number: 3, name: 'Third Term', startMonth: 4, startDay: 21, endMonth: 7, endDay: 23},
        ],
        'SEMESTER': [
            {number: 1, name: 'First Semester', startMonth: 9, startDay: 2, endMonth: 1, endDay: 15},
            {number: 2, name: 'Second Semester', startMonth: 1, startDay: 22, endMonth: 6, endDay: 15},
        ],
        'QUARTER': [
            {number: 1, name: 'First Quarter', startMonth: 9, startDay: 2, endMonth: 11, endDay: 15},
            {number: 2, name: 'Second Quarter', startMonth: 11, startDay: 18, endMonth: 2, endDay: 1},
            {number: 3, name: 'Third Quarter', startMonth: 2, startDay: 4, endMonth: 4, endDay: 15},
            {number: 4, name: 'Fourth Quarter', startMonth: 4, startDay: 22, endMonth: 6, endDay: 30},
        ],
        'TRIMESTER': [
            {number: 1, name: 'First Trimester', startMonth: 9, startDay: 2, endMonth: 12, endDay: 6},
            {number: 2, name: 'Second Trimester', startMonth: 1, startDay: 6, endMonth: 4, endDay: 11},
            {number: 3, name: 'Third Trimester', startMonth: 4, startDay: 22, endMonth: 7, endDay: 25},
        ]
    };
    
    // Show system description
    function showSystemDescription() {
        // Hide all descriptions first
        document.querySelectorAll('.system-desc').forEach(desc => {
            desc.style.display = 'none';
        });
        
        // Show selected system description
        const selectedSystem = periodSystem.value;
        const descElement = document.getElementById('desc-' + selectedSystem);
        if (descElement) {
            descElement.style.display = 'block';
        }
    }
    
    // Update year preview
    function updateYearPreview() {
        const yearValue = yearInput.value;
        if (yearValue && yearValue.match(/^\d{4}\/\d{4}$/)) {
            const [year1, year2] = yearValue.split('/');
            yearStartPreview.textContent = `September 1, ${year1}`;
            yearEndPreview.textContent = `August 31, ${year2}`;
        } else {
            yearStartPreview.textContent = 'September 1';
            yearEndPreview.textContent = 'August 31';
        }
    }
    
    // Generate term preview
    function generateTermPreview() {
        const yearValue = yearInput.value;
        const system = periodSystem.value;
        
        if (!yearValue || !system || !yearValue.match(/^\d{4}\/\d{4}$/)) {
            previewTable.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted py-3">
                        Select academic year and system to see preview
                    </td>
                </tr>
            `;
            return;
        }
        
        const [year1, year2] = yearValue.split('/');
        const terms = ghanaTermDates[system] || ghanaTermDates['TERM'];
        
        let html = '';
        terms.forEach(term => {
            // Adjust year for start date
            const startYear = term.startMonth < 9 ? parseInt(year2) : parseInt(year1);
            const endYear = term.endMonth < 9 ? parseInt(year2) : parseInt(year1);
            
            // Create dates
            const startDate = new Date(startYear, term.startMonth - 1, term.startDay);
            const endDate = new Date(endYear, term.endMonth - 1, term.endDay);
            
            // Calculate duration
            const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            
            html += `
                <tr>
                    <td>${term.number}</td>
                    <td>${term.name}</td>
                    <td>${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                    <td>${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                    <td>${duration} days</td>
                </tr>
            `;
        });
        
        previewTable.innerHTML = html;
    }
    
    // Validate academic year format
    function validateAcademicYear() {
        const yearRegex = /^\d{4}\/\d{4}$/;
        if (!yearRegex.test(yearInput.value)) {
            alert('Academic year must be in format YYYY/YYYY (e.g., 2024/2025)');
            yearInput.focus();
            return false;
        }
        
        const [year1, year2] = yearInput.value.split('/');
        if (parseInt(year2) !== parseInt(year1) + 1) {
            alert('The second year must be exactly one year after the first (e.g., 2024/2025)');
            yearInput.focus();
            return false;
        }
        
        return true;
    }
    
    // Form validation
    document.getElementById('academicYearForm').addEventListener('submit', function(e) {
        if (!validateAcademicYear()) {
            e.preventDefault();
            return false;
        }
        
        // Check if academic year already exists
        // This would require an AJAX call in a real implementation
        // For now, just proceed
        
        if (confirm('Create academic year with all configured terms?')) {
            return true;
        }
        
        e.preventDefault();
        return false;
    });
    
    // Event listeners
    yearInput.addEventListener('input', function() {
        updateYearPreview();
        if (autoGenerate.checked) {
            generateTermPreview();
        }
    });
    
    periodSystem.addEventListener('change', function() {
        showSystemDescription();
        if (autoGenerate.checked) {
            generateTermPreview();
        }
    });
    
    autoGenerate.addEventListener('change', function() {
        if (this.checked) {
            generateTermPreview();
        } else {
            previewTable.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted py-3">
                        Manual date entry will be available after form submission
                    </td>
                </tr>
            `;
        }
    });
    
    // Initialize
    showSystemDescription();
    updateYearPreview();
    if (autoGenerate.checked) {
        generateTermPreview();
    }
});
</script>
{% endblock %}