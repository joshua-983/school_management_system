{% extends 'base.html' %}

{% block title %}Record Attendance - Ghana Education System{% endblock %}

{% block extra_css %}
<style>
    .attendance-form-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e3e6f0;
    }
    
    .student-card {
        transition: all 0.2s ease;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid transparent;
        border: 1px solid #e3e6f0;
    }
    
    .student-card-present {
        border-left-color: #28a745;
        background-color: #f8fff9;
    }
    
    .student-card-absent {
        border-left-color: #dc3545;
        background-color: #fff8f8;
    }
    
    .student-card-late {
        border-left-color: #ffc107;
        background-color: #fffef0;
    }
    
    .student-card-excused {
        border-left-color: #17a2b8;
        background-color: #f0fdff;
    }
    
    .student-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .status-btn.active {
        font-weight: bold;
        transform: scale(1.05);
    }
    
    .attendance-summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .ges-compliance-badge {
        font-size: 0.7rem;
    }
    
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    
    .ghana-flag {
        background: linear-gradient(135deg, #CE1126 0%, #FCD116 50%, #006B3F 100%);
        color: white;
        border-radius: 5px;
        padding: 2px 8px;
        font-size: 0.8rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <!-- Ghana Education System Header -->
            <div class="card mb-4">
                <div class="card-body bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-1">
                                <i class="bi bi-clipboard-check me-2"></i>
                                Record Attendance - Ghana Education Service
                            </h4>
                            <p class="mb-0">Daily attendance recording for academic monitoring and GES compliance</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="ghana-flag">GHA</span>
                            {% if is_school_day %}
                            <span class="badge bg-success ms-2">School Day</span>
                            {% else %}
                            <span class="badge bg-warning ms-2">Non-School Day</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card attendance-form-card">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">Record Attendance</h4>
                            <div class="text-muted small">
                                <i class="bi bi-calendar me-1"></i>{{ selected_date|date:"l, F j, Y" }}
                                <i class="bi bi-people ms-3 me-1"></i>{{ selected_class_name }}
                                {% if selected_term %}
                                <i class="bi bi-journal ms-3 me-1"></i>{{ selected_term }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-end">
                            {% if term_progress %}
                            <div class="text-muted small">Term Progress: {{ term_progress }}%</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Attendance Summary -->
                    {% if students %}
                    <div class="attendance-summary mb-4">
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body py-2">
                                        <h5 class="mb-0">{{ present_count }}</h5>
                                        <small>Present</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body py-2">
                                        <h5 class="mb-0">{{ absent_count }}</h5>
                                        <small>Absent</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body py-2">
                                        <h5 class="mb-0">{{ late_count }}</h5>
                                        <small>Late</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body py-2">
                                        <h5 class="mb-0">{{ excused_count }}</h5>
                                        <small>Excused</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Messages and Errors -->
                    {% if messages %}
                    <div class="alert-container mb-3">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                            <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill{% else %}bi-exclamation-triangle-fill{% endif %} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if date_error or class_error %}
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        {{ date_error|default:class_error }}
                    </div>
                    {% endif %}

                    <!-- Ghana Education System Info -->
                    {% if not is_school_day %}
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> {{ selected_date|date:"l, F j, Y" }} is not a regular school day in the Ghana academic calendar.
                    </div>
                    {% endif %}
                    
                    <!-- Attendance Form -->
                    {% if students %}
                    <form method="post" id="attendanceForm" novalidate>
                        {% csrf_token %}
                        
                        <!-- Hidden fields for all parameters -->
                        <input type="hidden" name="term" value="{{ selected_term.id }}">
                        <input type="hidden" name="date" value="{{ selected_date|date:'Y-m-d' }}">
                        <input type="hidden" name="class_level" value="{{ selected_class }}">
                        {% if selected_period %}
                        <input type="hidden" name="period" value="{{ selected_period.id }}">
                        {% endif %}
                        
                        <!-- Quick Actions -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="fw-bold">Quick Actions:</span>
                                            <div>
                                                <button type="button" class="btn btn-sm btn-outline-success me-2" id="markAllPresent">
                                                    <i class="bi bi-check-all me-1"></i> Mark All Present
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" id="markAllAbsent">
                                                    <i class="bi bi-x-circle me-1"></i> Mark All Absent
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Students List -->
                        <div class="row">
                            {% for student in students %}
                            <div class="col-md-6 col-lg-4">
                                <div class="card student-card {% if student.previous_status %}student-card-{{ student.previous_status }}{% endif %} mb-3">
                                    <div class="card-body">
                                        <!-- Student Info -->
                                        <div class="d-flex align-items-center mb-3">
                                            {% if student.profile_picture %}
                                            <img src="{{ student.profile_picture.url }}" 
                                                 class="student-avatar me-3" alt="{{ student.get_full_name }}">
                                            {% else %}
                                            <div class="student-avatar bg-secondary d-flex align-items-center justify-content-center me-3">
                                                <i class="bi bi-person-fill text-white fs-4"></i>
                                            </div>
                                            {% endif %}
                                            <div class="flex-grow-1">
                                                <h6 class="mb-0">{{ student.get_full_name }}</h6>
                                                <small class="text-muted">{{ student.student_id }}</small>
                                                
                                                <!-- GES Compliance Info -->
                                                <div class="mt-1">
                                                    {% if student.absence_count > 0 %}
                                                    <span class="badge bg-danger ges-compliance-badge">
                                                        Absences: {{ student.absence_count }}
                                                    </span>
                                                    {% endif %}
                                                    
                                                    {% if student.ges_attendance_rate %}
                                                    <span class="badge {% if student.ges_attendance_rate >= 80 %}bg-success{% elif student.ges_attendance_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %} ges-compliance-badge">
                                                        GES: {{ student.ges_attendance_rate }}%
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Attendance Actions -->
                                        <div class="d-flex justify-content-between align-items-center student-actions">
                                            <div class="btn-group btn-group-sm" role="group">
                                                {% for status in status_choices %}
                                                <input type="radio" class="btn-check" 
                                                       name="status_{{ student.id }}" 
                                                       id="{{ status.0 }}_{{ student.id }}" 
                                                       value="{{ status.0 }}" 
                                                       autocomplete="off"
                                                       {% if student.previous_status == status.0 %}checked{% endif %}
                                                       required>
                                                <label class="btn btn-outline-{% if status.0 == 'present' %}success{% elif status.0 == 'absent' %}danger{% elif status.0 == 'late' %}warning{% else %}info{% endif %} status-btn status-btn-{{ status.0 }}" 
                                                       for="{{ status.0 }}_{{ student.id }}">
                                                       <i class="bi bi-{% if status.0 == 'present' %}check-circle{% elif status.0 == 'absent' %}x-circle{% elif status.0 == 'late' %}clock{% else %}clipboard-check{% endif %} me-1"></i>
                                                       {{ status.1 }}
                                                </label>
                                                {% endfor %}
                                            </div>
                                            
                                            <input type="text" class="form-control form-control-sm ms-2" 
                                                   name="notes_{{ student.id }}" 
                                                   placeholder="Notes" 
                                                   style="max-width: 120px;"
                                                   value="{{ student.previous_notes|default:'' }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'attendance_dashboard' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
                            </a>
                            <div>
                                <button type="reset" class="btn btn-outline-warning me-2">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Reset
                                </button>
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <i class="bi bi-save me-1"></i> Save Attendance
                                </button>
                            </div>
                        </div>
                    </form>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-people fs-1 text-muted"></i>
                        <h4 class="mt-3">No Students Found</h4>
                        <p class="text-muted">
                            {% if date_error or class_error %}
                            Please fix the errors above to view students.
                            {% else %}
                            No active students found for {{ selected_class_name }}.
                            {% endif %}
                        </p>
                        <a href="{% url 'attendance_dashboard' %}" class="btn btn-primary">
                            <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay">
    <div class="text-center text-white">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="mt-3">Saving Attendance...</h4>
        <p>Recording data for Ghana Education Service</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize UI elements
    function initializeUI() {
        // Set up radio button change handlers
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
            // Set initial state
            if (radio.checked) {
                updateCardStyle(radio);
                updateButtonStyle(radio);
            }
            
            // Add change handler
            radio.addEventListener('change', function() {
                updateCardStyle(this);
                updateButtonStyle(this);
                updateSummaryCounts();
            });
        });
        
        // Mark all present button
        document.getElementById('markAllPresent').addEventListener('click', function() {
            document.querySelectorAll('input[type="radio"][value="present"]').forEach(radio => {
                radio.checked = true;
                updateCardStyle(radio);
                updateButtonStyle(radio);
            });
            updateSummaryCounts();
        });
        
        // Mark all absent button
        document.getElementById('markAllAbsent').addEventListener('click', function() {
            document.querySelectorAll('input[type="radio"][value="absent"]').forEach(radio => {
                radio.checked = true;
                updateCardStyle(radio);
                updateButtonStyle(radio);
            });
            updateSummaryCounts();
        });
        
        // Initialize summary counts
        updateSummaryCounts();
    }
    
    // Update card styling based on status
    function updateCardStyle(radio) {
        const card = radio.closest('.student-card');
        if (card) {
            // Remove all status classes
            card.classList.remove(
                'student-card-present', 
                'student-card-absent',
                'student-card-late', 
                'student-card-excused'
            );
            
            // Add current status class
            if (radio.checked) {
                card.classList.add(`student-card-${radio.value}`);
            }
        }
    }
    
    // Update button styling based on status
    function updateButtonStyle(radio) {
        const label = document.querySelector(`label[for="${radio.id}"]`);
        if (label) {
            // Remove active class from all buttons in group
            radio.closest('.btn-group').querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to selected button
            if (radio.checked) {
                label.classList.add('active');
            }
        }
    }
    
    // Update summary counts in real-time
    function updateSummaryCounts() {
        const counts = {
            present: 0,
            absent: 0,
            late: 0,
            excused: 0
        };
        
        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
            if (counts.hasOwnProperty(radio.value)) {
                counts[radio.value]++;
            }
        });
        
        // Update the summary cards if they exist
        const summaryCards = document.querySelectorAll('.attendance-summary .card h5');
        if (summaryCards.length === 4) {
            summaryCards[0].textContent = counts.present;
            summaryCards[1].textContent = counts.absent;
            summaryCards[2].textContent = counts.late;
            summaryCards[3].textContent = counts.excused;
        }
    }
    
    // Form submission handling
    const form = document.getElementById('attendanceForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = document.getElementById('submitBtn');
            const loadingOverlay = document.querySelector('.loading-overlay');
            
            // Show loading state
            loadingOverlay.style.display = 'flex';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            
            // Validate at least one status is selected
            const hasStatusSelected = Array.from(document.querySelectorAll('input[type="radio"]')).some(r => r.checked);
            if (!hasStatusSelected) {
                e.preventDefault();
                showFormError("Please select attendance status for at least one student.");
                resetFormState();
                return false;
            }
            
            // Allow form to submit normally
            return true;
        });
    }
    
    // Show form error message
    function showFormError(message) {
        const alertContainer = document.querySelector('.alert-container') || document.createElement('div');
        if (!document.querySelector('.alert-container')) {
            alertContainer.className = 'alert-container mb-3';
            const cardBody = document.querySelector('.card-body');
            cardBody.insertBefore(alertContainer, cardBody.firstChild);
        }
        
        const errorAlert = document.createElement('div');
        errorAlert.className = 'alert alert-danger alert-dismissible fade show';
        errorAlert.innerHTML = `
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(errorAlert);
        errorAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Reset form state after error
    function resetFormState() {
        const loadingOverlay = document.querySelector('.loading-overlay');
        const submitBtn = document.getElementById('submitBtn');
        
        loadingOverlay.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-save me-1"></i> Save Attendance';
    }
    
    // Initialize the UI
    initializeUI();
});
</script>
{% endblock %}