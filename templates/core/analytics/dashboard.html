{% extends "base.html" %}
{% load static %}

{% block title %}Analytics Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    .analytics-card {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transition: all 0.3s ease;
        height: 100%;
        border: none;
    }
    
    .analytics-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1rem 1.25rem;
    }
    
    .stat-card {
        border-left: 4px solid;
        border-radius: 0.25rem;
        padding: 1rem;
        background-color: white;
        margin-bottom: 1rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05);
    }
    
    .stat-card.present { border-left-color: #28a745; }
    .stat-card.absent { border-left-color: #dc3545; }
    .stat-card.late { border-left-color: #ffc107; }
    .stat-card.excused { border-left-color: #17a2b8; }
    
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    .nav-pills .nav-link.active {
        background-color: #3a7bd5;
        font-weight: 500;
    }
    
    .nav-pills .nav-link {
        color: #495057;
        font-weight: 500;
        padding: 0.5rem 1rem;
    }
    
    .summary-card {
        border-radius: 0.5rem;
        color: white;
        height: 100%;
    }
    
    .summary-card .card-body {
        padding: 1.5rem;
    }
    
    .summary-card .icon {
        font-size: 2.5rem;
        opacity: 0.3;
        position: absolute;
        right: 1.5rem;
        top: 1.5rem;
    }
    
    .summary-card .card-title {
        font-size: 1rem;
        margin-bottom: 0.5rem;
        opacity: 0.9;
    }
    
    .summary-card .display-4 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    
    .summary-card .card-link {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    
    .summary-card .card-link:hover {
        color: white;
        text-decoration: underline;
    }
    
    /* Custom scrollbar for tab content */
    .tab-content {
        max-height: calc(100vh - 300px);
        overflow-y: auto;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .summary-card .display-4 {
            font-size: 2rem;
        }
        
        .chart-container {
            height: 250px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Analytics Dashboard</h1>
            <p class="mb-0 text-muted">Comprehensive overview of school performance metrics</p>
        </div>
        <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="dateRangeDropdown" data-bs-toggle="dropdown">
                <i class="bi bi-calendar-range me-2"></i>
                {{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }}
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">Quick Range</h6></li>
                <li><a class="dropdown-item" href="?range=today"><i class="bi bi-calendar-day me-2"></i>Today</a></li>
                <li><a class="dropdown-item" href="?range=week"><i class="bi bi-calendar-week me-2"></i>This Week</a></li>
                <li><a class="dropdown-item" href="?range=month"><i class="bi bi-calendar-month me-2"></i>This Month</a></li>
                <li><a class="dropdown-item" href="?range=year"><i class="bi bi-calendar me-2"></i>This Year</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#customRangeModal">
                    <i class="bi bi-calendar-plus me-2"></i>Custom Range
                </a></li>
            </ul>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4 g-4">
        <!-- Attendance Summary -->
        <div class="col-md-4">
            <div class="summary-card bg-primary">
                <div class="card-body position-relative">
                    <i class="bi bi-calendar-check icon"></i>
                    <h5 class="card-title">Attendance Overview</h5>
                    <p class="display-4">{{ attendance_stats.stats.present|default:"0" }}</p>
                    <p class="mb-1">Present students this period</p>
                    <a href="{% url 'attendance_dashboard' %}" class="card-link">
                        View Attendance Details <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Grades Summary -->
        <div class="col-md-4">
            <div class="summary-card bg-success">
                <div class="card-body position-relative">
                    <i class="bi bi-journal-check icon"></i>
                    <h5 class="card-title">Academic Performance</h5>
                    <p class="display-4">{{ grade_stats.overall.avg_score|default:"0"|floatformat:1 }}</p>
                    <p class="mb-1">Average score across classes</p>
                    <a href="{% url 'grade_list' %}" class="card-link">
                        View Grade Details <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="col-md-4">
            <div class="summary-card bg-info">
                <div class="card-body position-relative">
                    <i class="bi bi-cash-stack icon"></i>
                    <h5 class="card-title">Financial Summary</h5>
                    <p class="display-4">{{ fee_stats.collection_rate|default:"0" }}%</p>
                    <p class="mb-1">Fee collection rate</p>
                    <a href="{% url 'fee_report' %}" class="card-link">
                        View Financial Details <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics Tabs -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-bottom-0">
            <ul class="nav nav-pills card-header-pills" id="analyticsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="attendance-tab" data-bs-toggle="pill" data-bs-target="#attendance" type="button">
                        <i class="bi bi-calendar-check me-1"></i> Attendance
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="grades-tab" data-bs-toggle="pill" data-bs-target="#grades" type="button">
                        <i class="bi bi-journal-check me-1"></i> Grades
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="finance-tab" data-bs-toggle="pill" data-bs-target="#finance" type="button">
                        <i class="bi bi-cash-stack me-1"></i> Finance
                    </button>
                </li>
                <li class="nav-item ms-auto">
                    <button class="btn btn-sm btn-outline-secondary" id="exportBtn">
                        <i class="bi bi-download me-1"></i> Export Report
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="card-body p-0">
            <div class="tab-content p-3" id="analyticsTabsContent">
                <!-- Attendance Tab Content -->
                <div class="tab-pane fade show active" id="attendance" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card analytics-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Attendance Trend</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="attendanceTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card analytics-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Attendance Stats</h5>
                                </div>
                                <div class="card-body">
                                    <div class="stat-card present">
                                        <h6>Present</h6>
                                        <h3>{{ attendance_stats.stats.present|default:"0" }}</h3>
                                        <small>{{ attendance_stats.attendance_rate|default:"0" }}% attendance rate</small>
                                    </div>
                                    <div class="stat-card absent">
                                        <h6>Absent</h6>
                                        <h3>{{ attendance_stats.stats.absent|default:"0" }}</h3>
                                    </div>
                                    <div class="stat-card late">
                                        <h6>Late</h6>
                                        <h3>{{ attendance_stats.stats.late|default:"0" }}</h3>
                                    </div>
                                    {% if attendance_stats.stats.excused %}
                                    <div class="stat-card excused">
                                        <h6>Excused</h6>
                                        <h3>{{ attendance_stats.stats.excused|default:"0" }}</h3>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card analytics-card">
                                <div class="card-header">
                                    <h5 class="mb-0">Attendance by Class</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="attendanceClassChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grades Tab Content -->
                <div class="tab-pane fade" id="grades" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card analytics-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Performance by Class</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="gradeClassChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card analytics-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Performance by Subject</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="gradeSubjectChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card analytics-card">
                                <div class="card-header">
                                    <h5 class="mb-0">Grade Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="stat-card">
                                                <h6>Average Score</h6>
                                                <h3>{{ grade_stats.overall.avg_score|default:"0"|floatformat:1 }}</h3>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="stat-card">
                                                <h6>Highest Score</h6>
                                                <h3>{{ grade_stats.overall.max_score|default:"0"|floatformat:1 }}</h3>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="stat-card">
                                                <h6>Lowest Score</h6>
                                                <h3>{{ grade_stats.overall.min_score|default:"0"|floatformat:1 }}</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance Tab Content -->
                <div class="tab-pane fade" id="finance" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card analytics-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Payment Status</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="financeStatusChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card analytics-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Fee Categories</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="financeCategoryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card analytics-card">
                                <div class="card-header">
                                    <h5 class="mb-0">Financial Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="stat-card">
                                                <h6>Total Payable</h6>
                                                <h3>₦{{ fee_stats.stats.total_payable|default:"0"|floatformat:2 }}</h3>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="stat-card">
                                                <h6>Total Paid</h6>
                                                <h3>₦{{ fee_stats.stats.total_paid|default:"0"|floatformat:2 }}</h3>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="stat-card">
                                                <h6>Collection Rate</h6>
                                                <h3>{{ fee_stats.collection_rate|default:"0" }}%</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Range Modal -->
<div class="modal fade" id="customRangeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Custom Date Range</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="get" action="">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate" name="start_date" required
                               value="{{ start_date|date:'Y-m-d' }}">
                    </div>
                    <div class="mb-3">
                        <label for="endDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate" name="end_date" required
                               value="{{ end_date|date:'Y-m-d' }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Apply Date Range</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="loadingToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                Loading analytics data...
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
<script>
    // Show loading indicator
    const loadingToast = new bootstrap.Toast(document.getElementById('loadingToast'));
    loadingToast.show();
    
    // Initialize all charts after page load
    document.addEventListener('DOMContentLoaded', function() {
        // Common chart options
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                },
                zoom: {
                    zoom: {
                        wheel: {
                            enabled: true,
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'xy',
                    },
                    pan: {
                        enabled: true,
                        mode: 'xy',
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'nearest',
            }
        };
        
        // Initialize all charts
        initializeAttendanceCharts();
        initializeGradeCharts();
        initializeFinanceCharts();
        
        // Hide loading indicator when all charts are loaded
        setTimeout(() => {
            loadingToast.hide();
        }, 1000);
        
        // Export button functionality
        document.getElementById('exportBtn').addEventListener('click', function() {
            // Implement export functionality
            alert('Export functionality will be implemented here');
        });
    });
    
    function initializeAttendanceCharts() {
        // Attendance Trend Chart
        const attendanceTrendCtx = document.getElementById('attendanceTrendChart').getContext('2d');
        new Chart(attendanceTrendCtx, {
            type: 'line',
            data: {
                labels: [{% for item in attendance_stats.trend_data %}"{{ item.date|date:'M d' }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [
                    {
                        label: 'Present',
                        data: [{% for item in attendance_stats.trend_data %}{{ item.present }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.3,
                        fill: true,
                        borderWidth: 2
                    },
                    {
                        label: 'Absent',
                        data: [{% for item in attendance_stats.trend_data %}{{ item.absent }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.3,
                        fill: true,
                        borderWidth: 2
                    },
                    {
                        label: 'Late',
                        data: [{% for item in attendance_stats.trend_data %}{{ item.late }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.3,
                        fill: true,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Attendance Class Chart
        const attendanceClassCtx = document.getElementById('attendanceClassChart').getContext('2d');
        new Chart(attendanceClassCtx, {
            type: 'bar',
            data: {
                labels: [{% for item in attendance_stats.class_breakdown %}"Class {{ item.student__class_level }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [
                    {
                        label: 'Present %',
                        data: [{% for item in attendance_stats.class_breakdown %}{{ item.present_pct }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: '#28a745',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                ...commonOptions,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Present: ${context.raw}%`;
                            }
                        }
                    },
                    datalabels: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }
    
    function initializeGradeCharts() {
        // Grade Class Chart
        const gradeClassCtx = document.getElementById('gradeClassChart').getContext('2d');
        new Chart(gradeClassCtx, {
            type: 'bar',
            data: {
                labels: [{% for item in grade_stats.grade_distribution %}"Class {{ item.student__class_level }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [
                    {
                        label: 'Average Score',
                        data: [{% for item in grade_stats.grade_distribution %}{{ item.avg_score|floatformat:1 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: 'rgba(23, 162, 184, 0.7)',
                        borderColor: '#17a2b8',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                ...commonOptions,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Avg: ${context.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value;
                            }
                        }
                    }
                }
            }
        });

        // Grade Subject Chart
        const gradeSubjectCtx = document.getElementById('gradeSubjectChart').getContext('2d');
        new Chart(gradeSubjectCtx, {
            type: 'bar',
            data: {
                labels: [{% for item in grade_stats.subject_performance %}"{{ item.subject__name }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [
                    {
                        label: 'Average Score',
                        data: [{% for item in grade_stats.subject_performance %}{{ item.avg_score|floatformat:1 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: 'rgba(108, 117, 125, 0.7)',
                        borderColor: '#6c757d',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                ...commonOptions,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Avg: ${context.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value;
                            }
                        }
                    }
                }
            }
        });
    }
    
    function initializeFinanceCharts() {
        // Finance Status Chart
        const financeStatusCtx = document.getElementById('financeStatusChart').getContext('2d');
        new Chart(financeStatusCtx, {
            type: 'doughnut',
            data: {
                labels: [{% for item in fee_stats.status_distribution %}"{{ item.payment_status }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [
                    {
                        data: [{% for item in fee_stats.status_distribution %}{{ item.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(255, 193, 7, 0.7)'
                        ],
                        borderWidth: 1
                    }
                ]
            },
            options: {
                ...commonOptions,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    },
                    datalabels: {
                        formatter: (value, ctx) => {
                            const datasets = ctx.chart.data.datasets;
                            if (datasets.indexOf(ctx.dataset) === datasets.length - 1) {
                                const sum = datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / sum) * 100) + '%';
                                return percentage;
                            }
                            return '';
                        },
                        color: '#fff',
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

        // Finance Category Chart
        const financeCategoryCtx = document.getElementById('financeCategoryChart').getContext('2d');
        new Chart(financeCategoryCtx, {
            type: 'pie',
            data: {
                labels: [{% for item in fee_stats.category_breakdown %}"{{ item.category__name }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [
                    {
                        data: [{% for item in fee_stats.category_breakdown %}{{ item.total_payable }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: [
                            'rgba(0, 123, 255, 0.7)',
                            'rgba(23, 162, 184, 0.7)',
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(108, 117, 125, 0.7)'
                        ],
                        borderWidth: 1
                    }
                ]
            },
            options: {
                ...commonOptions,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ₦${value.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    },
                    datalabels: {
                        formatter: (value, ctx) => {
                            const datasets = ctx.chart.data.datasets;
                            if (datasets.indexOf(ctx.dataset) === datasets.length - 1) {
                                const sum = datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / sum) * 100) + '%';
                                return percentage;
                            }
                            return '';
                        },
                        color: '#fff',
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }
</script>
{% endblock %}