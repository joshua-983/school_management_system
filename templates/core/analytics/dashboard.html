{% extends "base.html" %}
{% load static %}

{% block title %}Analytics Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.css">
<style>
    :root {
        --primary: #3a7bd5;
        --secondary: #6c757d;
        --success: #28a745;
        --info: #17a2b8;
        --warning: #ffc107;
        --danger: #dc3545;
        --light: #f8f9fa;
        --dark: #343a40;
        --sidebar-width: 250px;
        --header-height: 70px;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s ease;
    }

    .dashboard-container {
        background-color: #f5f7fb;
        min-height: 100vh;
        padding: 20px;
    }
    
    .page-header {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: var(--card-shadow);
        border-left: 4px solid var(--primary);
    }
    
    .summary-card {
        border-radius: 12px;
        overflow: hidden;
        transition: var(--transition);
        height: 100%;
        border: none;
        box-shadow: var(--card-shadow);
    }
    
    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .summary-card .card-body {
        padding: 1.5rem;
        position: relative;
    }
    
    .summary-card .icon-container {
        position: absolute;
        right: 20px;
        top: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.2;
    }
    
    .summary-card .icon {
        font-size: 1.8rem;
    }
    
    .summary-card .card-title {
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .summary-card .value {
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: white;
    }
    
    .summary-card .trend {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .analytics-card {
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        height: 100%;
        border: none;
        background-color: white;
        margin-bottom: 24px;
    }
    
    .analytics-card:hover {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .analytics-card .card-header {
        background-color: white;
        border-bottom: 1px solid #edf2f9;
        padding: 1.25rem 1.5rem;
        border-top-left-radius: 12px !important;
        border-top-right-radius: 12px !important;
    }
    
    .analytics-card .card-header h5 {
        margin-bottom: 0;
        font-weight: 600;
        color: #344050;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        padding: 15px;
    }
    
    .chart-container-sm {
        height: 250px;
    }
    
    .nav-pills .nav-link {
        border-radius: 8px;
        padding: 0.6rem 1.2rem;
        font-weight: 500;
        color: #506690;
        margin-right: 0.5rem;
        transition: var(--transition);
    }
    
    .nav-pills .nav-link.active {
        background-color: var(--primary);
        color: white;
        box-shadow: 0 3px 10px rgba(58, 123, 213, 0.3);
    }
    
    .stat-card {
        border-radius: 10px;
        padding: 1.25rem;
        background-color: white;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border-left: 4px solid;
        transition: var(--transition);
    }
    
    .stat-card:hover {
        transform: translateX(5px);
    }
    
    .stat-card.present { border-left-color: var(--success); }
    .stat-card.absent { border-left-color: var(--danger); }
    .stat-card.late { border-left-color: var(--warning); }
    .stat-card.excused { border-left-color: var(--info); }
    
    .stat-card h6 {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    
    .stat-card h3 {
        font-weight: 700;
        color: #344050;
        margin-bottom: 0.25rem;
    }
    
    .stat-card small {
        color: #8a92a6;
    }
    
    .filter-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: var(--card-shadow);
    }
    
    .date-range-picker {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .date-range-picker .form-control {
        max-width: 150px;
    }
    
    .dropdown-menu {
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid #edf2f9;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        margin: 0 5px;
        width: auto;
    }
    
    .dropdown-item:hover {
        background-color: #f5f7fb;
    }
    
    .btn {
        border-radius: 8px;
        font-weight: 500;
        padding: 0.5rem 1rem;
    }
    
    .btn-primary {
        background-color: var(--primary);
        border-color: var(--primary);
        box-shadow: 0 3px 10px rgba(58, 123, 213, 0.3);
    }
    
    .btn-outline-primary {
        color: var(--primary);
        border-color: var(--primary);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary);
        border-color: var(--primary);
        box-shadow: 0 3px 10px rgba(58, 123, 213, 0.3);
    }
    
    .btn-group .btn {
        border-radius: 8px;
    }
    
    /* Loading spinner */
    .spinner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    /* Data table styles */
    .data-table-container {
        overflow-x: auto;
        border-radius: 12px;
    }
    
    /* Enhanced Analytics Styles */
    .insight-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .insight-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .insight-card.success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .kpi-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-weight: 600;
    }
    
    .performance-meter {
        height: 8px;
        border-radius: 4px;
        background: #e9ecef;
        overflow: hidden;
        margin: 0.5rem 0;
    }
    
    .performance-meter .fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    
    .metric-comparison {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 0.5rem 0;
    }
    
    .comparison-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
    }
    
    .alert-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .alert-indicator.critical { background-color: #dc3545; }
    .alert-indicator.warning { background-color: #ffc107; }
    .alert-indicator.info { background-color: #17a2b8; }
    
    /* Empty state styling */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    /* Chart improvements */
    .chart-legend {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        margin-right: 5px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 992px) {
        .date-range-picker {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .date-range-picker .form-control {
            max-width: 100%;
        }
        
        .chart-container {
            height: 250px;
        }
    }
    
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 15px;
        }
        
        .summary-card .value {
            font-size: 1.8rem;
        }
        
        .chart-container {
            height: 200px;
        }
        
        .nav-pills .nav-link {
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
        }
        
        .analytics-card .card-header {
            padding: 1rem;
        }
    }
    
    @media (max-width: 576px) {
        .page-header {
            padding: 15px;
        }
        
        .summary-card .card-body {
            padding: 1rem;
        }
        
        .chart-container {
            height: 180px;
            padding: 10px;
        }
    }
    
    /* Custom animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease forwards;
    }
    
    /* Print styles */
    @media print {
        .btn, .dropdown, .spinner-overlay {
            display: none !important;
        }
        
        .analytics-card {
            box-shadow: none;
            border: 1px solid #ddd;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid dashboard-container px-0">
    <!-- Loading overlay (initially hidden) -->
    <div id="loadingOverlay" class="spinner-overlay" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h1 class="h3 mb-1 text-gray-800">School Performance Dashboard</h1>
                <p class="mb-0 text-muted">Comprehensive analytics and insights for informed decision-making</p>
            </div>
            <div class="d-flex align-items-center mt-2 mt-md-0">
                <div class="dropdown me-2">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="dateRangeDropdown" data-bs-toggle="dropdown">
                        <i class="bi bi-calendar-range me-2"></i>
                        <span id="dateRangeDisplay">{{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }}</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><h6 class="dropdown-header">Quick Range</h6></li>
                        <li><a class="dropdown-item date-range-option" href="#" data-range="today"><i class="bi bi-calendar-day me-2"></i>Today</a></li>
                        <li><a class="dropdown-item date-range-option" href="#" data-range="week"><i class="bi bi-calendar-week me-2"></i>This Week</a></li>
                        <li><a class="dropdown-item date-range-option" href="#" data-range="month"><i class="bi bi-calendar-month me-2"></i>This Month</a></li>
                        <li><a class="dropdown-item date-range-option" href="#" data-range="year"><i class="bi bi-calendar me-2"></i>This Year</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="customRangeOption">
                            <i class="bi bi-calendar-plus me-2"></i>Custom Range
                        </a></li>
                    </ul>
                </div>
                <button class="btn btn-primary" id="refreshBtn">
                    <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Range Picker (hidden by default) -->
    <div id="customRangePicker" class="filter-section" style="display: none;">
        <h5 class="mb-3">Select Custom Date Range</h5>
        <div class="date-range-picker">
            <div class="d-flex align-items-center">
                <label class="me-2 mb-0">From:</label>
                <input type="text" class="form-control datepicker" id="startDatePicker" placeholder="Start Date" value="{{ start_date|date:'Y-m-d' }}">
            </div>
            <div class="d-flex align-items-center">
                <label class="me-2 mb-0">To:</label>
                <input type="text" class="form-control datepicker" id="endDatePicker" placeholder="End Date" value="{{ end_date|date:'Y-m-d' }}">
            </div>
            <div>
                <button class="btn btn-primary" id="applyDateRange">Apply</button>
                <button class="btn btn-outline-secondary" id="cancelDateRange">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Executive Summary & Key Insights -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="analytics-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Executive Summary & Key Insights</h5>
                    <span class="badge bg-primary">Live</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="insight-card">
                                <h6><i class="bi bi-check-circle me-2"></i>Strong Performance</h6>
                                <p class="mb-0">Academic results show improvement compared to last term</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="insight-card warning">
                                <h6><i class="bi bi-exclamation-triangle me-2"></i>Attention Needed</h6>
                                <p class="mb-0">Monitor students at risk of falling below attendance requirements</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="insight-card success">
                                <h6><i class="bi bi-graph-up me-2"></i>Positive Trend</h6>
                                <p class="mb-0">Fee collection efficiency maintained this period</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4 g-4">
        <!-- Attendance Summary -->
        <div class="col-xl-3 col-md-6">
            <div class="summary-card bg-primary">
                <div class="card-body position-relative">
                    <div class="icon-container bg-white">
                        <i class="bi bi-calendar-check text-primary icon"></i>
                    </div>
                    <h5 class="card-title">Attendance Overview</h5>
                    <p class="value" id="attendanceValue">0</p>
                    <p class="mb-1">Present students this period</p>
                    <div class="trend">
                        <i class="bi bi-arrow-up-circle-fill me-1"></i>
                        <span id="attendanceRate">0%</span> attendance rate
                    </div>
                    <div class="performance-meter mt-2">
                        <div class="fill bg-success" id="attendanceMeter" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grades Summary -->
        <div class="col-xl-3 col-md-6">
            <div class="summary-card bg-success">
                <div class="card-body position-relative">
                    <div class="icon-container bg-white">
                        <i class="bi bi-journal-check text-success icon"></i>
                    </div>
                    <h5 class="card-title">Academic Performance</h5>
                    <p class="value" id="gradeValue">0.0</p>
                    <p class="mb-1">Average score across classes</p>
                    <div class="trend">
                        <i class="bi bi-arrow-up-circle-fill me-1"></i>
                        <span id="passRate">0%</span> pass rate
                    </div>
                    <div class="performance-meter mt-2">
                        <div class="fill bg-info" id="gradeMeter" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Summary -->
        <div class="col-xl-3 col-md-6">
            <div class="summary-card bg-info">
                <div class="card-body position-relative">
                    <div class="icon-container bg-white">
                        <i class="bi bi-cash-stack text-info icon"></i>
                    </div>
                    <h5 class="card-title">Financial Summary</h5>
                    <p class="value" id="financeValue">0%</p>
                    <p class="mb-1">Fee collection rate</p>
                    <div class="trend">
                        <i class="bi bi-arrow-up-circle-fill me-1"></i>
                        <span id="amountCollected">GH₵0</span> collected
                    </div>
                    <div class="performance-meter mt-2">
                        <div class="fill bg-warning" id="financeMeter" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GES Compliance -->
        <div class="col-xl-3 col-md-6">
            <div class="summary-card bg-warning">
                <div class="card-body position-relative">
                    <div class="icon-container bg-white">
                        <i class="bi bi-award text-warning icon"></i>
                    </div>
                    <h5 class="card-title">GES Compliance</h5>
                    <p class="value" id="complianceValue">0%</p>
                    <p class="mb-1">Students meeting requirements</p>
                    <div class="trend">
                        <i class="bi bi-arrow-up-circle-fill me-1"></i>
                        <span id="compliantStudents">0</span> compliant
                    </div>
                    <div class="performance-meter mt-2">
                        <div class="fill bg-primary" id="complianceMeter" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Metrics Comparison -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="analytics-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Performance Metrics Comparison</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="metric-comparison">
                                <div>
                                    <strong>Attendance Rate</strong>
                                    <div class="text-muted">vs. GES Standard (80%)</div>
                                </div>
                                <span class="comparison-badge" id="attendanceComparison">
                                    0%
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-comparison">
                                <div>
                                    <strong>Academic Performance</strong>
                                    <div class="text-muted">vs. School Target (70%)</div>
                                </div>
                                <span class="comparison-badge" id="academicComparison">
                                    0%
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-comparison">
                                <div>
                                    <strong>Financial Health</strong>
                                    <div class="text-muted">Collection Efficiency</div>
                                </div>
                                <span class="comparison-badge" id="financialComparison">
                                    0%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analytics Tabs -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-bottom-0 py-3">
            <ul class="nav nav-pills card-header-pills" id="analyticsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="attendance-tab" data-bs-toggle="pill" data-bs-target="#attendance" type="button">
                        <i class="bi bi-calendar-check me-1"></i> Attendance
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="grades-tab" data-bs-toggle="pill" data-bs-target="#grades" type="button">
                        <i class="bi bi-journal-check me-1"></i> Academic
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="finance-tab" data-bs-toggle="pill" data-bs-target="#finance" type="button">
                        <i class="bi bi-cash-stack me-1"></i> Finance
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="risk-tab" data-bs-toggle="pill" data-bs-target="#risk" type="button">
                        <i class="bi bi-exclamation-triangle me-1"></i> Risk Analysis
                    </button>
                </li>
                <li class="nav-item ms-auto d-flex align-items-center">
                    <div class="dropdown d-inline-block me-2">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-download me-1"></i> Export
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item export-option" href="#" data-format="pdf"><i class="bi bi-file-earmark-pdf me-2"></i>PDF Report</a></li>
                            <li><a class="dropdown-item export-option" href="#" data-format="excel"><i class="bi bi-file-earmark-excel me-2"></i>Excel Data</a></li>
                            <li><a class="dropdown-item export-option" href="#" data-format="csv"><i class="bi bi-file-earmark-text me-2"></i>CSV Data</a></li>
                        </ul>
                    </div>
                </li>
            </ul>
        </div>
        
        <div class="card-body p-0">
            <div class="tab-content p-4" id="analyticsTabsContent">
                <!-- Attendance Tab Content -->
                <div class="tab-pane fade show active" id="attendance" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="analytics-card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                    <h5 class="mb-0">Attendance Trend Analysis</h5>
                                    <div class="btn-group btn-group-sm mt-2 mt-md-0">
                                        <button class="btn btn-outline-secondary chart-reset" data-chart="attendanceTrendChart">
                                            <i class="bi bi-zoom-out"></i> Reset Zoom
                                        </button>
                                        <button class="btn btn-outline-secondary chart-export" data-chart="attendanceTrendChart">
                                            <i class="bi bi-download"></i> Export
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="attendanceTrendChart"></canvas>
                                    </div>
                                    <div class="chart-legend">
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #28a745;"></div>
                                            <span>Attendance Rate</span>
                                        </div>
                                        <div class="legend-item">
                                            <div class="legend-color" style="background-color: #dc3545;"></div>
                                            <span>GES Target (80%)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="analytics-card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Attendance Performance</h5>
                                </div>
                                <div class="card-body">
                                    <div class="stat-card present">
                                        <h6>Present Students</h6>
                                        <h3 id="presentCount">0</h3>
                                        <small id="presentPercentage">0% of total attendance</small>
                                    </div>
                                    <div class="stat-card absent">
                                        <h6>Absent Students</h6>
                                        <h3 id="absentCount">0</h3>
                                        <small>Requires immediate attention</small>
                                    </div>
                                    <div class="stat-card late">
                                        <h6>Late Arrivals</h6>
                                        <h3 id="lateCount">0</h3>
                                        <small>Pattern analysis recommended</small>
                                    </div>
                                    <div class="alert alert-warning mt-3">
                                        <small><i class="bi bi-info-circle me-1"></i>
                                            <strong>Insight:</strong> <span id="nonCompliantCount">0</span> students below GES 80% requirement
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GES Compliance Section -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">GES Compliance Monitoring</h5>
                                    <span class="badge" id="complianceBadge">
                                        0% Compliant
                                    </span>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Compliance Overview</h6>
                                            <div class="progress mb-3" style="height: 25px;">
                                                <div class="progress-bar bg-success" id="complianceProgress" style="width: 0%">
                                                    0%
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between text-sm">
                                                <span>Compliant: <span id="compliantCount">0</span></span>
                                                <span>Non-compliant: <span id="nonCompliantTotal">0</span></span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Weekly Pattern</h6>
                                            <div class="chart-container chart-container-sm">
                                                <canvas id="weeklyPatternChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Academic Performance Tab -->
                <div class="tab-pane fade" id="grades" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="analytics-card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                    <h5 class="mb-0">Performance by Subject</h5>
                                    <div class="btn-group btn-group-sm mt-2 mt-md-0">
                                        <button class="btn btn-outline-secondary chart-reset" data-chart="subjectPerformanceChart">
                                            <i class="bi bi-zoom-out"></i> Reset Zoom
                                        </button>
                                        <button class="btn btn-outline-secondary chart-export" data-chart="subjectPerformanceChart">
                                            <i class="bi bi-download"></i> Export
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="subjectPerformanceChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="analytics-card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                    <h5 class="mb-0">Grade Distribution</h5>
                                    <div class="btn-group btn-group-sm mt-2 mt-md-0">
                                        <button class="btn btn-outline-secondary chart-reset" data-chart="gradeDistributionChart">
                                            <i class="bi bi-zoom-out"></i> Reset Zoom
                                        </button>
                                        <button class="btn btn-outline-secondary chart-export" data-chart="gradeDistributionChart">
                                            <i class="bi bi-download"></i> Export
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="gradeDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Insights -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="analytics-card">
                                <div class="card-header">
                                    <h5 class="mb-0">Academic Performance Insights</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="stat-card">
                                                <h6>Average Score</h6>
                                                <h3 id="avgScore">0.0</h3>
                                                <small>Across all subjects</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card">
                                                <h6>Pass Rate</h6>
                                                <h3 id="passRateDetail">0%</h3>
                                                <small>Students achieving 40%+</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card">
                                                <h6>Excellence Rate</h6>
                                                <h3 id="excellenceRate">0%</h3>
                                                <small>Students achieving 80%+</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card">
                                                <h6>Improvement Needed</h6>
                                                <h3 id="failRate">0%</h3>
                                                <small>Below passing grade</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Learning Gaps -->
                                    <div class="mt-4">
                                        <h6>Key Learning Gaps Identified</h6>
                                        <div id="learningGapsContainer">
                                            <div class="empty-state">
                                                <i class="bi bi-journal-x"></i>
                                                <p>No critical learning gaps identified</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance Tab Content -->
                <div class="tab-pane fade" id="finance" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="analytics-card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                    <h5 class="mb-0">Revenue Collection Status</h5>
                                    <div class="btn-group btn-group-sm mt-2 mt-md-0">
                                        <button class="btn btn-outline-secondary chart-reset" data-chart="revenueStatusChart">
                                            <i class="bi bi-zoom-out"></i> Reset Zoom
                                        </button>
                                        <button class="btn btn-outline-secondary chart-export" data-chart="revenueStatusChart">
                                            <i class="bi bi-download"></i> Export
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="revenueStatusChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="analytics-card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                    <h5 class="mb-0">Monthly Collection Trend</h5>
                                    <div class="btn-group btn-group-sm mt-2 mt-md-0">
                                        <button class="btn btn-outline-secondary chart-reset" data-chart="monthlyTrendChart">
                                            <i class="bi bi-zoom-out"></i> Reset Zoom
                                        </button>
                                        <button class="btn btn-outline-secondary chart-export" data-chart="monthlyTrendChart">
                                            <i class="bi bi-download"></i> Export
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="monthlyTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Financial Health Dashboard -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="analytics-card">
                                <div class="card-header">
                                    <h5 class="mb-0">Financial Health Dashboard</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="stat-card">
                                                <h6>Total Receivable</h6>
                                                <h3 id="totalReceivable">GH₵0</h3>
                                                <small>Amount expected</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card">
                                                <h6>Total Collected</h6>
                                                <h3 id="totalCollected">GH₵0</h3>
                                                <small>Amount received</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card">
                                                <h6>Collection Rate</h6>
                                                <h3 id="collectionRateDetail">0%</h3>
                                                <small>Efficiency metric</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card">
                                                <h6>Outstanding</h6>
                                                <h3 id="outstandingBalance">GH₵0</h3>
                                                <small>Pending collection</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Financial Health Indicators -->
                                    <div class="row mt-4">
                                        <div class="col-md-6">
                                            <h6>Payment Efficiency</h6>
                                            <div class="metric-comparison">
                                                <div>On-time Payment Rate</div>
                                                <span class="badge bg-success" id="onTimeRate">0%</span>
                                            </div>
                                            <div class="metric-comparison">
                                                <div>Collection Period</div>
                                                <span class="badge bg-info" id="collectionPeriod">0 days</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Financial Ratios</h6>
                                            <div class="metric-comparison">
                                                <div>Current Ratio</div>
                                                <span class="badge bg-success" id="currentRatio">0.00</span>
                                            </div>
                                            <div class="metric-comparison">
                                                <div>Operational Efficiency</div>
                                                <span class="badge bg-primary" id="operationalEfficiency">0/10</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Analysis Tab -->
                <div class="tab-pane fade" id="risk" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="analytics-card mb-4">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Students at Risk</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Student</th>
                                                    <th>Class</th>
                                                    <th>Risk Level</th>
                                                    <th>Attendance</th>
                                                    <th>Performance</th>
                                                </tr>
                                            </thead>
                                            <tbody id="riskStudentsTable">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">No at-risk students identified</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="analytics-card mb-4">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Risk Trends</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="riskTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Intervention Recommendations -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="analytics-card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Recommended Interventions</h5>
                                </div>
                                <div class="card-body">
                                    <div id="interventionsContainer">
                                        <div class="empty-state">
                                            <i class="bi bi-check-circle"></i>
                                            <p>No specific interventions recommended at this time</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js and plugins -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2/dist/chartjs-plugin-annotation.min.js"></script>

<!-- Export libraries -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    // Enhanced analytics dashboard with professional insights
    const charts = {};
    let currentDateRange = {
        start: '{{ start_date|date:"Y-m-d" }}',
        end: '{{ end_date|date:"Y-m-d" }}'
    };

    // Professional chart configurations
    const professionalChartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    usePointStyle: true,
                    padding: 20,
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleFont: { size: 14 },
                bodyFont: { size: 13 },
                padding: 12,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) label += ': ';
                        if (context.parsed.y !== null) {
                            label += context.parsed.y.toLocaleString();
                            if (context.dataset.label && context.dataset.label.includes('%')) {
                                label += '%';
                            }
                        }
                        return label;
                    }
                }
            }
        },
        interaction: {
            intersect: false,
            mode: 'nearest',
        },
        scales: {
            x: {
                grid: { 
                    display: false,
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: { 
                    maxRotation: 45,
                    font: { size: 11 }
                }
            },
            y: {
                grid: { 
                    color: 'rgba(0, 0, 0, 0.05)',
                    drawBorder: false
                },
                beginAtZero: true,
                ticks: {
                    font: { size: 11 }
                }
            }
        }
    };

    // Sample data for demonstration
    const sampleData = {
        attendance: {
            present: 85,
            absent: 8,
            late: 7,
            total: 100,
            rate: 85,
            trend: [82, 84, 83, 85, 87, 85, 86],
            weekly: [88, 85, 82, 90, 86, 0, 0], // Mon-Sun
            compliance: {
                rate: 78,
                compliant: 78,
                nonCompliant: 22
            }
        },
        grades: {
            average: 72.5,
            passRate: 85,
            excellenceRate: 25,
            failRate: 15,
            subjects: [
                { name: 'Mathematics', score: 78 },
                { name: 'Science', score: 82 },
                { name: 'English', score: 75 },
                { name: 'Social Studies', score: 70 },
                { name: 'ICT', score: 85 }
            ],
            distribution: [5, 15, 25, 30, 15, 8, 2] // Grade distribution
        },
        finance: {
            collectionRate: 88,
            totalPayable: 50000,
            totalPaid: 44000,
            outstanding: 6000,
            categories: [
                { name: 'Tuition', amount: 25000 },
                { name: 'Feeding', amount: 12000 },
                { name: 'Books', amount: 8000 },
                { name: 'Uniform', amount: 4000 },
                { name: 'Transport', amount: 1000 }
            ],
            monthlyTrend: [42000, 38000, 45000, 44000, 46000, 48000]
        },
        risk: {
            students: [
                { name: 'John Doe', class: 'P6', risk: 'HIGH', attendance: 65, performance: 45 },
                { name: 'Jane Smith', class: 'J2', risk: 'MEDIUM', attendance: 72, performance: 58 },
                { name: 'Mike Johnson', class: 'P5', risk: 'HIGH', attendance: 68, performance: 52 }
            ],
            trends: [12, 15, 18, 14, 16, 13, 15]
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        initializeDatePickers();
        initializeAllCharts();
        setupEventListeners();
        initializeAnimations();
        updateSummaryCards();
    });

    function initializeAllCharts() {
        initializeAttendanceCharts();
        initializeAcademicCharts();
        initializeFinanceCharts();
        initializeRiskCharts();
    }

    function updateSummaryCards() {
        // Update attendance card
        document.getElementById('attendanceValue').textContent = sampleData.attendance.present;
        document.getElementById('attendanceRate').textContent = sampleData.attendance.rate + '%';
        document.getElementById('attendanceMeter').style.width = sampleData.attendance.rate + '%';
        
        // Update grade card
        document.getElementById('gradeValue').textContent = sampleData.grades.average.toFixed(1);
        document.getElementById('passRate').textContent = sampleData.grades.passRate + '%';
        document.getElementById('gradeMeter').style.width = sampleData.grades.average + '%';
        
        // Update finance card
        document.getElementById('financeValue').textContent = sampleData.finance.collectionRate + '%';
        document.getElementById('amountCollected').textContent = 'GH₵' + sampleData.finance.totalPaid.toLocaleString();
        document.getElementById('financeMeter').style.width = sampleData.finance.collectionRate + '%';
        
        // Update compliance card
        document.getElementById('complianceValue').textContent = sampleData.attendance.compliance.rate + '%';
        document.getElementById('compliantStudents').textContent = sampleData.attendance.compliance.compliant;
        document.getElementById('complianceMeter').style.width = sampleData.attendance.compliance.rate + '%';
        
        // Update comparison badges
        updateComparisonBadges();
        
        // Update detailed statistics
        updateDetailedStatistics();
    }

    function updateComparisonBadges() {
        const attendanceBadge = document.getElementById('attendanceComparison');
        const academicBadge = document.getElementById('academicComparison');
        const financialBadge = document.getElementById('financialComparison');
        
        // Attendance comparison
        attendanceBadge.textContent = sampleData.attendance.rate + '%';
        attendanceBadge.className = sampleData.attendance.rate >= 80 ? 'comparison-badge bg-success' : 'comparison-badge bg-warning';
        
        // Academic comparison
        academicBadge.textContent = sampleData.grades.average.toFixed(1) + '%';
        academicBadge.className = sampleData.grades.average >= 70 ? 'comparison-badge bg-success' : 'comparison-badge bg-warning';
        
        // Financial comparison
        financialBadge.textContent = sampleData.finance.collectionRate + '%';
        financialBadge.className = sampleData.finance.collectionRate >= 85 ? 'comparison-badge bg-success' : 
                                  sampleData.finance.collectionRate >= 70 ? 'comparison-badge bg-warning' : 'comparison-badge bg-danger';
    }

    function updateDetailedStatistics() {
        // Attendance details
        document.getElementById('presentCount').textContent = sampleData.attendance.present;
        document.getElementById('absentCount').textContent = sampleData.attendance.absent;
        document.getElementById('lateCount').textContent = sampleData.attendance.late;
        document.getElementById('presentPercentage').textContent = sampleData.attendance.rate + '% of total attendance';
        document.getElementById('nonCompliantCount').textContent = sampleData.attendance.compliance.nonCompliant;
        
        // Compliance details
        document.getElementById('complianceBadge').textContent = sampleData.attendance.compliance.rate + '% Compliant';
        document.getElementById('complianceBadge').className = sampleData.attendance.compliance.rate >= 80 ? 'badge bg-success' : 'badge bg-warning';
        document.getElementById('complianceProgress').style.width = sampleData.attendance.compliance.rate + '%';
        document.getElementById('complianceProgress').textContent = sampleData.attendance.compliance.rate + '%';
        document.getElementById('compliantCount').textContent = sampleData.attendance.compliance.compliant;
        document.getElementById('nonCompliantTotal').textContent = sampleData.attendance.compliance.nonCompliant;
        
        // Grade details
        document.getElementById('avgScore').textContent = sampleData.grades.average.toFixed(1);
        document.getElementById('passRateDetail').textContent = sampleData.grades.passRate + '%';
        document.getElementById('excellenceRate').textContent = sampleData.grades.excellenceRate + '%';
        document.getElementById('failRate').textContent = sampleData.grades.failRate + '%';
        
        // Finance details
        document.getElementById('totalReceivable').textContent = 'GH₵' + sampleData.finance.totalPayable.toLocaleString();
        document.getElementById('totalCollected').textContent = 'GH₵' + sampleData.finance.totalPaid.toLocaleString();
        document.getElementById('collectionRateDetail').textContent = sampleData.finance.collectionRate + '%';
        document.getElementById('outstandingBalance').textContent = 'GH₵' + sampleData.finance.outstanding.toLocaleString();
        document.getElementById('onTimeRate').textContent = '92%';
        document.getElementById('collectionPeriod').textContent = '15 days';
        document.getElementById('currentRatio').textContent = '1.45';
        document.getElementById('operationalEfficiency').textContent = '8.2/10';
        
        // Risk students
        updateRiskStudentsTable();
    }

    function updateRiskStudentsTable() {
        const tableBody = document.getElementById('riskStudentsTable');
        tableBody.innerHTML = '';
        
        if (sampleData.risk.students.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No at-risk students identified</td></tr>';
            return;
        }
        
        sampleData.risk.students.forEach(student => {
            const row = document.createElement('tr');
            const riskClass = student.risk === 'HIGH' ? 'bg-danger' : student.risk === 'MEDIUM' ? 'bg-warning' : 'bg-info';
            
            row.innerHTML = `
                <td>${student.name}</td>
                <td>${student.class}</td>
                <td><span class="badge ${riskClass}">${student.risk}</span></td>
                <td>${student.attendance}%</td>
                <td>${student.performance}%</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function initializeAttendanceCharts() {
        // Attendance Trend Chart
        const attendanceTrendCtx = document.getElementById('attendanceTrendChart').getContext('2d');
        
        charts.attendanceTrendChart = new Chart(attendanceTrendCtx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [
                    {
                        label: 'Attendance Rate %',
                        data: sampleData.attendance.trend,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointBackgroundColor: '#28a745',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'GES Target',
                        data: Array(7).fill(80),
                        borderColor: '#dc3545',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                ...professionalChartOptions,
                plugins: {
                    ...professionalChartOptions.plugins,
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: 80,
                                yMax: 80,
                                borderColor: '#dc3545',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'GES Target (80%)',
                                    enabled: true,
                                    position: 'end'
                                }
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });

        // Weekly Pattern Chart
        const weeklyPatternCtx = document.getElementById('weeklyPatternChart').getContext('2d');
        charts.weeklyPatternChart = new Chart(weeklyPatternCtx, {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
                datasets: [{
                    label: 'Avg Attendance %',
                    data: sampleData.attendance.weekly.slice(0, 5),
                    backgroundColor: [
                        'rgba(58, 123, 213, 0.7)',
                        'rgba(40, 167, 69, 0.7)',
                        'rgba(255, 193, 7, 0.7)',
                        'rgba(23, 162, 184, 0.7)',
                        'rgba(108, 117, 125, 0.7)'
                    ],
                    borderColor: '#3a7bd5',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Attendance: ${context.raw}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { callback: value => value + '%' }
                    }
                }
            }
        });
    }

    function initializeAcademicCharts() {
        // Subject Performance Chart
        const subjectCtx = document.getElementById('subjectPerformanceChart').getContext('2d');
        
        charts.subjectPerformanceChart = new Chart(subjectCtx, {
            type: 'bar',
            data: {
                labels: sampleData.grades.subjects.map(s => s.name),
                datasets: [{
                    label: 'Average Score %',
                    data: sampleData.grades.subjects.map(s => s.score),
                    backgroundColor: 'rgba(23, 162, 184, 0.7)',
                    borderColor: '#17a2b8',
                    borderWidth: 1
                }]
            },
            options: {
                ...professionalChartOptions,
                plugins: {
                    ...professionalChartOptions.plugins,
                    title: {
                        display: true,
                        text: 'Subject Performance Ranking',
                        font: { size: 16, weight: 'bold' }
                    }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });

        // Grade Distribution Chart
        const distributionCtx = document.getElementById('gradeDistributionChart').getContext('2d');
        charts.gradeDistributionChart = new Chart(distributionCtx, {
            type: 'pie',
            data: {
                labels: ['A (90-100%)', 'B (80-89%)', 'C (70-79%)', 'D (60-69%)', 'E (50-59%)', 'F (40-49%)', 'U (<40%)'],
                datasets: [{
                    data: sampleData.grades.distribution,
                    backgroundColor: [
                        '#28a745', '#20c997', '#17a2b8', '#6f42c1', '#fd7e14', '#dc3545', '#6c757d'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }

    function initializeFinanceCharts() {
        // Revenue Status Chart
        const revenueCtx = document.getElementById('revenueStatusChart').getContext('2d');
        charts.revenueStatusChart = new Chart(revenueCtx, {
            type: 'doughnut',
            data: {
                labels: ['Collected', 'Outstanding'],
                datasets: [{
                    data: [sampleData.finance.totalPaid, sampleData.finance.outstanding],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `GH₵${context.raw.toLocaleString()}`;
                            }
                        }
                    }
                }
            }
        });

        // Monthly Trend Chart
        const monthlyCtx = document.getElementById('monthlyTrendChart').getContext('2d');
        charts.monthlyTrendChart = new Chart(monthlyCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Monthly Collection (GH₵)',
                    data: sampleData.finance.monthlyTrend,
                    borderColor: '#3a7bd5',
                    backgroundColor: 'rgba(58, 123, 213, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                }]
            },
            options: professionalChartOptions
        });
    }

    function initializeRiskCharts() {
        const riskCtx = document.getElementById('riskTrendChart').getContext('2d');
        charts.riskTrendChart = new Chart(riskCtx, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Week 7'],
                datasets: [
                    {
                        label: 'At-Risk Students',
                        data: sampleData.risk.trends,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: professionalChartOptions
        });
    }

    // Enhanced utility functions
    function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function initializeDatePickers() {
        flatpickr(".datepicker", {
            dateFormat: "Y-m-d",
            allowInput: true
        });
    }

    function setupEventListeners() {
        // Date range selection
        document.querySelectorAll('.date-range-option').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const range = this.getAttribute('data-range');
                updateDateRange(range);
            });
        });

        // Custom range picker
        document.getElementById('customRangeOption').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('customRangePicker').style.display = 'block';
        });

        // Apply custom date range
        document.getElementById('applyDateRange').addEventListener('click', function() {
            const startDate = document.getElementById('startDatePicker').value;
            const endDate = document.getElementById('endDatePicker').value;
            
            if (startDate && endDate) {
                updateDateRange('custom', startDate, endDate);
                document.getElementById('customRangePicker').style.display = 'none';
            } else {
                alert('Please select both start and end dates');
            }
        });

        // Cancel custom date range
        document.getElementById('cancelDateRange').addEventListener('click', function() {
            document.getElementById('customRangePicker').style.display = 'none';
        });

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', function() {
            refreshDashboard();
        });

        // Export functionality
        document.querySelectorAll('.export-option').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const format = this.getAttribute('data-format');
                exportDashboard(format);
            });
        });

        // Chart controls
        document.querySelectorAll('.chart-reset').forEach(button => {
            button.addEventListener('click', function() {
                const chartId = this.getAttribute('data-chart');
                if (charts[chartId]) {
                    charts[chartId].resetZoom();
                }
            });
        });

        document.querySelectorAll('.chart-export').forEach(button => {
            button.addEventListener('click', function() {
                const chartId = this.getAttribute('data-chart');
                if (charts[chartId]) {
                    exportChart(chartId);
                }
            });
        });

        // Tab change event to resize charts
        document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function() {
                Object.values(charts).forEach(chart => {
                    if (chart) chart.resize();
                });
            });
        });
    }

    function initializeAnimations() {
        setTimeout(() => {
            document.querySelectorAll('.summary-card, .analytics-card').forEach((card, index) => {
                card.classList.add('fade-in');
                card.style.animationDelay = `${index * 0.1}s`;
            });
        }, 100);
    }

    function updateDateRange(range, startDate = null, endDate = null) {
        showLoading();
        
        // Simulate API call delay
        setTimeout(() => {
            updateDateRangeDisplay(range, startDate, endDate);
            hideLoading();
            
            // Show success message
            showToast('Date range updated successfully', 'success');
        }, 1000);
    }

    function updateDateRangeDisplay(range, startDate = null, endDate = null) {
        const displayElement = document.getElementById('dateRangeDisplay');
        const ranges = {
            'today': 'Today',
            'week': 'This Week',
            'month': 'This Month',
            'year': 'This Year'
        };
        
        if (range in ranges) {
            displayElement.textContent = ranges[range];
        } else if (range === 'custom') {
            const start = new Date(startDate);
            const end = new Date(endDate);
            displayElement.textContent = `${start.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - ${end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
        }
    }

    function refreshDashboard() {
        showLoading();
        
        // Simulate API call delay
        setTimeout(() => {
            hideLoading();
            showToast('Dashboard refreshed successfully', 'success');
        }, 1500);
    }

    function exportDashboard(format) {
        showLoading();
        setTimeout(() => {
            hideLoading();
            showToast(`${format.toUpperCase()} export started`, 'info');
            
            // Simulate download
            setTimeout(() => {
                showToast(`${format.toUpperCase()} export completed`, 'success');
            }, 2000);
        }, 1000);
    }

    function exportChart(chartId) {
        const canvas = document.getElementById(chartId);
        const link = document.createElement('a');
        link.download = `${chartId}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast('Chart exported successfully', 'success');
    }

    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type} border-0 position-fixed`;
        toast.style.top = '20px';
        toast.style.right = '20px';
        toast.style.zIndex = '1060';
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', () => {
            document.body.removeChild(toast);
        });
    }

    // Handle window resize
    window.addEventListener('resize', function() {
        Object.values(charts).forEach(chart => {
            if (chart) chart.resize();
        });
    });
</script>
{% endblock %}